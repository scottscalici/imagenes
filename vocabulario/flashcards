<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Práctica de Vocabulario (Tipo y Comprueba)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto space-y-6">
    <header class="rounded-2xl overflow-hidden shadow">
      <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-6 px-6">
        <h1 class="text-2xl font-bold">Práctica de vocabulario</h1>
        <p class="text-white/80 text-sm">Selecciona lección(es), el modo y escribe tus respuestas.</p>
      </div>
    </header>

    <!-- Controls -->
    <section class="bg-white rounded-xl shadow p-5 space-y-4">
      <div class="grid md:grid-cols-2 gap-4">
        <div class="md:col-span-2">
          <label class="block font-semibold mb-1">URL del JSON (GitHub /blob/ OK):</label>
          <input id="jsonUrl" class="w-full border rounded px-3 py-2"
                 value="https://github.com/scottscalici/imagenes/blob/main/vocabulario/desc2lec1.json" />
          <p class="text-xs text-gray-500 mt-1">Se convierte automáticamente a <code>raw.githubusercontent.com</code>.</p>
        </div>

        <div>
          <label class="block font-semibold mb-1">Modo</label>
          <div class="flex items-center gap-4">
            <label class="flex items-center gap-2">
              <input type="radio" name="mode" value="en2es" checked>
              <span>English → Spanish</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="radio" name="mode" value="es2en">
              <span>Spanish → English</span>
            </label>
          </div>
          <p class="text-xs text-gray-500 mt-1">En ES→EN, el prompt es <em>palabra</em>. En EN→ES, el prompt es <em>definición</em>.</p>
        </div>

        <div>
          <label class="block font-semibold mb-1">Lección(es)</label>
          <div id="lessonFilters" class="flex flex-wrap gap-2 text-sm"></div>
          <p class="text-xs text-gray-500 mt-1">Solo se incluyen entradas con <code>"evaluacion": true</code>.</p>
        </div>
      </div>

      <div class="flex gap-3">
        <button id="loadBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded px-4 py-2">Cargar</button>
        <button id="startBtn" class="bg-purple-600 hover:bg-purple-700 text-white rounded px-4 py-2">Empezar práctica</button>
      </div>
    </section>

    <!-- Practice card -->
    <section id="practiceSection" class="hidden bg-white rounded-xl shadow p-6 space-y-4">
      <div class="flex justify-between items-center">
        <div class="text-sm text-gray-600">
          <span id="counter">0/0</span> · Aciertos: <span id="correctCount">0</span>
          · Racha: <span id="streak">0</span>
        </div>
        <div class="text-xs text-gray-500">Acentos cuentan · Mayúsculas no · Se ignoran artículos (“el/la/los/las”) y “to ” en inglés</div>
      </div>

      <div class="border rounded-xl p-4">
        <div class="text-gray-500 text-xs mb-1" id="promptLabel">Definición</div>
        <div id="prompt" class="text-xl font-semibold">—</div>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Tu respuesta</label>
        <input id="answerInput" class="w-full border rounded px-3 py-2" autocomplete="off" />
      </div>

      <div class="flex flex-wrap gap-2">
        <button id="checkBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white rounded px-4 py-2">Comprobar</button>
        <button id="rightBtn" class="bg-sky-600 hover:bg-sky-700 text-white rounded px-4 py-2">Yo tenía razón</button>
        <button id="hintBtn" class="bg-amber-500 hover:bg-amber-600 text-white rounded px-4 py-2">Pista (primera letra)</button>
        <button id="skipBtn" class="bg-gray-800 hover:bg-black text-white rounded px-4 py-2">Saltar</button>
        <span id="feedback" class="ml-2 text-sm"></span>
      </div>
    </section>
  </div>

  <script>
    // ---------- Helpers ----------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function toRaw(url) {
      try {
        const u = new URL(url.trim());
        if (u.hostname === 'raw.githubusercontent.com') return u.toString();
        if (u.hostname === 'github.com' && u.pathname.includes('/blob/')) {
          const parts = u.pathname.split('/').filter(Boolean); // [user, repo, 'blob', branch, ...path]
          const i = parts.indexOf('blob');
          const user = parts[0], repo = parts[1], branch = parts[i+1];
          const rest = parts.slice(i+2).join('/');
          return `https://raw.githubusercontent.com/${user}/${repo}/${branch}/${rest}`;
        }
        return u.toString();
      } catch { return url; }
    }

    // Strip parentheses and their content, punctuation, normalize spaces.
    function stripPunctAndParens(s) {
      return s
        .replace(/\([^)]*\)/g, ' ')
        .replace(/[.,;:!?¿¡"“”'’]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }

    // Lowercase (accent-sensitive): DO NOT remove diacritics.
    function lc(s){ return (s||'').toLocaleLowerCase(); }

    // Ignore leading Spanish articles
    function stripArticlesEs(s){
      return s.replace(/^\s*(el|la|los|las)\s+/i, '');
    }
    // Ignore leading "to " in English side
    function stripToEn(s){
      return s.replace(/^\s*to\s+/i, '');
    }

    // Expand gender/number + slash variants: "pobrecito/a" -> pobrecito, pobrecita
    // Works inside multiword phrases.
    function expandSlashVariants(term){
      // e.g., "el/la enfermero/a" -> handle per token
      const tokens = term.split(/\s+/);
      const choices = tokens.map(tok => {
        if (tok.includes('/')) {
          // keep punctuation removed already
          const parts = tok.split('/');
          // Rebuild root from the first part (e.g., "pobrecito")
          const first = parts[0];
          // For patterns like "enfermero/a" -> ["enfermero","enfermera"]
          if (parts.length === 2 && first && parts[1] && !first.includes(parts[1])) {
            const base = first;
            const endA = base.replace(/o\b/, 'a');
            return [base, endA];
          }
          // Generic fall-back: each part as its own option
          return parts;
        }
        return [tok];
      });

      // Cartesian product
      const build = (idx, acc, out) => {
        if (idx === choices.length) { out.push(acc.join(' ')); return; }
        for (const c of choices[idx]) build(idx+1, acc.concat(c), out);
      };
      const out = [];
      build(0, [], out);
      // Add plural variants of single-word adjectives like "roto/rota" -> rotos/rotas
      const plusPlurals = new Set(out);
      out.forEach(w => {
        const last = w.split(' ').pop();
        if (/a|o$/.test(last)) {
          plusPlurals.add(w + 's');
        }
      });
      return Array.from(plusPlurals);
    }

    // Build acceptable answers (array) from a canonical string on the target side
    function buildAcceptables(target, lang){ // lang: 'es' or 'en' (target language)
      const base = stripPunctAndParens(target);
      let core = lc(base);
      core = lang === 'es' ? stripArticlesEs(core) : stripToEn(core);

      // Split on "/" only after punctuation removal handled; expand gender variants.
      let variants = expandSlashVariants(core);

      // For Spanish, also accept with/without leading articles (already stripped),
      // so add forms with articles removed only (we already compare after stripping articles,
      // so this is mainly to include any tokens left)
      variants = variants.map(v => v.replace(/\s+/g,' ').trim());
      return Array.from(new Set(variants));
    }

    // Compare user input to acceptable list with the required rules
    function matches(userInput, acceptList, lang) {
      let ui = stripPunctAndParens(lc(userInput));
      ui = lang === 'es' ? stripArticlesEs(ui) : stripToEn(ui);
      ui = ui.replace(/\s+/g,' ').trim();
      return acceptList.some(acc => ui === acc);
    }

    // First letter (of target after normalization + articles removed)
    function firstLetter(target, lang){
      const acc = buildAcceptables(target, lang);
      const c = acc[0]?.trim();
      return c ? c[0] : '';
    }

    // ---------- App state ----------
    let allItems = [];     // full JSON (filtered to evaluacion:true)
    let pool = [];         // filtered by lesson + mode rules
    let index = -1;        // current index in pool
    let correct = 0;
    let streak = 0;
    let mode = 'en2es';    // en2es | es2en

    const els = {
      url: $('#jsonUrl'),
      filters: $('#lessonFilters'),
      loadBtn: $('#loadBtn'),
      startBtn: $('#startBtn'),
      practice: $('#practiceSection'),
      prompt: $('#prompt'),
      promptLabel: $('#promptLabel'),
      input: $('#answerInput'),
      counter: $('#counter'),
      correct: $('#correctCount'),
      streak: $('#streak'),
      feedback: $('#feedback'),
      check: $('#checkBtn'),
      right: $('#rightBtn'),
      hint: $('#hintBtn'),
      skip: $('#skipBtn'),
    };

    function uniqueLessons(data){
      // Take digits+dots prefix from leccion (e.g., "1.1*" -> "1.1")
      const set = new Set();
      data.forEach(d => {
        const m = String(d.leccion||'').match(/^(\d+(?:\.\d+)?)/);
        if (m) set.add(m[1]);
      });
      return Array.from(set).sort((a,b)=>a.localeCompare(b,undefined,{numeric:true}));
    }

    function renderLessonCheckboxes(data){
      const lessons = uniqueLessons(data);
      els.filters.innerHTML = '';
      if (!lessons.length){
        els.filters.innerHTML = '<span class="text-gray-500">No hay lecciones en este archivo.</span>';
        return;
      }
      lessons.forEach((L,i)=>{
        const id = 'L_'+L.replace('.','_');
        const wrapper = document.createElement('label');
        wrapper.className = 'inline-flex items-center gap-2 bg-gray-100 rounded px-2 py-1';
        wrapper.innerHTML = `<input type="checkbox" id="${id}" value="${L}" ${i===0?'checked':''}><span>${L}</span>`;
        els.filters.appendChild(wrapper);
      });
    }

    async function loadJson(){
      const url = toRaw(els.url.value);
      const res = await fetch(url);
      const data = await res.json();
      // Keep only evaluacion:true for practice set
      const evals = data.filter(x => x && x.evaluacion === true);
      allItems = evals;
      renderLessonCheckboxes(evals);
    }

    function currentMode(){
      const m = $$('input[name="mode"]:checked')[0]?.value || 'en2es';
      mode = m;
      els.promptLabel.textContent = (mode === 'en2es') ? 'Definición (EN)' : 'Palabra (ES)';
    }

    function pickLessons(){
      const picked = $$(`#lessonFilters input[type="checkbox"]:checked`).map(cb=>cb.value);
      if (!picked.length) return [];
      return allItems.filter(x=>{
        const m = String(x.leccion||'').match(/^(\d+(?:\.\d+)?)/);
        const head = m ? m[1] : '';
        return picked.includes(head);
      });
    }

    function shuffle(arr){
      for (let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr;
    }

    function buildPool(){
      const base = pickLessons();
      // Map into prompt/answer pairs depending on mode
      pool = base.map(item=>{
        return (mode === 'en2es')
          ? { prompt: item.definicion, answer: item.palabra, item, targetLang:'es' }
          : { prompt: item.palabra,    answer: item.definicion, item, targetLang:'en' };
      });
      shuffle(pool);
      index = -1;
      correct = 0;
      streak = 0;
      updateHud();
    }

    function updateHud(){
      els.counter.textContent = `${Math.max(0,index)}/${pool.length}`;
      els.correct.textContent = String(correct);
      els.streak.textContent = String(streak);
    }

    function nextCard(resetIfExhausted=true){
      if (!pool.length) return;
      index++;
      if (index >= pool.length){
        if (resetIfExhausted){
          shuffle(pool);
          index = 0;
        } else {
          index = pool.length-1;
        }
      }
      const cur = pool[index];
      els.prompt.textContent = cur.prompt;
      els.input.value = '';
      els.input.focus();
      els.feedback.textContent = '';
      els.feedback.className = 'ml-2 text-sm';
      updateHud();
    }

    function checkAnswer(manualCorrect=false){
      const cur = pool[index];
      if (!cur) return;
      const user = els.input.value;
      const accepts = buildAcceptables(cur.answer, cur.targetLang); // ES or EN per target
      const ok = manualCorrect ? true : matches(user, accepts, cur.targetLang);

      if (ok){
        correct += 1;
        streak += 1;
        els.feedback.textContent = '✔️ Correcto';
        els.feedback.className = 'ml-2 text-sm text-emerald-700';
        setTimeout(()=>nextCard(), 400);
      } else {
        streak = 0;
        els.feedback.innerHTML = `❌ <span class="text-gray-700">Correcto:</span> <span class="font-semibold">${cur.answer}</span>`;
        els.feedback.className = 'ml-2 text-sm text-rose-700';
      }
      updateHud();
    }

    function showHint(){
      const cur = pool[index];
      if (!cur) return;
      const fl = firstLetter(cur.answer, cur.targetLang);
      els.feedback.textContent = `Pista: empieza con “${fl}”`;
      els.feedback.className = 'ml-2 text-sm text-amber-700';
      els.input.focus();
    }

    // ---------- Events ----------
    els.loadBtn.addEventListener('click', loadJson);
    $$('input[name="mode"]').forEach(r =>
      r.addEventListener('change', ()=> {
        currentMode();
        if (pool.length) { buildPool(); nextCard(); }
      })
    );

    els.startBtn.addEventListener('click', ()=>{
      currentMode();
      buildPool();
      els.practice.classList.remove('hidden');
      nextCard();
    });

    els.check.addEventListener('click', ()=>checkAnswer(false));
    els.right.addEventListener('click', ()=>checkAnswer(true));
    els.hint.addEventListener('click', showHint);
    els.skip.addEventListener('click', ()=>{ streak = 0; nextCard(); });
    els.input.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter') checkAnswer(false);
    });

    // Auto-load on first paint
    loadJson();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Imagen aleatoria</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-100 text-slate-800 min-h-screen">
  <main class="max-w-xl mx-auto px-4 py-10">
    <section class="bg-white rounded-2xl shadow border border-slate-200 p-6 space-y-4">
      <h1 class="text-2xl font-bold text-indigo-700">ðŸŽ² Imagen aleatoria</h1>
      <p class="text-slate-600 text-sm">
        Elige un filtro (opcional) y haz clic para abrir una imagen al azar.
      </p>

      <!-- FILTERS -->
      <div class="space-y-2">
        <p class="text-xs font-semibold text-slate-700">Filtro por etiqueta:</p>
        <div id="tagWrap" class="flex flex-wrap gap-2"></div>
      </div>

      <button id="btn"
        class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-xl hover:opacity-90">
        Generar imagen
      </button>

      <p id="status" class="text-xs text-slate-500"></p>
    </section>
  </main>

  <script>
    const JSON_URL = "image.json"; // same folder
    const btn = document.getElementById("btn");
    const status = document.getElementById("status");
    const tagWrap = document.getElementById("tagWrap");

    let allItems = [];
    let selectedTag = "todas";

    function normalizeTag(t) {
      return String(t || "").trim().toLowerCase();
    }

    function buildTagButtons(items) {
      const tagSet = new Set();
      for (const it of items) {
        const tags = Array.isArray(it.tags) ? it.tags : [];
        for (const t of tags) tagSet.add(normalizeTag(t));
      }

      const tags = ["todas", ...Array.from(tagSet).filter(Boolean).sort()];
      tagWrap.innerHTML = "";

      for (const t of tags) {
        const b = document.createElement("button");
        b.type = "button";
        b.dataset.tag = t;
        b.textContent = t;

        b.className =
          "px-3 py-1.5 rounded-full text-xs font-semibold border " +
          (t === "todas"
            ? "bg-indigo-600 text-white border-indigo-600"
            : "bg-white text-slate-700 border-slate-200 hover:bg-slate-50");

        b.addEventListener("click", () => {
          selectedTag = t;
          // refresh styles
          for (const btn of tagWrap.querySelectorAll("button")) {
            const isOn = btn.dataset.tag === selectedTag;
            btn.className =
              "px-3 py-1.5 rounded-full text-xs font-semibold border " +
              (isOn
                ? "bg-indigo-600 text-white border-indigo-600"
                : "bg-white text-slate-700 border-slate-200 hover:bg-slate-50");
          }
        });

        tagWrap.appendChild(b);
      }
    }

    async function loadOnce() {
      status.textContent = "Cargando bancoâ€¦";
      const res = await fetch(JSON_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("No se pudo cargar el JSON.");

      const items = await res.json();
      if (!Array.isArray(items) || items.length === 0) {
        throw new Error("El JSON estÃ¡ vacÃ­o o no es una lista.");
      }

      // sanity check: must have id
      for (const it of items) {
        if (!it || typeof it.id === "undefined" || it.id === null) {
          throw new Error("Hay una entrada sin campo 'id'.");
        }
      }

      allItems = items;
      buildTagButtons(allItems);
      status.textContent = "Listo.";
    }

    function pickRandomFrom(list) {
      return list[Math.floor(Math.random() * list.length)];
    }

    async function pickRandom() {
      if (!allItems.length) await loadOnce();

      const pool = (selectedTag === "todas")
        ? allItems
        : allItems.filter(it => Array.isArray(it.tags) && it.tags.map(normalizeTag).includes(selectedTag));

      if (pool.length === 0) {
        throw new Error(`No hay imÃ¡genes con la etiqueta: ${selectedTag}`);
      }

      const choice = pickRandomFrom(pool);
      window.location.href = `imagen.html?id=${encodeURIComponent(choice.id)}`;
    }

    // Preload tags on page load (so filter UI appears immediately)
    loadOnce().catch(err => { status.textContent = "Error: " + err.message; });

    btn.addEventListener("click", () => pickRandom().catch(err => {
      status.textContent = "Error: " + err.message;
    }));
  </script>
</body>
</html>

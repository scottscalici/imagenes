<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calentamiento ‚Äì Pr√°ctica</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    /* Animation for the success checkmark */
    @keyframes popIn {
      0% { transform: scale(0); opacity: 0; }
      80% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); }
    }
    .animate-pop { animation: popIn 0.5s ease-out forwards; }
  </style>
</head>
<body class="bg-slate-100 min-h-screen pb-20">

  <header class="sticky top-0 z-20 bg-white shadow-sm border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <div>
        <h1 id="pageTitle" class="text-lg sm:text-xl font-bold text-slate-800 tracking-tight">
          Calentamiento
        </h1>
        <p id="pageSubtitle" class="text-xs sm:text-sm text-slate-500 font-medium">
          Cargando configuraci√≥n...
        </p>
      </div>
      <div class="w-32 sm:w-64">
        <div class="w-full bg-slate-200 rounded-full h-2.5 overflow-hidden">
          <div id="progress-fill" class="h-full bg-emerald-500 transition-all duration-500 ease-out" style="width: 0%;"></div>
        </div>
        <p id="progress-label" class="text-[10px] sm:text-xs text-slate-600 mt-1.5 text-right font-semibold">
          0%
        </p>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <div id="topStatus" class="hidden mb-6 rounded-xl border border-slate-200 bg-white p-4 text-sm shadow-sm"></div>

    <div class="grid lg:grid-cols-[260px,1fr] gap-8">
      
      <aside class="space-y-4">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 space-y-2">
          <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 px-2">
            Verbos
          </h2>
          
          <button class="module-tab w-full text-left px-3 py-2.5 rounded-lg flex items-center justify-between gap-2 bg-sky-50 text-sky-800 border border-sky-200 text-sm font-medium transition-colors" data-module="1">
            <span>1.1 ¬∑ Pr√°ctica</span>
            <span id="badge-1" class="text-xs">‚óè</span>
          </button>
          <button class="module-tab w-full text-left px-3 py-2.5 rounded-lg flex items-center justify-between gap-2 bg-slate-50 text-slate-500 border border-slate-200 text-sm font-medium transition-colors" data-module="2" disabled>
            <span>1.2 ¬∑ Pr√°ctica</span>
            <span id="badge-2" class="text-xs">üîí</span>
          </button>
          <button class="module-tab w-full text-left px-3 py-2.5 rounded-lg flex items-center justify-between gap-2 bg-slate-50 text-slate-500 border border-slate-200 text-sm font-medium transition-colors" data-module="3" disabled>
            <span>1.3 ¬∑ Pr√°ctica</span>
            <span id="badge-3" class="text-xs">üîí</span>
          </button>
          <button class="module-tab w-full text-left px-3 py-2.5 rounded-lg flex items-center justify-between gap-2 bg-slate-50 text-slate-500 border border-slate-200 text-sm font-medium transition-colors" data-module="4" disabled>
            <span>1.4 ¬∑ Pr√°ctica</span>
            <span id="badge-4" class="text-xs">üîí</span>
          </button>

          <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-6 mb-3 px-2">
            Vocabulario
          </h2>
          <button class="module-tab w-full text-left px-3 py-2.5 rounded-lg flex items-center justify-between gap-2 bg-slate-50 text-slate-500 border border-slate-200 text-sm font-medium transition-colors" data-module="5" disabled>
            <span>2.0 ¬∑ Vocabulario</span>
            <span id="badge-5" class="text-xs">üîí</span>
          </button>
          
          <div class="pt-4 mt-4 border-t border-slate-100">
             <button class="module-tab w-full text-left px-3 py-2.5 rounded-lg flex items-center justify-between gap-2 bg-slate-50 text-slate-500 border border-slate-200 text-sm font-bold transition-colors" data-module="6" disabled>
              <span>üèÅ Finalizar</span>
              <span id="badge-6" class="text-xs">üîí</span>
            </button>
          </div>
        </div>
        
        <div id="projector-btn-area"></div>
      </aside>

      <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 sm:p-8 min-h-[400px]">
        
        <div id="module-1" class="module-view space-y-6">
          <div class="border-b border-slate-100 pb-4">
            <h2 class="text-2xl font-bold text-slate-800 tracking-tight">M√≥dulo 1.1</h2>
            <p class="text-slate-500 mt-1">Conjuga los verbos correctamente.</p>
          </div>
          <div id="module-1-questions" class="space-y-6"></div> <div class="flex flex-wrap items-center gap-4 pt-4">
            <button id="btn-check-module-1" class="px-6 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-bold shadow-sm transition-all active:scale-95">Corregir</button>
            <p id="module-1-result" class="text-sm font-medium text-slate-600"></p>
          </div>
          <div class="flex justify-end pt-6 border-t border-slate-50 mt-6">
            <button id="btn-next-from-1" class="px-5 py-2 rounded-lg bg-slate-100 text-slate-400 font-bold cursor-not-allowed" disabled>Siguiente ‚Üí</button>
          </div>
        </div>

        <div id="module-2" class="module-view space-y-6 hidden">
          <div class="border-b border-slate-100 pb-4">
            <h2 class="text-2xl font-bold text-slate-800 tracking-tight">M√≥dulo 1.2</h2>
             <p class="text-slate-500 mt-1">Sigue practicando.</p>
          </div>
          <div id="module-2-questions" class="space-y-6"></div>
          <div class="flex flex-wrap items-center gap-4 pt-4">
            <button id="btn-check-module-2" class="px-6 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-bold shadow-sm transition-all active:scale-95">Corregir</button>
            <p id="module-2-result" class="text-sm font-medium text-slate-600"></p>
          </div>
          <div class="flex justify-between pt-6 border-t border-slate-50 mt-6">
             <button class="text-slate-400 hover:text-slate-600 font-bold text-sm" data-go-module="1">‚Üê Volver</button>
            <button id="btn-next-from-2" class="px-5 py-2 rounded-lg bg-slate-100 text-slate-400 font-bold cursor-not-allowed" disabled>Siguiente ‚Üí</button>
          </div>
        </div>

        <div id="module-3" class="module-view space-y-6 hidden">
          <div class="border-b border-slate-100 pb-4">
            <h2 class="text-2xl font-bold text-slate-800 tracking-tight">M√≥dulo 1.3</h2>
            <p class="text-slate-500 mt-1">Tercera ronda.</p>
          </div>
          <div id="module-3-questions" class="space-y-6"></div>
          <div class="flex flex-wrap items-center gap-4 pt-4">
            <button id="btn-check-module-3" class="px-6 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-bold shadow-sm transition-all active:scale-95">Corregir</button>
            <p id="module-3-result" class="text-sm font-medium text-slate-600"></p>
          </div>
          <div class="flex justify-between pt-6 border-t border-slate-50 mt-6">
            <button class="text-slate-400 hover:text-slate-600 font-bold text-sm" data-go-module="2">‚Üê Volver</button>
            <button id="btn-next-from-3" class="px-5 py-2 rounded-lg bg-slate-100 text-slate-400 font-bold cursor-not-allowed" disabled>Siguiente ‚Üí</button>
          </div>
        </div>

        <div id="module-4" class="module-view space-y-6 hidden">
          <div class="border-b border-slate-100 pb-4">
            <h2 class="text-2xl font-bold text-slate-800 tracking-tight">M√≥dulo 1.4</h2>
            <p class="text-slate-500 mt-1">√öltima ronda de verbos.</p>
          </div>
          <div id="module-4-questions" class="space-y-6"></div>
          <div class="flex flex-wrap items-center gap-4 pt-4">
            <button id="btn-check-module-4" class="px-6 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-bold shadow-sm transition-all active:scale-95">Corregir</button>
            <p id="module-4-result" class="text-sm font-medium text-slate-600"></p>
          </div>
          <div class="flex justify-between pt-6 border-t border-slate-50 mt-6">
            <button class="text-slate-400 hover:text-slate-600 font-bold text-sm" data-go-module="3">‚Üê Volver</button>
            <button id="btn-next-from-4" class="px-5 py-2 rounded-lg bg-slate-100 text-slate-400 font-bold cursor-not-allowed" disabled>Ir a Vocabulario ‚Üí</button>
          </div>
        </div>

        <div id="module-5" class="module-view space-y-6 hidden">
          <div class="border-b border-slate-100 pb-4">
            <h2 class="text-2xl font-bold text-slate-800 tracking-tight">Vocabulario</h2>
            <p class="text-slate-500 mt-1">Traduce al ingl√©s. (3 bloques de 10 palabras)</p>
          </div>
          
          <div id="vocab-block-container" class="space-y-6 mt-4"></div>
          <div class="bg-slate-50 rounded-lg p-3 border border-slate-200">
             <p id="vocab-global-status" class="text-xs font-mono text-slate-500 text-center">Esperando inicio...</p>
          </div>

          <div class="flex flex-wrap items-center justify-between gap-4 pt-6 border-t border-slate-50 mt-6">
             <button id="btn-reset-vocab" class="px-4 py-2 rounded-lg bg-white border border-slate-200 text-slate-600 text-xs font-bold uppercase tracking-wide hover:bg-slate-50">Reiniciar</button>
            <button id="btn-next-from-5" class="px-5 py-2 rounded-lg bg-slate-100 text-slate-400 font-bold cursor-not-allowed" disabled>Finalizar ‚Üí</button>
          </div>
        </div>

        <div id="module-6" class="module-view space-y-8 hidden text-center py-10">
          
          <div id="curiosidad-container" class="hidden mb-8">
            <div class="relative inline-block group">
                 <img id="curiosidad-img" src="" alt="Dato curioso" class="mx-auto rounded-2xl shadow-xl max-h-[400px] object-contain border-4 border-white transform transition-transform duration-700 hover:scale-[1.02]">
                 <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-4 rounded-b-2xl opacity-0 group-hover:opacity-100 transition-opacity">
                    <p class="text-white text-sm font-medium">¬°Dato curioso del d√≠a!</p>
                 </div>
            </div>
          </div>

          <div class="space-y-4">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full shadow-lg animate-pop">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <h2 class="text-3xl font-black text-slate-800 tracking-tight">¬°Excelente trabajo!</h2>
            <p class="text-slate-600 max-w-md mx-auto text-lg">
              Has completado el calentamiento de hoy.
            </p>
          </div>

          <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-6 max-w-sm mx-auto shadow-sm">
            <p class="text-indigo-900 font-bold text-sm uppercase tracking-wide mb-2">Siguiente Paso</p>
            <p class="text-indigo-700 font-medium">
              Por favor, ve a <strong>Schoology</strong> para la siguiente actividad.
            </p>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    /*******************************************************
     * CONFIGURATION & SCHEDULE
     *******************************************************/
    
    // Default URLs (Fallback if no schedule matches)
    const DEFAULT_VERBS_URL = "https://raw.githubusercontent.com/scottscalici/imagenes/main/verbos/dailyJSON/presente-de-subjuntivo9.json";
    const DEFAULT_VOCAB_URL = "https://raw.githubusercontent.com/scottscalici/imagenes/main/vocabulario/rdv/D2-3-7.json";

    // MASTER LIST OF IMPORTANT VERBS (VIPs)
    // Used to prioritize common verbs when shuffling large banks
    const VIP_VERBS = [
      "ser", "estar", "haber", "tener", "hacer", "poder", "decir", "ir", 
      "ver", "dar", "saber", "querer", "llegar", "pasar", "deber", "poner", 
      "parecer", "quedar", "creer", "hablar", "llevar", "dejarse", "seguir", 
      "encontrar", "llamar", "venir", "pensar", "salir", "volver", "tomar", 
      "conocer", "vivir", "sentir", "tratar", "mirar", "contar", "empezar", 
      "esperar", "buscar", "existir", "entrar", "trabajar", "escribir", "perder", 
      "producir", "ocurrir", "entender", "pedir", "recibir", "recordar"
    ];

    // THE SCHEDULE (El Cerebro)
    // Map dates to specific files and titles.
    const SCHEDULE = {
       "2026-02-14": {
           topic: "Presente de Subjuntivo",
           verbs: "https://raw.githubusercontent.com/scottscalici/imagenes/main/verbos/dailyJSON/presente-de-subjuntivo9.json",
           vocab: "https://raw.githubusercontent.com/scottscalici/imagenes/main/vocabulario/rdv/D2-3-7.json",
           curiosidad: null 
       },
       // Example of how to add a "Big Bank" day:
       // "2026-02-15": {
       //    topic: "Pret√©rito Perfecto",
       //    verbs: "URL_TO_BIG_PERFECTO_FILE.json",
       //    vocab: "URL_TO_VOCAB.json",
       //    curiosidad: "URL_TO_IMAGE.jpg"
       // }
    };

    /*******************************************************
     * STATE & UTILS
     *******************************************************/
    const PASS_THRESHOLD = 0.5; // 50% needed to pass
    const TOTAL_MODULES = 6;
    let completedModules = 0;
    const modulePassed = {};

    const runtime = {
      verbsUrl: DEFAULT_VERBS_URL,
      vocabUrl: DEFAULT_VOCAB_URL,
      verbsLabel: "Verbos",
      vocabLabel: "Vocabulario",
      curiosidadUrl: null
    };

    // DOM Elements
    const progressFill = document.getElementById("progress-fill");
    const progressLabel = document.getElementById("progress-label");
    const topStatusEl = document.getElementById("topStatus");
    const pageSubtitleEl = document.getElementById("pageSubtitle");

    function showTopStatus(msg, kind="err") {
      topStatusEl.textContent = msg;
      topStatusEl.className = `mb-6 rounded-xl border p-4 text-sm shadow-sm ${kind === 'err' ? 'bg-red-50 border-red-200 text-red-700' : 'bg-blue-50 border-blue-200 text-blue-800'}`;
      topStatusEl.classList.remove("hidden");
    }

    async function getJSON(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }

    /*******************************************************
     * LOGIC: SCHEDULE & SHUFFLING
     *******************************************************/
    
    function applySchedule() {
      const today = new Date().toISOString().split('T')[0];
      const plan = SCHEDULE[today];

      if (plan) {
        console.log("üìÖ Plan found for today:", today);
        if (plan.verbs) runtime.verbsUrl = plan.verbs;
        if (plan.vocab) runtime.vocabUrl = plan.vocab;
        if (plan.topic) runtime.verbsLabel = plan.topic;
        if (plan.curiosidad) runtime.curiosidadUrl = plan.curiosidad;
      } else {
        console.log("No specific plan for today. Using defaults.");
      }
      
      // Update subtitle
      pageSubtitleEl.textContent = `Tema: ${runtime.verbsLabel}`;
    }

    // Fisher-Yates Shuffle
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    // THE SMART MIXER (VIPs + Randoms)
    function getSmartBatch(allVerbs, totalNeeded = 20, vipRatio = 0.6) {
      let vipCount = Math.round(totalNeeded * vipRatio);
      let randomCount = totalNeeded - vipCount;

      const vipBucket = [];
      const standardBucket = [];

      allVerbs.forEach(item => {
        const inf = (item.infinitivo || "").toLowerCase();
        if (VIP_VERBS.includes(inf)) {
          vipBucket.push(item);
        } else {
          standardBucket.push(item);
        }
      });

      shuffleArray(vipBucket);
      shuffleArray(standardBucket);

      const selected = [];

      // Fill VIP quota
      for (let i = 0; i < vipCount; i++) {
        if (vipBucket.length > 0) selected.push(vipBucket.pop());
        else if (standardBucket.length > 0) selected.push(standardBucket.pop());
      }
      // Fill Random quota
      for (let i = 0; i < randomCount; i++) {
        if (standardBucket.length > 0) selected.push(standardBucket.pop());
        else if (vipBucket.length > 0) selected.push(vipBucket.pop());
      }

      shuffleArray(selected);
      return selected;
    }

    /*******************************************************
     * VERB MODULES
     *******************************************************/

    function updateVerbInterface(name) {
      // Updates the H2 headers (e.g. "M√≥dulo 1.1 (Pret√©rito)")
      for (let i = 1; i <= 4; i++) {
        const div = document.getElementById("module-" + i);
        if (div) {
          const h2 = div.querySelector("h2");
          if (h2) h2.innerHTML = `M√≥dulo 1.${i} <span class="text-slate-400 font-normal ml-2 text-lg">(${name})</span>`;
        }
      }
    }

    function buildVerbModule(moduleNumber, items) {
      const container = document.getElementById("module-" + moduleNumber + "-questions");
      if (!container) return;
      container.innerHTML = "";

      items.forEach((item, index) => {
        const wrapper = document.createElement("div");
        // Styling: nice bottom border, clean spacing
        wrapper.className = "quiz-item py-4 border-b border-slate-100 last:border-0";
        
        // Handle Answers (Arrays joined by pipe)
        let answerData = "";
        if (Array.isArray(item.forma)) {
            answerData = item.forma.join("|");
        } else {
            answerData = item.forma;
        }
        wrapper.dataset.answer = answerData;

        // Display Data
        const sujeto = item.sujeto || "Yo";
        
        // Capitalize Tense
        let contexto = item.tiempo || "Presente";
        contexto = contexto.charAt(0).toUpperCase() + contexto.slice(1);

        const infinitivo = item.infinitivo || "verbo";
        
        // Translation Logic
        const rawTrad = item.traducci√≥n || item.traduccion || item.translation || "";
        const translationText = rawTrad ? ` ‚Äî ${rawTrad}` : "";

        // NEW LAYOUT: 1. Pret√©rito: Yo [ ____ ] (comer) - I ate
        wrapper.innerHTML = `
          <div class="flex flex-wrap items-baseline gap-x-3 gap-y-2 text-base sm:text-lg leading-relaxed">
            
            <span class="font-bold text-slate-700 whitespace-nowrap">
               ${index + 1}. <span class="text-xs font-bold text-slate-400 uppercase tracking-widest bg-slate-50 px-1.5 py-0.5 rounded mr-1">${contexto}</span> ${sujeto}
            </span>

            <input type="text" 
                   autocomplete="off" 
                   autocorrect="off" 
                   spellcheck="false"
                   class="border-b-2 border-slate-300 bg-slate-50 hover:bg-white focus:bg-white focus:border-indigo-500 focus:ring-0 px-2 py-0.5 w-32 sm:w-48 text-center font-bold text-indigo-700 outline-none transition-all placeholder-transparent rounded-t" 
                   placeholder="?" />

            <span class="text-slate-500 whitespace-nowrap text-base">
               (${infinitivo}) <span class="text-slate-400 italic font-normal text-sm">${translationText}</span>
            </span>

          </div>
          
          <p class="text-xs font-bold mt-2 ml-1 feedback hidden"></p>
        `;
        container.appendChild(wrapper);
      });
    }

    function attachQuizHandler(moduleNumber) {
      const btnCheck = document.getElementById("btn-check-module-" + moduleNumber);
      if (!btnCheck) return;

      btnCheck.addEventListener("click", () => {
        const selector = "#module-" + moduleNumber + " .quiz-item";
        const items = document.querySelectorAll(selector);
        const resultEl = document.getElementById("module-" + moduleNumber + "-result");

        let missing = false;
        
        // Check for empty fields
        items.forEach(item => {
          const input = item.querySelector("input");
          const feedback = item.querySelector(".feedback");
          if (!input) return;
          const value = (input.value || "").trim();
          if (value === "") {
            missing = true;
            input.classList.add("border-amber-400", "bg-amber-50");
            if (feedback) feedback.classList.add("hidden");
          } else {
             input.classList.remove("border-amber-400", "bg-amber-50");
          }
        });

        if (missing) {
          resultEl.textContent = "Por favor, completa todos los campos.";
          resultEl.className = "text-sm font-bold text-amber-600";
          return;
        }

        let correct = 0;
        
        items.forEach(item => {
          // 1. Get raw answers (separated by pipe)
          const rawAnswerString = (item.dataset.answer || "").trim();
          // 2. Normalize Valid Answers
          const validAnswers = rawAnswerString.split('|').map(s => s.trim().toLowerCase());
          
          const input = item.querySelector("input");
          const feedback = item.querySelector(".feedback");
          const userValue = (input.value || "").trim().toLowerCase();

          // 3. Check against list
          if (validAnswers.includes(userValue)) {
            correct++;
            input.classList.remove("border-red-400", "text-red-600", "border-slate-300");
            input.classList.add("border-emerald-500", "text-emerald-700", "bg-emerald-50");
            
            feedback.textContent = "Excelente";
            feedback.className = "text-xs font-bold mt-1 ml-1 feedback text-emerald-600 animate-pop";
          } else {
            input.classList.remove("border-emerald-500", "text-emerald-700", "border-slate-300");
            input.classList.add("border-red-400", "text-red-600", "bg-red-50");
            
            const displayAnswer = rawAnswerString.replace(/\|/g, " o ");
            feedback.textContent = `Respuesta: ${displayAnswer}`;
            feedback.className = "text-xs font-bold mt-1 ml-1 feedback text-red-500";
          }
        });

        const total = items.length;
        const score = total ? correct / total : 0;
        resultEl.textContent = `${correct} / ${total} correctos (${Math.round(score * 100)}%)`;

        const nextBtn = document.getElementById("btn-next-from-" + moduleNumber);

        if (score >= PASS_THRESHOLD) {
          resultEl.className = "text-sm font-bold text-emerald-600";
          if (nextBtn) {
            nextBtn.disabled = false;
            nextBtn.classList.remove("bg-slate-100", "text-slate-400", "cursor-not-allowed");
            nextBtn.classList.add("bg-indigo-600", "text-white", "hover:bg-indigo-700", "shadow-md");
          }
          markModuleCompleted(moduleNumber);
          const nextModule = moduleNumber + 1;
          if (nextModule <= 6) unlockModuleBtn(nextModule);
        } else {
          resultEl.className = "text-sm font-bold text-red-600";
        }
      });
    }

    async function loadPracticeSet() {
      try {
        const data = await getJSON(runtime.verbsUrl);
        let items = [];
        let tenseName = "Verbos";

        // Handle Structure (Array vs Object)
        if (Array.isArray(data)) {
            items = data;
        } else if (data.items) {
            items = data.items;
            if (data.meta && data.meta.title) tenseName = data.meta.title;
        }

        if (!items.length) throw new Error("JSON vac√≠o");

        // SMART MIXER Logic
        if (items.length > 20) {
            console.log(`Big Bank detected (${items.length}). Mixing Smart Batch.`);
            items = getSmartBatch(items, 20, 0.6); // 60% VIPs
        }

        // Dynamic Header Update
        if (items.length > 0 && items[0].tiempo) {
            // Use the first item's tense as the title if not set in meta
            tenseName = items[0].tiempo.charAt(0).toUpperCase() + items[0].tiempo.slice(1);
        }
        
        updateVerbInterface(tenseName);

        // Slice into chunks of 5
        const chunkSize = 5;
        for (let mod = 1; mod <= 4; mod++) {
            const start = (mod - 1) * chunkSize;
            const slice = items.slice(start, start + chunkSize);
            if(slice.length) buildVerbModule(mod, slice);
        }

        [1, 2, 3, 4].forEach(attachQuizHandler);

      } catch (err) {
        console.error(err);
        showTopStatus(`Error cargando verbos: ${err.message}`);
      }
    }

    /*******************************************************
     * VOCAB LOGIC (Existing)
     *******************************************************/
    // (Kept compact for readability - standard Levenshtein logic)
    function levenshtein(a,b){if(!a)return b?b.length:0;if(!b)return a?a.length:0;const m=a.length,n=b.length;const d=Array.from({length:m+1},()=>new Array(n+1).fill(0));for(let i=0;i<=m;i++)d[i][0]=i;for(let j=0;j<=n;j++)d[0][j]=j;for(let i=1;i<=m;i++){for(let j=1;j<=n;j++){const c=a[i-1]===b[j-1]?0:1;d[i][j]=Math.min(d[i-1][j]+1,d[i][j-1]+1,d[i-1][j-1]+c)}}return d[m][n]}
    function normalizeVocab(s){return (s||"").toLowerCase().trim().replace(/\([^)]*\)/g,"").replace(/^(to|the|a|an)\s+/,"").replace(/\s+/g," ")}
    function isVocabCorrect(user,ans){const u=normalizeVocab(user),a=normalizeVocab(ans);if(u===a)return true;const dist=levenshtein(u,a);return dist>0&&dist<=Math.min(2,Math.floor(Math.max(u.length,a.length)*0.25))}

    const vocabBlockContainer = document.getElementById("vocab-block-container");
    const vocabGlobalStatus = document.getElementById("vocab-global-status");
    let vocabState = { blocks: [], currentIdx: 0, scores: [] };

    async function loadVocabSet() {
       try {
         const data = await getJSON(runtime.vocabUrl);
         let raw = Array.isArray(data) ? data : (data.items || data.vocabulario || []);
         let pairs = raw.map(e => ({
            sp: e.spanish||e.es||e.palabra||"", 
            en: e.english||e.en||e.traducci√≥n||""
         })).filter(p=>p.sp&&p.en).slice(0,30);

         if(!pairs.length) throw new Error("No hay palabras");

         // Split into blocks of 10
         vocabState.blocks = [];
         for(let i=0; i<3; i++) {
            const slice = pairs.slice(i*10, (i+1)*10);
            if(slice.length) vocabState.blocks.push(slice);
         }
         buildVocabBlock(0);
       } catch(e) {
         console.error(e);
         showTopStatus("Error cargando vocabulario.");
       }
    }

    function buildVocabBlock(idx) {
       vocabBlockContainer.innerHTML = "";
       const block = vocabState.blocks[idx];
       if(!block) return;

       const header = document.createElement("div");
       header.className = "mb-4";
       header.innerHTML = `<h3 class="font-bold text-slate-700">Bloque ${idx+1} de ${vocabState.blocks.length}</h3>`;
       vocabBlockContainer.appendChild(header);

       block.forEach((item, i) => {
          const row = document.createElement("div");
          row.className = "vocab-item mb-3";
          row.dataset.answer = item.en;
          row.innerHTML = `
             <div class="flex flex-col sm:flex-row sm:items-baseline gap-2">
                <label class="text-sm font-semibold text-slate-600 min-w-[150px]">${i+1}. ${item.sp}</label>
                <input type="text" class="border rounded px-3 py-1.5 text-sm flex-grow focus:ring-2 focus:ring-sky-400 outline-none">
             </div>
             <p class="text-xs font-bold mt-1 sm:ml-[158px] feedback hidden"></p>
          `;
          vocabBlockContainer.appendChild(row);
       });

       const footer = document.createElement("div");
       footer.className = "mt-4 flex gap-4 items-center";
       footer.innerHTML = `<button class="btn-check-vocab px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold shadow-sm hover:bg-indigo-700">Corregir Vocabulario</button> <span class="result text-sm font-bold text-slate-600"></span>`;
       vocabBlockContainer.appendChild(footer);

       footer.querySelector(".btn-check-vocab").onclick = () => checkVocab(idx);
    }

    function checkVocab(idx) {
       const items = vocabBlockContainer.querySelectorAll(".vocab-item");
       let correct = 0;
       let missing = false;

       items.forEach(row => {
          const input = row.querySelector("input");
          if(!input.value.trim()) missing = true;
       });
       
       if(missing) {
          vocabBlockContainer.querySelector(".result").textContent = "Faltan respuestas.";
          return;
       }

       items.forEach(row => {
          const input = row.querySelector("input");
          const fb = row.querySelector(".feedback");
          const ans = row.dataset.answer;
          
          if(isVocabCorrect(input.value, ans)) {
             correct++;
             input.classList.add("border-emerald-500", "bg-emerald-50");
             fb.textContent = "Correcto";
             fb.className = "text-xs font-bold mt-1 sm:ml-[158px] feedback text-emerald-600";
          } else {
             input.classList.add("border-red-400", "bg-red-50");
             fb.textContent = `Correcto: ${ans}`;
             fb.className = "text-xs font-bold mt-1 sm:ml-[158px] feedback text-red-500";
          }
       });

       const total = items.length;
       const score = correct/total;
       const resText = vocabBlockContainer.querySelector(".result");
       resText.textContent = `${correct}/${total}`;

       // Simple logic: if > 50%, show next button
       if(score >= 0.5) {
          resText.className = "result text-sm font-bold text-emerald-600";
          const nextBtn = document.createElement("button");
          nextBtn.className = "ml-auto px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm font-bold shadow hover:bg-emerald-700";
          
          if(idx < vocabState.blocks.length - 1) {
             nextBtn.textContent = "Siguiente Bloque ‚Üí";
             nextBtn.onclick = () => buildVocabBlock(idx + 1);
          } else {
             nextBtn.textContent = "Terminar Vocabulario";
             nextBtn.onclick = () => {
                vocabGlobalStatus.textContent = "¬°Vocabulario completado!";
                markModuleCompleted(5);
                unlockModuleBtn(6);
                const finalBtn = document.getElementById("btn-next-from-5");
                if(finalBtn) {
                    finalBtn.disabled = false;
                    finalBtn.classList.remove("bg-slate-100", "text-slate-400", "cursor-not-allowed");
                    finalBtn.classList.add("bg-emerald-600", "text-white", "hover:bg-emerald-700");
                }
             };
          }
          vocabBlockContainer.querySelector(".mt-4").appendChild(nextBtn);
       }
    }

    document.getElementById("btn-reset-vocab").onclick = () => { buildVocabBlock(0); };


    /*******************************************************
     * GLOBAL NAV
     *******************************************************/
    function updateProgress() {
      const pct = Math.round((completedModules / TOTAL_MODULES) * 100);
      progressFill.style.width = pct + "%";
      progressLabel.textContent = pct + "%";
    }

    function markModuleCompleted(n) {
      if(!modulePassed[n]) {
        modulePassed[n] = true;
        completedModules = Object.keys(modulePassed).length;
        updateProgress();
        const b = document.getElementById("badge-"+n);
        if(b) b.textContent = "‚úî";
      }
    }

    function unlockModuleBtn(n) {
      const btn = document.querySelector(`.module-tab[data-module="${n}"]`);
      if(btn) {
         btn.disabled = false;
         btn.classList.remove("text-slate-500", "bg-slate-50");
         btn.classList.add("text-slate-700", "bg-white", "hover:bg-slate-50");
      }
      const b = document.getElementById("badge-"+n);
      if(b && b.textContent==="üîí") b.textContent = "‚óè";
    }

    function showModule(n) {
      document.querySelectorAll(".module-view").forEach(el => el.classList.add("hidden"));
      const target = document.getElementById("module-"+n);
      if(target) target.classList.remove("hidden");
      
      // Update Sidebar Active State
      document.querySelectorAll(".module-tab").forEach(btn => {
         if(Number(btn.dataset.module) === n) {
            btn.classList.add("ring-2", "ring-indigo-100", "bg-indigo-50", "text-indigo-700");
         } else {
            btn.classList.remove("ring-2", "ring-indigo-100", "bg-indigo-50", "text-indigo-700");
         }
      });
    }

    // Wiring Buttons
    function wireNavigation() {
       for(let i=1; i<=4; i++) {
          const btn = document.getElementById("btn-next-from-"+i);
          if(btn) btn.onclick = () => showModule(i+1);
       }
       document.getElementById("btn-next-from-5").onclick = () => {
           showModule(6);
           markModuleCompleted(6);
           // Show Image if exists
           if(runtime.curiosidadUrl) {
               const cont = document.getElementById("curiosidad-container");
               const img = document.getElementById("curiosidad-img");
               img.src = runtime.curiosidadUrl;
               cont.classList.remove("hidden");
           }
       };
       document.querySelectorAll(".module-tab").forEach(btn => {
          btn.onclick = () => { if(!btn.disabled) showModule(Number(btn.dataset.module)); };
       });
       document.querySelectorAll("[data-go-module]").forEach(btn => {
          btn.onclick = () => showModule(Number(btn.dataset.goModule));
       });
    }

    async function init() {
      applySchedule();
      wireNavigation();
      showModule(1);
      await loadPracticeSet();
      await loadVocabSet();
    }

    init();
  </script>

  <style>
  #cls-modal-overlay { display: none; position: fixed; inset: 0; z-index: 9999; background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px; }
  #cls-modal-card { background: white; width: 100%; max-width: 1400px; height: 90vh; border-radius: 16px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
  .cls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
  .cls-card { border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px; background: white; text-align: center; }
  .cls-reveal { background: #f1f5f9; color: transparent; cursor: pointer; border-radius: 4px; margin-top: 4px; font-weight: bold; font-family: monospace; padding: 2px; }
  .cls-reveal.revealed { background: white; color: #0f172a; }
  </style>

  <div id="cls-modal-overlay">
    <div id="cls-modal-card">
       <div class="p-4 border-b border-slate-200 flex justify-between bg-slate-50">
          <h2 class="font-black text-xl text-slate-700">VISTA DE PROYECTOR</h2>
          <button onclick="document.getElementById('cls-modal-overlay').style.display='none'" class="text-3xl leading-none text-slate-400 hover:text-red-500">&times;</button>
       </div>
       <div id="cls-content" class="flex-grow overflow-y-auto p-6 bg-slate-100"></div>
    </div>
  </div>

  <script>
    const projBtn = document.createElement("button");
    projBtn.innerHTML = "üì∫ Proyector";
    projBtn.className = "w-full py-3 rounded-xl bg-slate-800 text-white font-bold shadow hover:bg-slate-900 transition-colors mb-4";
    projBtn.onclick = async () => {
        const overlay = document.getElementById('cls-modal-overlay');
        const content = document.getElementById('cls-content');
        overlay.style.display = 'flex';
        content.innerHTML = "Cargando...";
        
        try {
            // Re-fetch clean data
            const vData = await getJSON(runtime.verbsUrl);
            let items = Array.isArray(vData) ? vData : vData.items;
            if(items.length > 20) items = getSmartBatch(items, 20); // Reuse logic
            
            let html = '<div class="mb-8"><h3 class="text-indigo-600 font-black text-lg mb-4 uppercase">Verbos</h3><div class="cls-grid">';
            items.slice(0,20).forEach(it => {
               const ans = Array.isArray(it.forma) ? it.forma.join(" / ") : it.forma;
               html += `<div class="cls-card"><div class="text-xs text-slate-500 font-bold uppercase">${it.sujeto}</div><div class="text-sm italic text-slate-400 mb-1">${it.infinitivo}</div><div class="cls-reveal" onclick="this.classList.add('revealed')">${ans}</div></div>`;
            });
            html += '</div></div>';
            content.innerHTML = html;
        } catch(e) { content.innerHTML = "Error loading data."; }
    };
    document.getElementById("projector-btn-area").appendChild(projBtn);
  </script>
</body>
</html>

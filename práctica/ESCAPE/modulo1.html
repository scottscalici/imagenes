<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M√≥dulo 1 ‚Äì Verbos presente + vocabulario</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen">
  <!-- STICKY HEADER WITH PROGRESS -->
  <header class="sticky top-0 z-20 bg-white shadow-sm">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <div>
        <h1 class="text-lg sm:text-xl font-bold text-slate-800">
          Examen del semestre 
        </h1>
        <p class="text-xs sm:text-sm text-slate-500">
          Nivel 1
        </p>
      </div>
      <div class="w-40 sm:w-64">
        <div class="w-full bg-slate-200 rounded-full h-2 overflow-hidden">
          <div id="progress-fill" class="h-2 bg-emerald-500 transition-all duration-300" style="width: 0%;"></div>
        </div>
        <p id="progress-label" class="text-[10px] sm:text-xs text-slate-600 mt-1 text-right">
          0 % completado
        </p>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <div class="grid md:grid-cols-[230px,1fr] gap-6">
      <!-- SIDEBAR -->
      <aside class="bg-white rounded-2xl shadow p-4 text-sm space-y-3">
        <h2 class="text-xs font-semibold text-slate-500 uppercase tracking-wide">
          M√≥dulos
        </h2>

        <button class="module-tab w-full text-left px-3 py-2 rounded-lg flex items-center justify-between gap-2 bg-sky-50 text-sky-800 border border-sky-200 text-sm"
                data-module="1">
          <span>M√≥dulo 1.1 ¬∑ Verbos</span>
          <span id="badge-1" class="text-xs">‚óè</span>
        </button>

        <button class="module-tab w-full text-left px-3 py-2 rounded-lg flex items-center justify-between gap-2 bg-slate-50 text-slate-500 border border-slate-200 text-sm"
                data-module="2" disabled>
          <span>M√≥dulo 1.2 ¬∑ Verbos</span>
          <span id="badge-2" class="text-xs">üîí</span>
        </button>

        <button class="module-tab w-full text-left px-3 py-2 rounded-lg flex items-center justify-between gap-2 bg-slate-50 text-slate-500 border border-slate-200 text-sm"
                data-module="3" disabled>
          <span>M√≥dulo 1.3 ¬∑ Verbos</span>
          <span id="badge-3" class="text-xs">üîí</span>
        </button>

        <button class="module-tab w-full text-left px-3 py-2 rounded-lg flex items-center justify-between gap-2 bg-slate-50 text-slate-500 border border-slate-200 text-sm"
                data-module="4" disabled>
          <span>M√≥dulo 1.4 ¬∑ Verbos</span>
          <span id="badge-4" class="text-xs">üîí</span>
        </button>

        <button class="module-tab w-full text-left px-3 py-2 rounded-lg flex items-center justify-between gap-2 bg-slate-50 text-slate-500 border border-slate-200 text-sm"
                data-module="5" disabled>
          <span>M√≥dulo 2 ¬∑ Repaso vocabulario</span>
          <span id="badge-5" class="text-xs">üîí</span>
        </button>

        <button class="module-tab w-full text-left px-3 py-2 rounded-lg flex items-center justify-between gap-2 bg-slate-50 text-slate-500 border border-slate-200 text-sm"
                data-module="6" disabled>
          <span>M√≥dulo 3 ¬∑ Curiosidad</span>
          <span id="badge-6" class="text-xs">üîí</span>
        </button>
      </aside>

      <!-- MAIN PANEL -->
      <section class="bg-white rounded-2xl shadow p-5 md:p-6 min-h-[320px]">
        <!-- Module 1.1 -->
        <div id="module-1" class="module-view space-y-4">
          <h2 class="text-xl font-semibold text-slate-800">
            M√≥dulo 1.1 ¬∑ Verbos (presente)
          </h2>
          <p class="text-sm text-slate-600">
            Completa las formas verbales. Necesitas <strong>100&nbsp;%</strong> para avanzar al siguiente m√≥dulo.
          </p>

          <div id="module-1-questions" class="space-y-3"></div>

          <div class="flex flex-wrap items-center gap-3 pt-2">
            <button id="btn-check-module-1"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-sky-600 hover:bg-sky-700 text-white text-sm font-semibold">
              Corregir respuestas
            </button>
            <p id="module-1-result" class="text-sm text-slate-700"></p>
          </div>

          <div class="flex justify-end pt-4 border-t border-slate-100 mt-4">
            <button id="btn-next-from-1"
                    class="px-4 py-2 rounded-lg bg-slate-300 text-slate-600 text-sm font-semibold cursor-not-allowed"
                    disabled>
              Siguiente m√≥dulo (1.2) ‚Üí
            </button>
          </div>
        </div>

        <!-- Module 1.2 -->
        <div id="module-2" class="module-view space-y-4 hidden">
          <h2 class="text-xl font-semibold text-slate-800">
            M√≥dulo 1.2 ¬∑ Verbos (presente)
          </h2>
          <p class="text-sm text-slate-600">
            Segundo bloque de este conjunto de pr√°ctica.
          </p>

          <div id="module-2-questions" class="space-y-3"></div>

          <div class="flex flex-wrap items-center gap-3 pt-2">
            <button id="btn-check-module-2"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-sky-600 hover:bg-sky-700 text-white text-sm font-semibold">
              Corregir respuestas
            </button>
            <p id="module-2-result" class="text-sm text-slate-700"></p>
          </div>

          <div class="flex justify-between pt-4 border-t border-slate-100 mt-4">
            <button class="px-3 py-2 rounded-lg bg-slate-100 text-slate-700 text-sm font-semibold"
                    data-go-module="1">
              ‚Üê Volver a 1.1
            </button>
            <button id="btn-next-from-2"
                    class="px-4 py-2 rounded-lg bg-slate-300 text-slate-600 text-sm font-semibold cursor-not-allowed"
                    disabled>
              Siguiente m√≥dulo (1.3) ‚Üí
            </button>
          </div>
        </div>

        <!-- Module 1.3 -->
        <div id="module-3" class="module-view space-y-4 hidden">
          <h2 class="text-xl font-semibold text-slate-800">
            M√≥dulo 1.3 ¬∑ Verbos (presente)
          </h2>
          <p class="text-sm text-slate-600">
            Tercer bloque de este conjunto de pr√°ctica.
          </p>

          <div id="module-3-questions" class="space-y-3"></div>

          <div class="flex flex-wrap items-center gap-3 pt-2">
            <button id="btn-check-module-3"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-sky-600 hover:bg-sky-700 text-white text-sm font-semibold">
              Corregir respuestas
            </button>
            <p id="module-3-result" class="text-sm text-slate-700"></p>
          </div>

          <div class="flex justify-between pt-4 border-t border-slate-100 mt-4">
            <button class="px-3 py-2 rounded-lg bg-slate-100 text-slate-700 text-sm font-semibold"
                    data-go-module="2">
              ‚Üê Volver a 1.2
            </button>
            <button id="btn-next-from-3"
                    class="px-4 py-2 rounded-lg bg-slate-300 text-slate-600 text-sm font-semibold cursor-not-allowed"
                    disabled>
              Siguiente m√≥dulo (1.4) ‚Üí
            </button>
          </div>
        </div>

        <!-- Module 1.4 -->
        <div id="module-4" class="module-view space-y-4 hidden">
          <h2 class="text-xl font-semibold text-slate-800">
            M√≥dulo 1.4 ¬∑ Verbos (presente)
          </h2>
          <p class="text-sm text-slate-600">
            √öltimo bloque de verbos de este conjunto. Al completar con √©xito, se desbloquea el M√≥dulo 2.
          </p>

          <div id="module-4-questions" class="space-y-3"></div>

          <div class="flex flex-wrap items-center gap-3 pt-2">
            <button id="btn-check-module-4"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-sky-600 hover:bg-sky-700 text-white text-sm font-semibold">
              Corregir respuestas
            </button>
            <p id="module-4-result" class="text-sm text-slate-700"></p>
          </div>

          <div class="flex justify-between pt-4 border-t border-slate-100 mt-4">
            <button class="px-3 py-2 rounded-lg bg-slate-100 text-slate-700 text-sm font-semibold"
                    data-go-module="3">
              ‚Üê Volver a 1.3
            </button>
            <button id="btn-next-from-4"
                    class="px-4 py-2 rounded-lg bg-slate-300 text-slate-600 text-sm font-semibold cursor-not-allowed"
                    disabled>
              Ir al M√≥dulo 2 ‚Üí
            </button>
          </div>
        </div>

        <!-- Module 2 ‚Äì vocab real -->
        <div id="module-5" class="module-view space-y-4 hidden">
          <h2 class="text-xl font-semibold text-slate-800">
            M√≥dulo 2 ¬∑ Repaso de vocabulario
          </h2>
          <p class="text-sm text-slate-600">
            Escribe la traducci√≥n al ingl√©s. Luego, empareja solo las palabras que fallaste.
          </p>
          <p class="text-xs text-slate-500">
            Este m√≥dulo usa 30 palabras (3 bloques de 10)
          </p>

          <!-- Bloque din√°mico -->
          <div id="vocab-block-container" class="space-y-4 mt-4"></div>
          <p id="vocab-global-status" class="text-xs text-slate-500"></p>

          <div class="flex flex-wrap items-center justify-between gap-2 pt-4 border-t border-slate-100 mt-4">
  <button class="px-3 py-2 rounded-lg bg-slate-100 text-slate-700 text-sm font-semibold"
          data-go-module="4">
    ‚Üê Volver a 1.4
  </button>

  <button id="btn-reset-vocab"
          class="px-3 py-2 rounded-lg bg-slate-50 border border-slate-200 text-slate-700 text-sm font-semibold">
    Reiniciar vocabulario
  </button>

  <button id="btn-next-from-5"
          class="px-4 py-2 rounded-lg bg-slate-300 text-slate-600 text-sm font-semibold cursor-not-allowed"
          disabled>
    Ir al M√≥dulo 3 ‚Üí
  </button>
</div>

        </div>

       <!-- Module 3 ‚Äì pista / contrase√±a -->
<div id="module-6" class="module-view space-y-4 hidden">
  <h2 class="text-xl font-semibold text-slate-800">
    M√≥dulo 3 ¬∑ Pista / contrase√±a
  </h2>
  <p class="text-sm text-slate-600">
    ¬°Buen trabajo! Has completado los verbos y el vocabulario.
  </p>
  <p class="text-sm text-slate-600">
    Aqu√≠ est√° la <strong>contrase√±a</strong> que necesitas para
    desbloquear el siguiente nivel del examen (en otra p√°gina).
  </p>

  <!-- üëâ Puedes cambiar este bloque cada vez -->
  <div class="mt-4 p-4 border border-dashed border-emerald-300 rounded-xl bg-emerald-50">
    <p class="text-sm font-semibold text-emerald-800 mb-1">
      Contrase√±a para el siguiente nivel:
    </p>
    <p class="text-lg font-mono tracking-widest text-emerald-900">
      <span class="select-all">DESCANSOMENTAL25</span>
    </p>
    <p class="text-xs text-emerald-700 mt-2">
      (Escribe esta contrase√±a en la siguiente p√°gina cuando se te pida.)
    </p>
  </div>

  <div class="flex justify-between pt-4 border-t border-slate-100 mt-4">
    <button class="px-3 py-2 rounded-lg bg-slate-100 text-slate-700 text-sm font-semibold"
            data-go-module="5">
      ‚Üê Volver al M√≥dulo 2
    </button>

    <!-- üîê Bot√≥n para ir al siguiente m√≥dulo/p√°gina -->
    <a href="modulo2.html"
       class="px-3 py-2 rounded-lg bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700 transition">
      Ir al siguiente nivel ‚Üí
    </a>
  </div>
</div>


  </main>

  <script>
    // üëâ Change this per day (VERBS):
    const PRACTICE_JSON_URL =
      'https://raw.githubusercontent.com/scottscalici/imagenes/main/pr√°ctica/ESCAPE/verbos1.json';

    // üëâ Change this per day (VOCAB):
    const VOCAB_JSON_URL =
      'https://raw.githubusercontent.com/scottscalici/imagenes/refs/heads/main/pr√°ctica/ESCAPE/vocab8.json';

    const TOTAL_MODULES = 6;
    const PASS_THRESHOLD = 1.0;

    const progressFill = document.getElementById('progress-fill');
    const progressLabel = document.getElementById('progress-label');
    const modulePassed = {};
    let completedModules = 0;

    function updateProgress() {
      const percent = Math.round((completedModules / TOTAL_MODULES) * 100);
      progressFill.style.width = percent + '%';
      progressLabel.textContent = percent + '% completado';
    }

    function markModuleCompleted(n) {
      if (!modulePassed[n]) {
        modulePassed[n] = true;
        completedModules = Object.keys(modulePassed).length;
        updateProgress();
        const badge = document.getElementById('badge-' + n);
        if (badge) badge.textContent = '‚úî';
      }
    }

    function unlockModuleBtn(n) {
      const tab = document.querySelector('.module-tab[data-module="' + n + '"]');
      const badge = document.getElementById('badge-' + n);
      if (tab) {
        tab.disabled = false;
        tab.classList.remove('text-slate-500');
      }
      if (badge && badge.textContent === 'üîí') {
        badge.textContent = '‚óè';
      }
    }

    function showModule(n) {
      document.querySelectorAll('.module-view').forEach(view => view.classList.add('hidden'));
      const active = document.getElementById('module-' + n);
      if (active) active.classList.remove('hidden');

      document.querySelectorAll('.module-tab').forEach(btn => {
        const m = btn.dataset.module;
        if (String(m) === String(n)) {
          btn.classList.add('bg-sky-50', 'text-sky-800', 'border-sky-300');
          btn.classList.remove('bg-slate-50', 'text-slate-500', 'border-slate-200');
        } else {
          btn.classList.remove('bg-sky-50', 'text-sky-800', 'border-sky-300');
          btn.classList.add('bg-slate-50', 'text-slate-500', 'border-slate-200');
        }
      });
    }

    function buildVerbModule(moduleNumber, items) {
      const container = document.getElementById('module-' + moduleNumber + '-questions');
      if (!container) return;
      container.innerHTML = '';

      items.forEach((item, index) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'space-y-1 quiz-item';
        wrapper.dataset.answer = item.forma;

        const sujeto = item.sujeto || '';
        const contexto = item.contexto || '___';
        const infinitivo = item.infinitivo || '';

        wrapper.innerHTML = `
          <label class="text-sm font-medium text-slate-800">
            ${index + 1}. ${sujeto} ${contexto} (${infinitivo})
          </label>
          <input type="text"
                 class="w-full border rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400" />
          <p class="text-xs text-slate-500 feedback hidden"></p>
        `;
        container.appendChild(wrapper);
      });
    }

    function buildAllVerbModules(items) {
      const chunkSize = 5;
      for (let moduleNum = 1; moduleNum <= 4; moduleNum++) {
        const start = (moduleNum - 1) * chunkSize;
        const slice = items.slice(start, start + chunkSize);
        if (!slice.length) break;
        buildVerbModule(moduleNum, slice);
      }
    }

function attachQuizHandler(moduleNumber) {
  const btnCheck = document.getElementById('btn-check-module-' + moduleNumber);
  if (!btnCheck) return;

  btnCheck.addEventListener('click', () => {
    const selector = '#module-' + moduleNumber + ' .quiz-item';
    const items = document.querySelectorAll(selector);
    const resultEl = document.getElementById('module-' + moduleNumber + '-result');

    let missing = false;
    items.forEach(item => {
      const input = item.querySelector('input');
      const feedback = item.querySelector('.feedback');
      if (!input) return;
      const value = (input.value || '').trim();
      if (value === '') {
        missing = true;
        input.classList.remove('border-emerald-400', 'border-red-400');
        input.classList.add('border-yellow-400');
        if (feedback) feedback.classList.add('hidden');
      }
    });

    if (missing) {
      resultEl.textContent = 'Responde todos los campos antes de corregir tus respuestas.';
      resultEl.classList.remove('text-emerald-700');
      resultEl.classList.add('text-red-600');
      return;
    }

    let correct = 0;
    items.forEach(item => {
      const rawAnswer = (item.dataset.answer || '').trim();
      const answer = rawAnswer.toLowerCase();
      const input = item.querySelector('input');
      const feedback = item.querySelector('.feedback');
      if (!input) return;
      const userValue = (input.value || '').trim().toLowerCase();

      if (userValue === answer) {
        correct++;
        input.classList.remove('border-red-400', 'border-yellow-400');
        input.classList.add('border-emerald-400');
      } else {
        input.classList.remove('border-emerald-400', 'border-yellow-400');
        input.classList.add('border-red-400');
      }

      // Ocultar el texto de feedback para que no aparezcan las respuestas correctas
      if (feedback) {
        feedback.textContent = '';
        feedback.classList.add('hidden');
      }
    });

    const total = items.length;
    const score = total ? correct / total : 0;
    resultEl.textContent = `Obtuviste ${correct} de ${total} (${Math.round(score * 100)} %).`;

    const nextBtn = document.getElementById('btn-next-from-' + moduleNumber);

    if (score >= PASS_THRESHOLD) {
      resultEl.classList.remove('text-red-600');
      resultEl.classList.add('text-emerald-700');

      if (nextBtn) {
        nextBtn.disabled = false;
        nextBtn.classList.remove('bg-slate-300', 'text-slate-600', 'cursor-not-allowed');
        nextBtn.classList.add('bg-emerald-600', 'hover:bg-emerald-700', 'text-white');
      }

      markModuleCompleted(moduleNumber);
      const nextModule = moduleNumber + 1;
      if (nextModule <= 6) unlockModuleBtn(nextModule);
    } else {
      resultEl.classList.remove('text-emerald-700');
      resultEl.classList.add('text-red-600');
    }
  });
}


    async function loadPracticeSet() {
      try {
        const res = await fetch(PRACTICE_JSON_URL);
        const data = await res.json();
        const items = data; // this file is already your 20-item subset

        buildAllVerbModules(items);
        [1, 2, 3, 4].forEach(attachQuizHandler);
      } catch (err) {
        console.error('Error al cargar el JSON de pr√°ctica:', err);
        const result = document.getElementById('module-1-result');
        if (result) {
          result.textContent = 'No se pudo cargar el conjunto de pr√°ctica (revisa la URL del JSON).';
          result.classList.add('text-red-600');
        }
      }
    }

// ===== VOCAB MODULE (M√≥dulo 2) =====

const vocabBlockContainer = document.getElementById('vocab-block-container');
const vocabGlobalStatus = document.getElementById('vocab-global-status');
const nextFrom5Btn = document.getElementById('btn-next-from-5');
const resetVocabBtn = document.getElementById('btn-reset-vocab');

const vocabState = {
  blocks: [],        // [{ items: [{spanish, english}], index }]
  currentIndex: 0,   // 0,1,2
  completedBlocks: 0,
  scores: [],        // [{correct, total}] per block
  pairs: []          // full list of 30 words (for reset)
};

// ---------- Helpers for flexible / typo-tolerant checking ----------

function normalizeVocabPiece(str) {
  let s = (str || '').toLowerCase().trim();

  // Remove anything in parentheses: (money), (up with), etc.
  s = s.replace(/\([^)]*\)/g, ' ').trim();

  // Strip leading "to / the / a / an"
  while (/^(to|the|a|an)\s+/.test(s)) {
    s = s.replace(/^(to|the|a|an)\s+/, '');
  }

  // Collapse extra spaces
  s = s.replace(/\s+/g, ' ');
  return s;
}


// Simple Levenshtein distance for small typos
function levenshtein(a, b) {
  a = a || '';
  b = b || '';
  const m = a.length;
  const n = b.length;
  if (m === 0) return n;
  if (n === 0) return m;

  const dp = Array.from({ length: m + 1 }, () => new Array(n + 1).fill(0));

  for (let i = 0; i <= m; i++) dp[i][0] = i;
  for (let j = 0; j <= n; j++) dp[0][j] = j;

  for (let i = 1; i <= m; i++) {
    for (let j = 1; j <= n; j++) {
      const cost = a[i - 1] === b[j - 1] ? 0 : 1;
      dp[i][j] = Math.min(
        dp[i - 1][j] + 1,      // deletion
        dp[i][j - 1] + 1,      // insertion
        dp[i - 1][j - 1] + cost // substitution
      );
    }
  }
  return dp[m][n];
}

function isVocabCorrect(userRaw, answerRaw) {
  const user = (userRaw || '').trim();
  const ans = (answerRaw || '').trim();
  if (!ans) return false;

  // Split on common separators: ; , /
  const answerParts = ans
    .split(/[;,/]/)
    .map(normalizeVocabPiece)
    .filter(Boolean);

  const userParts = user
    .split(/[;,/]/)
    .map(normalizeVocabPiece)
    .filter(Boolean);

  // Fallback: compare whole thing
  if (!answerParts.length) {
    return normalizeVocabPiece(user) === normalizeVocabPiece(ans);
  }
  if (!userParts.length) return false;

  // Correct if ANY user piece ‚âà ANY answer piece (exact or small typo)
  for (const up of userParts) {
    for (const ap of answerParts) {
      if (!ap) continue;
      if (up === ap) return true;

      const dist = levenshtein(up, ap);
      const len = Math.max(up.length, ap.length);
      const maxAllowed = Math.min(2, Math.floor(len * 0.25)); // e.g. 1 error for 4‚Äì7 letters, max 2

      if (dist > 0 && dist <= maxAllowed) return true;
    }
  }

  return false;
}

// ---------- Extractor: adapts to your spanish/english JSON ----------

function extractVocabPairs(data) {
  let raw = [];
  if (Array.isArray(data)) {
    raw = data;
  } else if (Array.isArray(data.items)) {
    raw = data.items;
  } else if (Array.isArray(data.vocabulario)) {
    raw = data.vocabulario;
  }

  return raw
    .map(entry => {
      const spanish =
        entry.spanish ||
        entry.es ||
        entry.espanol ||
        entry.espa√±ol ||
        entry.palabra ||
        entry.termino ||
        entry.vocabulario ||
        '';
      const english =
        entry.english ||
        entry.en ||
        entry.ingles ||
        entry.englishText ||
        entry.traduccion ||
        entry.definicion ||
        '';
      return { spanish, english };
    })
    .filter(p => p.spanish && p.english);
}

// ---------- Typing stage (bloques de 10) ----------

function buildTypingStage(blockIdx) {
  const totalBlocks = vocabState.blocks.length;
  const block = vocabState.blocks[blockIdx];
  if (!block) return;

  vocabBlockContainer.innerHTML = '';

  const header = document.createElement('div');
  header.className = 'flex items-baseline justify-between gap-2';
  header.innerHTML = `
    <h3 class="text-lg font-semibold text-slate-800">
      Bloque ${blockIdx + 1} de ${totalBlocks}
    </h3>
    <p class="text-xs text-slate-500">
      Escribe la traducci√≥n al ingl√©s para cada palabra.
    </p>
  `;
  vocabBlockContainer.appendChild(header);

  const list = document.createElement('div');
  list.className = 'space-y-3 mt-2';

  block.items.forEach((item, i) => {
    const row = document.createElement('div');
    row.className = 'space-y-1 vocab-item';
    row.dataset.answer = item.english;

    row.innerHTML = `
      <label class="text-sm font-medium text-slate-800">
        ${i + 1}. ${item.spanish}
      </label>
      <input type="text"
             class="w-full border rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400" />
      <p class="text-xs text-slate-500 feedback hidden"></p>
    `;
    list.appendChild(row);
  });

  vocabBlockContainer.appendChild(list);

  const footer = document.createElement('div');
  footer.className = 'flex flex-wrap items-center gap-3 pt-3';
  footer.innerHTML = `
    <button id="btn-vocab-check"
            class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-sky-600 hover:bg-sky-700 text-white text-sm font-semibold">
      Corregir respuestas
    </button>
    <p id="vocab-block-result" class="text-sm text-slate-700"></p>
  `;
  vocabBlockContainer.appendChild(footer);

  const checkBtn = footer.querySelector('#btn-vocab-check');
  const resultEl = footer.querySelector('#vocab-block-result');

  checkBtn.addEventListener('click', () => {
    const items = vocabBlockContainer.querySelectorAll('.vocab-item');

    let missing = false;
    items.forEach(item => {
      const input = item.querySelector('input');
      const feedback = item.querySelector('.feedback');
      const val = (input.value || '').trim();
      if (!val) {
        missing = true;
        input.classList.remove('border-emerald-400', 'border-red-400');
        input.classList.add('border-yellow-400');
        feedback.classList.add('hidden');
      }
    });

    if (missing) {
      resultEl.textContent = 'Responde todos los campos antes de corregir.';
      resultEl.classList.remove('text-emerald-700');
      resultEl.classList.add('text-red-600');
      return;
    }

    let correct = 0;
    const wrongItems = [];

    items.forEach(item => {
      const rawAnswer = (item.dataset.answer || '').trim();
      const input = item.querySelector('input');
      const feedback = item.querySelector('.feedback');
      const userVal = (input.value || '').trim();

      const ok = isVocabCorrect(userVal, rawAnswer);

      if (ok) {
        correct++;
        input.classList.remove('border-red-400', 'border-yellow-400');
        input.classList.add('border-emerald-400');
        feedback.textContent = `‚úÖ Correcto: ${rawAnswer}`;
        feedback.classList.remove('hidden', 'text-red-500');
        feedback.classList.add('text-emerald-600');
      } else {
        input.classList.remove('border-emerald-400', 'border-yellow-400');
        input.classList.add('border-red-400');
        feedback.textContent = `‚ùå Correcto: ${rawAnswer}`;
        feedback.classList.remove('hidden', 'text-emerald-600');
        feedback.classList.add('text-red-500');

        const idx = Number(item.querySelector('label').textContent.split('.')[0]) - 1;
        wrongItems.push(block.items[idx]);
      }
    });

    const total = items.length;
    const score = total ? correct / total : 0;

    // Guarda el resultado de este bloque para el resumen final
    vocabState.scores[blockIdx] = { correct, total };

    resultEl.textContent = `Obtuviste ${correct} de ${total} (${Math.round(score * 100)} %).`;

    if (wrongItems.length === 0) {
      resultEl.classList.remove('text-red-600');
      resultEl.classList.add('text-emerald-700');
      buildNextBlockButton(blockIdx);
    } else {
      resultEl.classList.remove('text-emerald-700');
      resultEl.classList.add('text-slate-700');
      buildMatchingStage(blockIdx, wrongItems);
    }
  });
}

// ---------- Matching stage for wrong answers ----------

function buildMatchingStage(blockIdx, wrongItems) {
  const existingMatch = document.getElementById('vocab-matching-section');
  if (existingMatch) existingMatch.remove();

  const matchSection = document.createElement('div');
  matchSection.id = 'vocab-matching-section';
  matchSection.className = 'mt-5 border-t border-slate-200 pt-4 space-y-3';

  matchSection.innerHTML = `
    <h4 class="text-sm font-semibold text-slate-800">
      Empareja las palabras que fallaste
    </h4>
    <p class="text-xs text-slate-500">
      Haz clic primero en la palabra en espa√±ol y luego en su traducci√≥n correcta en ingl√©s.
    </p>
  `;

  const columns = document.createElement('div');
  columns.className = 'grid sm:grid-cols-2 gap-3';

  const leftCol = document.createElement('div');
  leftCol.className = 'space-y-2';
  const rightCol = document.createElement('div');
  rightCol.className = 'space-y-2';

  function shuffle(arr) {
    return arr
      .map(v => ({ v, sort: Math.random() }))
      .sort((a, b) => a.sort - b.sort)
      .map(({ v }) => v);
  }

  const shuffledSpanish = shuffle(wrongItems);
  const shuffledEnglish = shuffle(wrongItems);

  shuffledSpanish.forEach((item, idx) => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className =
      'w-full text-left px-3 py-1.5 rounded-lg border border-slate-200 text-sm bg-slate-50 hover:bg-slate-100 spanish-option';
    btn.dataset.key = String(idx);
    btn.textContent = item.spanish;
    leftCol.appendChild(btn);
  });

  shuffledEnglish.forEach((item, idx) => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className =
      'w-full text-left px-3 py-1.5 rounded-lg border border-slate-200 text-sm bg-slate-50 hover:bg-slate-100 english-option';
    btn.dataset.spanish = item.spanish;
    btn.dataset.english = item.english;
    btn.textContent = item.english; // <- important

    rightCol.appendChild(btn);
  });

  columns.appendChild(leftCol);
  columns.appendChild(rightCol);
  matchSection.appendChild(columns);

  const status = document.createElement('p');
  status.className = 'text-xs text-slate-500 mt-2';
  matchSection.appendChild(status);

  vocabBlockContainer.appendChild(matchSection);

  let selectedSpanishBtn = null;
  let remaining = wrongItems.length;

  function clearSelections() {
    vocabBlockContainer
      .querySelectorAll('.spanish-option, .english-option')
      .forEach(btn =>
        btn.classList.remove('ring-2', 'ring-sky-400', 'bg-sky-50')
      );
  }

  leftCol.querySelectorAll('.spanish-option').forEach(btn => {
    btn.addEventListener('click', () => {
      if (btn.disabled) return;
      selectedSpanishBtn = btn;
      clearSelections();
      btn.classList.add('ring-2', 'ring-sky-400', 'bg-sky-50');
      status.textContent = 'Ahora haz clic en la traducci√≥n correcta en ingl√©s.';
      status.classList.remove('text-red-600', 'text-emerald-700');
      status.classList.add('text-slate-500');
    });
  });

  rightCol.querySelectorAll('.english-option').forEach(btn => {
    btn.addEventListener('click', () => {
      if (!selectedSpanishBtn || btn.disabled) return;

      const spanishText = selectedSpanishBtn.textContent.trim();
      const englishText = btn.dataset.english;

      const correctPair = wrongItems.find(
        it => it.spanish === spanishText && it.english === englishText
      );

      if (correctPair) {
        selectedSpanishBtn.disabled = true;
        btn.disabled = true;
        selectedSpanishBtn.classList.remove('ring-2', 'ring-sky-400');
        selectedSpanishBtn.classList.add('bg-emerald-50', 'border-emerald-400');
        btn.classList.add('bg-emerald-50', 'border-emerald-400');
        remaining--;
        selectedSpanishBtn = null;
        status.textContent = `‚úî ¬°Bien! Te quedan ${remaining} por emparejar.`;
        status.classList.remove('text-red-600', 'text-slate-500');
        status.classList.add('text-emerald-700');

        if (remaining === 0) {
          status.textContent =
            '‚úî Bloque completado. Puedes pasar al siguiente bloque.';
          buildNextBlockButton(blockIdx);
        }
      } else {
        status.textContent =
          '‚ùå No es la traducci√≥n correcta. Intenta de nuevo.';
        status.classList.remove('text-slate-500', 'text-emerald-700');
        status.classList.add('text-red-600');
        clearSelections();
        selectedSpanishBtn = null;
      }
    });
  });
}

// ---------- Bot√≥n "Siguiente bloque / Terminar vocabulario" ----------

function buildNextBlockButton(blockIdx) {
  const existing = document.getElementById('vocab-next-block');
  if (existing) existing.remove();

  const totalBlocks = vocabState.blocks.length;
  const wrapper = document.createElement('div');
  wrapper.id = 'vocab-next-block';
  wrapper.className = 'pt-4 flex justify-end';

  const isLast = blockIdx === totalBlocks - 1;
  const label = isLast
    ? 'Terminar vocabulario'
    : 'Siguiente bloque de vocabulario ‚Üí';

  const btn = document.createElement('button');
  btn.type = 'button';
  btn.className =
    'px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold';
  btn.textContent = label;

  btn.addEventListener('click', () => {
    vocabState.completedBlocks++;

    if (isLast) {
      let totalCorrect = 0;
      let totalQs = 0;
      (vocabState.scores || []).forEach(s => {
        if (!s) return;
        totalCorrect += s.correct || 0;
        totalQs += s.total || 0;
      });
      const overallPct = totalQs
        ? Math.round((totalCorrect / totalQs) * 100)
        : 0;

      vocabGlobalStatus.innerHTML =
        `‚úî Has completado los 3 bloques de vocabulario. ` +
        `Resultado total: <strong>${totalCorrect} / ${totalQs}</strong> (` +
        `${overallPct}&nbsp;%).`;
      vocabGlobalStatus.classList.remove('text-slate-500', 'text-red-600');
      vocabGlobalStatus.classList.add('text-emerald-700');

      markModuleCompleted(5);
      unlockModuleBtn(6);
      if (nextFrom5Btn) {
        nextFrom5Btn.disabled = false;
        nextFrom5Btn.classList.remove(
          'bg-slate-300',
          'text-slate-600',
          'cursor-not-allowed'
        );
        nextFrom5Btn.classList.add(
          'bg-emerald-600',
          'hover:bg-emerald-700',
          'text-white'
        );
      }
    } else {
      vocabState.currentIndex = blockIdx + 1;
      buildTypingStage(vocabState.currentIndex);
      vocabGlobalStatus.textContent =
        `Bloque ${vocabState.currentIndex + 1} de ${totalBlocks}.`;
    }
  });

  wrapper.appendChild(btn);
  vocabBlockContainer.appendChild(wrapper);
}

// ---------- Reset button ----------

if (resetVocabBtn) {
  resetVocabBtn.addEventListener('click', () => {
    if (!vocabState.pairs.length) {
      loadVocabSet();
      return;
    }
    vocabState.currentIndex = 0;
    vocabState.completedBlocks = 0;
    vocabState.scores = [];
    vocabGlobalStatus.textContent =
      'M√≥dulo reiniciado. Empieza de nuevo con el Bloque 1 de 3.';
    vocabGlobalStatus.classList.remove('text-emerald-700', 'text-red-600');
    vocabGlobalStatus.classList.add('text-slate-500');

    if (nextFrom5Btn) {
      nextFrom5Btn.disabled = true;
      nextFrom5Btn.classList.add(
        'bg-slate-300',
        'text-slate-600',
        'cursor-not-allowed'
      );
      nextFrom5Btn.classList.remove(
        'bg-emerald-600',
        'hover:bg-emerald-700',
        'text-white'
      );
    }

    buildTypingStage(0);
  });
}

// ---------- Load vocab from JSON and initialize ----------

async function loadVocabSet() {
  if (!VOCAB_JSON_URL || !vocabBlockContainer) return;
  try {
    const res = await fetch(VOCAB_JSON_URL);
    const data = await res.json();
    let pairs = extractVocabPairs(data);

    pairs = pairs.slice(0, 30);
    vocabState.pairs = pairs;
    vocabState.scores = [];
    vocabState.currentIndex = 0;
    vocabState.completedBlocks = 0;

    if (!pairs.length) {
      vocabBlockContainer.innerHTML =
        '<p class="text-sm text-red-600">No se encontraron palabras en el archivo de vocabulario.</p>';
      return;
    }

    const blockSize = 10;
    vocabState.blocks = [];
    for (let i = 0; i < 3; i++) {
      const slice = pairs.slice(i * blockSize, (i + 1) * blockSize);
      if (slice.length) {
        vocabState.blocks.push({ index: i, items: slice });
      }
    }

    vocabGlobalStatus.textContent =
      `M√≥dulo de vocabulario listo: ${vocabState.blocks.length} bloques de hasta 10 palabras.`;
    buildTypingStage(0);
  } catch (err) {
    console.error('Error al cargar vocabulario:', err);
    vocabBlockContainer.innerHTML =
      '<p class="text-sm text-red-600">No se pudo cargar el vocabulario (revisa la URL del JSON).</p>';
  }
}


    // Next buttons 1‚Äì4
    for (let i = 1; i <= 4; i++) {
      const nextBtn = document.getElementById('btn-next-from-' + i);
      if (!nextBtn) continue;
      nextBtn.addEventListener('click', () => {
        const target = i + 1;
        const tab = document.querySelector('.module-tab[data-module="' + target + '"]');
        if (tab && !tab.disabled) showModule(target);
      });
    }

    // Module 5 ‚Üí 6
    if (nextFrom5Btn) {
      nextFrom5Btn.addEventListener('click', () => {
        // Solo marcar completado si a√∫n no lo est√° (por si llegan aqu√≠ sin terminar todos los bloques)
        markModuleCompleted(5);
        unlockModuleBtn(6);
        showModule(6);
        markModuleCompleted(6);
      });
    }

    // Sidebar tabs
    document.querySelectorAll('.module-tab').forEach(btn => {
      btn.addEventListener('click', () => {
        const num = Number(btn.dataset.module);
        if (btn.disabled) return;
        showModule(num);
      });
    });

    // "Volver a m√≥dulo X" buttons
    document.querySelectorAll('[data-go-module]').forEach(btn => {
      btn.addEventListener('click', () => {
        const num = Number(btn.dataset.goModule);
        showModule(num);
      });
    });

    // Init
    updateProgress();
    showModule(1);
    loadPracticeSet();
    loadVocabSet();
  </script>
</body>
</html>

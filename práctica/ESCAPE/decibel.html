<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Functional Decibel Meter (Web Audio API)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for the Gauge Visual */
        #gauge-container {
            width: 300px;
            height: 150px;
            position: relative;
            overflow: hidden;
            margin: 20px auto;
            border-radius: 150px 150px 0 0;
            background: #e5e7eb; 
        }
        
        #gauge-mask {
            width: 300px;
            height: 150px;
            position: absolute;
            top: 0;
            left: 0;
            clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
        }
        
        #gauge-fill {
            width: 300px;
            height: 150px;
            position: absolute;
            top: 0;
            left: 0;
            /* Green (quiet) to Yellow (moderate) to Red (loud) */
            background: linear-gradient(to right, #10b981 0%, #facc15 50%, #ef4444 100%);
            transform-origin: 50% 100%;
            transform: rotate(-90deg);
            transition: transform 0.1s linear; /* Faster transition for real-time feel */
        }

        #gauge-mask::after {
            content: "";
            position: absolute;
            top: 10px;
            left: 10px;
            width: 280px;
            height: 140px;
            border-radius: 140px 140px 0 0;
            background: white;
        }

        #needle {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 4px;
            height: 150px;
            background: black;
            transform-origin: bottom center;
            transform: translateX(-50%) rotate(-90deg);
            transition: transform 0.1s linear;
            z-index: 10;
        }

        /* Styles for status messages */
        .status-message {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #4b5563;
        }
    </style>
</head>
<body class="h-screen flex items-center justify-center bg-gray-100">

    <div class="bg-white p-8 rounded-xl shadow-2xl text-center w-full max-w-lg">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Functional Decibel Meter</h1>
        <p class="text-gray-500 mb-6">Measures real sound level using your microphone.</p>

        <div id="gauge-container">
            <div id="gauge-mask">
                <div id="gauge-fill"></div>
            </div>
            <div id="needle"></div>
        </div>

        <div class="my-6">
            <span id="decibel-value" class="text-6xl font-extrabold text-gray-800">
                00.0
            </span>
            <span class="text-3xl font-bold text-gray-600">
                dB
            </span>
        </div>
        
        <div id="status" class="status-message text-red-500">
            Click 'Start' to request microphone access.
        </div>

        <button id="toggle-btn" 
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-200">
            Start Measuring
        </button>
    </div>

    <script>
        // --- DOM Elements ---
        const decibelValueEl = document.getElementById('decibel-value');
        const toggleBtn = document.getElementById('toggle-btn');
        const needleEl = document.getElementById('needle');
        const gaugeFillEl = document.getElementById('gauge-fill');
        const statusEl = document.getElementById('status');
        
        // ADDED: New element to display the phrase!
        const phraseEl = document.createElement('p');
        phraseEl.id = 'phrase-display';
        phraseEl.className = 'text-2xl font-semibold text-gray-700 mt-4';
        document.querySelector('.bg-white').appendChild(phraseEl);

        // --- Constants for Measurement ---
        let audioContext = null;
        let analyser = null;
        let mediaStream = null;
        let rafId = null; // Request Animation Frame ID

        const MIN_DB = 0;
        const MAX_DB = 120; 
        const DB_RANGE = MAX_DB - MIN_DB;
        const INITIAL_DB = 0.0;
        
        let dataArray = null;

        // --- New: Phrase Logic ---
        function getPhraseForDb(db) {
            if (db >= 71) {
                return '¡Ay, que se callen, por favor!';
            } else if (db >= 60) {
                return '¡Bruh?!';
            } else if (db >= 50) {
                return 'Así, así (50-60 dB)';
            } else if (db >= 40) {
                return '¡Perfecto! (40-50 dB)';
            } else { // Below 40 dB
                return 'Ommm... (Silencio)';
            }
        }

        // --- Core Functions ---

        function mapDbToRotation(db) {
            const clampedDb = Math.max(MIN_DB, Math.min(MAX_DB, db));
            const normalized = (clampedDb - MIN_DB) / DB_RANGE;
            return normalized * 180 - 90;
        }

        function calculateRMS(arr) {
            let sumOfSquares = 0;
            for (let i = 0; i < arr.length; i++) {
                sumOfSquares += arr[i] * arr[i];
            }
            return Math.sqrt(sumOfSquares / arr.length);
        }

        function rmsToDb(rms) {
            const referenceRMS = 1; 
            const safeRms = rms > 0 ? rms : 0.0000000001; 
            
            let db = 20 * Math.log10(safeRms / referenceRMS);

            // SPL Offset for humanizing the scale
            const SPL_OFFSET = 95; 
            db = db + SPL_OFFSET;
            
            return db;
        }

        /**
         * Main animation loop to fetch and display the decibel level.
         * MODIFIED to include phrase update.
         */
        function update() {
            analyser.getFloatTimeDomainData(dataArray);

            const rms = calculateRMS(dataArray);
            const db = rmsToDb(rms);
            
            // --- UI Updates ---
            const rotation = mapDbToRotation(db);
            decibelValueEl.textContent = db.toFixed(1);
            needleEl.style.transform = `translateX(-50%) rotate(${rotation}deg)`;
            gaugeFillEl.style.transform = `rotate(${rotation}deg)`;

            // New: Update the phrase based on the dB level
            phraseEl.textContent = getPhraseForDb(db);
            
            // Request the next frame
            rafId = requestAnimationFrame(update);
        }

        // --- State Management (Start/Stop) ---

        async function startMeasuring() {
            try {
                statusEl.textContent = 'Requesting microphone access...';
                
                mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                const source = audioContext.createMediaStreamSource(mediaStream);
                analyser = audioContext.createAnalyser();
                
                analyser.fftSize = 2048; 
                dataArray = new Float32Array(analyser.fftSize);

                source.connect(analyser);
                
                rafId = requestAnimationFrame(update);
                
                // Update UI state
                statusEl.textContent = 'Measuring! Start talking...';
                statusEl.classList.remove('text-red-500');
                statusEl.classList.add('text-green-600');
                toggleBtn.textContent = 'Stop Measuring';
                toggleBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                toggleBtn.classList.add('bg-red-600', 'hover:bg-red-700');

            } catch (err) {
                console.error('Error accessing microphone:', err);
                statusEl.textContent = `Error: Microphone access denied or failed. (${err.name})`;
                statusEl.classList.add('text-red-500');
                toggleBtn.textContent = 'Retry Start';
            }
        }

        function stopMeasuring() {
            cancelAnimationFrame(rafId);
            
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            // Reset UI and phrase
            updateMeterVisual(INITIAL_DB);
            decibelValueEl.textContent = INITIAL_DB.toFixed(1);
            phraseEl.textContent = '...';
            statusEl.textContent = 'Measurement stopped.';
            statusEl.classList.remove('text-green-600');
            statusEl.classList.add('text-red-500');
            toggleBtn.textContent = 'Start Measuring';
            toggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            toggleBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }
        
        function updateMeterVisual(db) {
            const rotation = mapDbToRotation(db);
            needleEl.style.transform = `translateX(-50%) rotate(${rotation}deg)`;
            gaugeFillEl.style.transform = `rotate(${rotation}deg)`;
        }

        // --- Event Listener ---
        toggleBtn.addEventListener('click', () => {
            if (mediaStream) {
                stopMeasuring();
            } else {
                startMeasuring();
            }
        });

        // Initial visual setup
        updateMeterVisual(INITIAL_DB);
        phraseEl.textContent = '...'; // Initial phrase placeholder
    </script>
</body>
</html>

<!doctype html>
<html lang="en">
Â <head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>Capybara Quest Spanish</title>
Â  
Â  Â  <script src="/_sdk/data_sdk.js"></script>
Â  <script src="/_sdk/element_sdk.js"></script>
Â  
Â  <style>
Â  Â  body {
Â  Â  Â  box-sizing: border-box;
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 0;
Â  Â  Â  font-family: 'Comic Sans MS', cursive, sans-serif;
Â  Â  Â  overflow: hidden;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  }

Â  Â  .game-container {
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  Â  position: relative;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  }

Â  Â  .game-header {
Â  Â  Â  padding: 2%;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  z-index: 10;
Â  Â  }

Â  Â  .score-display {
Â  Â  Â  font-size: 1.5em;
Â  Â  Â  font-weight: bold;
Â  Â  }

Â  Â  .level-display {
Â  Â  Â  font-size: 1.2em;
Â  Â  }

Â  Â  .game-area {
Â  Â  Â  flex: 1;
Â  Â  Â  position: relative;
Â  Â  Â  overflow: hidden;
Â  Â  }

Â  Â  .capybara {
Â  Â  Â  width: 80px;
Â  Â  Â  height: 80px;
Â  Â  Â  position: absolute;
Â  Â  Â  bottom: 20%;
Â  Â  Â  transition: left 0.3s ease;
Â  Â  Â  z-index: 5;
Â  Â  }

Â  Â  .word-card {
Â  Â  Â  position: absolute;
Â  Â  Â  padding: 15px 20px;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  font-size: 1.1em;
Â  Â  Â  font-weight: bold;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  /* FIX: Slower animation for reliable collision */
Â  Â  Â  animation: float-down 8s linear; 
Â  Â  Â  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
Â  Â  Â  /* FIX: Ensure cards render above the background */
Â  Â  Â  z-index: 20; 
Â  Â  }

Â  Â  .word-card:hover {
Â  Â  Â  transform: scale(1.1);
Â  Â  }

Â  Â  @keyframes float-down {
Â  Â  Â  from {
Â  Â  Â  Â  top: -10%;
Â  Â  Â  }
Â  Â  Â  to {
Â  Â  Â  Â  top: 110%;
Â  Â  Â  }
Â  Â  }

Â  Â  .start-screen, .game-over-screen {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  z-index: 100;
Â  Â  Â  padding: 5%;
Â  Â  Â  text-align: center;
Â  Â  }

Â  Â  .start-screen h1, .game-over-screen h1 {
Â  Â  Â  font-size: 3em;
Â  Â  Â  margin-bottom: 20px;
Â  Â  }

Â  Â  .start-screen p, .game-over-screen p {
Â  Â  Â  font-size: 1.3em;
Â  Â  Â  margin-bottom: 30px;
Â  Â  Â  max-width: 600px;
Â  Â  }

Â  Â  .btn {
Â  Â  Â  padding: 15px 40px;
Â  Â  Â  font-size: 1.3em;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 25px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-weight: bold;
Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  margin: 10px;
Â  Â  }

Â  Â  .btn:hover {
Â  Â  Â  transform: scale(1.05);
Â  Â  }

Â  Â  .btn:disabled {
Â  Â  Â  opacity: 0.5;
Â  Â  Â  cursor: not-allowed;
Â  Â  }

Â  Â  .hidden {
Â  Â  Â  display: none !important;
Â  Â  }

Â  Â  .feedback {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 50%;
Â  Â  Â  left: 50%;
Â  Â  Â  transform: translate(-50%, -50%);
Â  Â  Â  font-size: 3em;
Â  Â  Â  font-weight: bold;
Â  Â  Â  animation: fade-out 1s ease;
Â  Â  Â  z-index: 50;
Â  Â  Â  pointer-events: none;
Â  Â  }

Â  Â  @keyframes fade-out {
Â  Â  Â  0% {
Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  transform: translate(-50%, -50%) scale(1);
Â  Â  Â  }
Â  Â  Â  100% {
Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  transform: translate(-50%, -50%) scale(1.5);
Â  Â  Â  }
Â  Â  }

Â  Â  .question-display {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 20%;
Â  Â  Â  left: 50%;
Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  font-size: 2em;
Â  Â  Â  font-weight: bold;
Â  Â  Â  padding: 20px 40px;
Â  Â  Â  border-radius: 15px;
Â  Â  Â  text-align: center;
Â  Â  Â  z-index: 10;
Â  Â  Â  max-width: 80%;
Â  Â  }

Â  Â  .leaderboard {
Â  Â  Â  margin-top: 30px;
Â  Â  Â  max-width: 500px;
Â  Â  Â  width: 90%;
Â  Â  }

Â  Â  .leaderboard h3 {
Â  Â  Â  font-size: 1.5em;
Â  Â  Â  margin-bottom: 15px;
Â  Â  }

Â  Â  .leaderboard-entry {
Â  Â  Â  padding: 10px;
Â  Â  Â  margin: 5px 0;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  }

Â  Â  .name-input {
Â  Â  Â  padding: 12px 20px;
Â  Â  Â  font-size: 1.2em;
Â  Â  Â  border: 3px solid;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  width: 300px;
Â  Â  Â  max-width: 90%;
Â  Â  }
Â  </style>
Â  <style>@view-transition { navigation: auto; }</style>
Â  Â </head>
Â <body>
Â  <div class="game-container">
Â  Â <div id="startScreen" class="start-screen">
Â  Â  <h1 id="gameTitle">ðŸŒ´ Capybara Quest: Spanish Adventure ðŸŒ´</h1>
Â  Â  <p id="welcomeMessage">Help the capybara collect the correct Spanish words! Move left and right with arrow keys or A/D keys to catch the falling words.</p><input type="text" id="playerName" class="name-input" placeholder="Enter your name"> <button id="startBtn" class="btn">Start Adventure</button>
Â  Â  <div class="leaderboard" id="startLeaderboard">
Â  Â  Â <h3>Top Adventurers</h3>
Â  Â  Â <div id="startLeaderboardList"></div>
Â  Â  </div>
Â  Â </div>
Â  Â <div id="gameScreen" class="hidden">
Â  Â  <div class="game-header">
Â  Â  Â <div class="level-display">
Â  Â  Â  Level: <span id="levelNum">1</span>
Â  Â  Â </div>
Â  Â  Â <div class="score-display">
Â  Â  Â  Score: <span id="score">0</span>
Â  Â  Â </div>
Â  Â  Â <div class="score-display">
Â  Â  Â  Words: <span id="wordCount">0</span>/75
Â  Â  Â </div>
Â  Â  </div>
Â  Â  <div class="game-area" id="gameArea">
Â  Â  Â <div id="questionDisplay" class="question-display"></div>
Â  Â  Â <div class="capybara" id="capybara" style="left: 45%;">
Â  Â  Â  <svg viewbox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><ellipse cx="50" cy="60" rx="35" ry="25" fill="#8B6914" /> <ellipse cx="50" cy="40" rx="30" ry="22" fill="#A0826D" /> <circle cx="42" cy="35" r="3" fill="#000" /> <circle cx="58" cy="35" r="3" fill="#000" /> <ellipse cx="50" cy="42" rx="4" ry="3" fill="#000" /> <ellipse cx="30" cy="35" rx="8" ry="12" fill="#8B6914" /> <ellipse cx="70" cy="35" rx="8" ry="12" fill="#8B6914" /> <rect x="20" y="75" width="8" height="15" rx="3" fill="#654321" /> <rect x="40" y="75" width="8" height="15" rx="3" fill="#654321" /> <rect x="52" y="75" width="8" height="15" rx="3" fill="#654321" /> <rect x="72" y="75" width="8" height="15" rx="3" fill="#654321" />
Â  Â  Â  </svg>
Â  Â  Â </div>
Â  Â  </div>
Â  Â </div>
Â  Â <div id="gameOverScreen" class="game-over-screen hidden">
Â  Â  <h1>ðŸŽ‰ Adventure Complete! ðŸŽ‰</h1>
Â  Â  <p id="finalScore"></p>
Â  Â  <p id="finalWords"></p><button id="playAgainBtn" class="btn">Play Again</button>
Â  Â  <div class="leaderboard">
Â  Â  Â <h3>Top Adventurers</h3>
Â  Â  Â <div id="leaderboardList"></div>
Â  Â  </div>
Â  Â </div>
Â  </div>
Â  <script>
Â  Â  const defaultConfig = {
Â  Â  Â  background_color: "#87CEEB",
Â  Â  Â  surface_color: "#90EE90",
Â  Â  Â  text_color: "#2C3E50", // Dark color for contrast
Â  Â  Â  primary_action_color: "#FF6B6B",
Â  Â  Â  secondary_action_color: "#4ECDC4",
Â  Â  Â  game_title: "ðŸŒ´ Capybara Quest: Spanish Adventure ðŸŒ´",
Â  Â  Â  welcome_message: "Help the capybara collect the correct Spanish words! Move left and right with arrow keys or A/D keys to catch the falling words.",
Â  Â  Â  start_button_text: "Start Adventure",
Â  Â  Â  font_family: "Comic Sans MS",
Â  Â  Â  font_size: 16
Â  Â  };

Â  Â  const vocabularyWords = [
Â  Â  Â  {spanish: "la tecnologÃ­a", english: "technology", category: "tech"},
Â  Â  Â  {spanish: "la aplicaciÃ³n", english: "application", category: "tech"},
Â  Â  Â  {spanish: "la cÃ¡mara digital", english: "digital camera", category: "tech"},
Â  Â  Â  {spanish: "el canal", english: "TV channel", category: "tech"},
Â  Â  Â  {spanish: "el cargador", english: "charger", category: "tech"},
Â  Â  Â  {spanish: "el control remoto", english: "remote control", category: "tech"},
Â  Â  Â  {spanish: "el correo de voz", english: "voice mail", category: "tech"},
Â  Â  Â  {spanish: "el disco compacto", english: "CD", category: "tech"},
Â  Â  Â  {spanish: "el estÃ©reo", english: "stereo", category: "tech"},
Â  Â  Â  {spanish: "la pantalla tÃ¡ctil", english: "touch screen", category: "tech"},
Â  Â  Â  {spanish: "el radio", english: "radio set", category: "tech"},
Â  Â  Â  {spanish: "el reproductor de CD", english: "CD player", category: "tech"},
Â  Â  Â  {spanish: "el reproductor de MP3", english: "MP3 player", category: "tech"},
Â  Â  Â  {spanish: "el telÃ©fono celular", english: "cell phone", category: "tech"},
Â  Â  Â  {spanish: "el televisor", english: "television set", category: "tech"},
Â  Â  Â  {spanish: "apagar", english: "to turn off", category: "tech"},
Â  Â  Â  {spanish: "funcionar", english: "to work", category: "tech"},
Â  Â  Â  {spanish: "llamar", english: "to call", category: "tech"},
Â  Â  Â  {spanish: "poner", english: "to turn on", category: "tech"},
Â  Â  Â  {spanish: "sonar", english: "to ring", category: "tech"},
Â  Â  Â  {spanish: "descompuesto", english: "not working", category: "tech"},
Â  Â  Â  {spanish: "lento", english: "slow", category: "tech"},
Â  Â  Â  {spanish: "lleno", english: "full", category: "tech"},
Â  Â  Â  {spanish: "el archivo", english: "file", category: "computer"},
Â  Â  Â  {spanish: "la arroba", english: "@ symbol", category: "computer"},
Â  Â  Â  {spanish: "el blog", english: "blog", category: "computer"},
Â  Â  Â  {spanish: "el buscador", english: "browser", category: "computer"},
Â  Â  Â  {spanish: "la computadora portÃ¡til", english: "laptop", category: "computer"},
Â  Â  Â  {spanish: "la conexiÃ³n inalÃ¡mbrica", english: "wireless connection", category: "computer"},
Â  Â  Â  {spanish: "la direcciÃ³n electrÃ³nica", english: "e-mail address", category: "computer"},
Â  Â  Â  {spanish: "la impresora", english: "printer", category: "computer"},
Â  Â  Â  {spanish: "Internet", english: "Internet", category: "computer"},
Â  Â  Â  {spanish: "el mensaje de texto", english: "text message", category: "computer"},
Â  Â  Â  {spanish: "el monitor", english: "computer monitor", category: "computer"},
Â  Â  Â  {spanish: "la pÃ¡gina principal", english: "home page", category: "computer"},
Â  Â  Â  {spanish: "la pantalla", english: "screen", category: "computer"},
Â  Â  Â  {spanish: "el programa de computaciÃ³n", english: "software", category: "computer"},
Â  Â  Â  {spanish: "el ratÃ³n", english: "mouse", category: "computer"},
Â  Â  Â  {spanish: "la red", english: "network", category: "computer"},
Â  Â  Â  {spanish: "el reproductor de DVD", english: "DVD player", category: "computer"},
Â  Â  Â  {spanish: "el sitio web", english: "website", category: "computer"},
Â  Â  Â  {spanish: "el teclado", english: "keyboard", category: "computer"},
Â  Â  Â  {spanish: "borrar", english: "to erase", category: "computer"},
Â  Â  Â  {spanish: "chatear", english: "to chat", category: "computer"},
Â  Â  Â  {spanish: "descargar", english: "to download", category: "computer"},
Â  Â  Â  {spanish: "escanear", english: "to scan", category: "computer"},
Â  Â  Â  {spanish: "grabar", english: "to record", category: "computer"},
Â  Â  Â  {spanish: "guardar", english: "to save", category: "computer"},
Â  Â  Â  {spanish: "imprimir", english: "to print", category: "computer"},
Â  Â  Â  {spanish: "navegar en Internet", english: "to surf the Internet", category: "computer"},
Â  Â  Â  {spanish: "la autopista", english: "highway", category: "car"},
Â  Â  Â  {spanish: "el baÃºl", english: "trunk", category: "car"},
Â  Â  Â  {spanish: "la calle", english: "street", category: "car"},
Â  Â  Â  {spanish: "el capÃ³", english: "hood", category: "car"},
Â  Â  Â  {spanish: "el carro", english: "car", category: "car"},
Â  Â  Â  {spanish: "la circulaciÃ³n", english: "traffic", category: "car"},
Â  Â  Â  {spanish: "el garaje", english: "garage", category: "car"},
Â  Â  Â  {spanish: "la gasolina", english: "gasoline", category: "car"},
Â  Â  Â  {spanish: "la gasolinera", english: "gas station", category: "car"},
Â  Â  Â  {spanish: "la licencia de conducir", english: "driver's license", category: "car"},
Â  Â  Â  {spanish: "la llanta", english: "tire", category: "car"},
Â  Â  Â  {spanish: "el mecÃ¡nico", english: "mechanic", category: "car"},
Â  Â  Â  {spanish: "el navegador GPS", english: "GPS", category: "car"},
Â  Â  Â  {spanish: "el parabrisas", english: "windshield", category: "car"},
Â  Â  Â  {spanish: "la policÃ­a", english: "police", category: "car"},
Â  Â  Â  {spanish: "la velocidad mÃ¡xima", english: "speed limit", category: "car"},
Â  Â  Â  {spanish: "el volante", english: "steering wheel", category: "car"},
Â  Â  Â  {spanish: "arrancar", english: "to start", category: "car"},
Â  Â  Â  {spanish: "arreglar", english: "to fix", category: "car"},
Â  Â  Â  {spanish: "bajar de", english: "to get off of", category: "car"},
Â  Â  Â  {spanish: "conducir", english: "to drive", category: "car"},
Â  Â  Â  {spanish: "estacionar", english: "to park", category: "car"},
Â  Â  Â  {spanish: "llenar el tanque", english: "to fill the tank", category: "car"},
Â  Â  Â  {spanish: "parar", english: "to stop", category: "car"},
Â  Â  Â  {spanish: "revisar el aceite", english: "to check the oil", category: "car"}
Â  Â  ];

Â  Â  let gameState = {
Â  Â  Â  score: 0,
Â  Â  Â  level: 1,
Â  Â  Â  wordsCompleted: 0,
Â  Â  Â  playerPosition: 50,
Â  Â  Â  currentQuestion: null,
Â  Â  Â  activeWords: [],
Â  Â  Â  isPlaying: false,
Â  Â  Â  playerName: ""
Â  Â  };

Â  Â  let leaderboardData = [];
Â  Â  let animationFrameId = null; 

Â  Â  const dataHandler = {
Â  Â  Â  onDataChanged(data) {
Â  Â  Â  Â  leaderboardData = data.sort((a, b) => b.score - a.score).slice(0, 10);
Â  Â  Â  Â  updateLeaderboards();
Â  Â  Â  }
Â  Â  };

Â  Â  // --- Utility and Display Functions ---

Â  Â  function showToast(message) {
Â  Â  Â  const toast = document.createElement('div');
Â  Â  Â  toast.style.position = 'fixed';
Â  Â  Â  toast.style.bottom = '20px';
Â  Â  Â  toast.style.left = '50%';
Â  Â  Â  toast.style.transform = 'translateX(-50%)';
Â  Â  Â  toast.style.backgroundColor = '#333';
Â  Â  Â  toast.style.color = '#fff';
Â  Â  Â  toast.style.padding = '15px 30px';
Â  Â  Â  toast.style.borderRadius = '8px';
Â  Â  Â  toast.style.zIndex = '1000';
Â  Â  Â  toast.style.fontSize = '1.1em';
Â  Â  Â  toast.textContent = message;
Â  Â  Â  document.body.appendChild(toast);
Â  Â  Â  setTimeout(() => toast.remove(), 3000);
Â  Â  }

Â  Â  function showFeedback(text, color) {
Â  Â  Â  const gameArea = document.getElementById('gameArea');
Â  Â  Â  if (!gameArea) return;
Â  Â  Â  
Â  Â  Â  const feedback = document.createElement('div');
Â  Â  Â  feedback.className = 'feedback';
Â  Â  Â  feedback.textContent = text;
Â  Â  Â  feedback.style.color = color;
Â  Â  Â  gameArea.appendChild(feedback);
Â  Â  Â  setTimeout(() => feedback.remove(), 1000);
Â  Â  }

Â  Â  function updateDisplay() {
Â  Â  Â  document.getElementById('score').textContent = gameState.score;
Â  Â  Â  document.getElementById('levelNum').textContent = gameState.level;
Â  Â  Â  document.getElementById('wordCount').textContent = gameState.wordsCompleted;
Â  Â  }

Â  Â  function updateLeaderboards() {
Â  Â  Â  const config = window.elementSdk?.config || defaultConfig;
Â  Â  Â  const startList = document.getElementById('startLeaderboardList');
Â  Â  Â  const endList = document.getElementById('leaderboardList');

Â  Â  Â  const leaderboardHTML = leaderboardData.map((entry, index) => `
Â  Â  Â  Â  <div class="leaderboard-entry" style="background-color: ${config.surface_color || defaultConfig.surface_color}; color: ${config.text_color || defaultConfig.text_color}">
Â  Â  Â  Â  Â  <span>${index + 1}. ${entry.player_name}</span>
Â  Â  Â  Â  Â  <span>${entry.score} pts (${entry.completed_words} words)</span>
Â  Â  Â  Â  </div>
Â  Â  Â  `).join('');

Â  Â  Â  startList.innerHTML = leaderboardHTML || '<p style="color: ' + (config.text_color || defaultConfig.text_color) + '">No scores yet!</p>';
Â  Â  Â  endList.innerHTML = leaderboardHTML || '<p style="color: ' + (config.text_color || defaultConfig.text_color) + '">No scores yet!</p>';
Â  Â  }

Â  Â  // --- Game Mechanics Functions ---

Â  Â  function moveCapybara(delta) {
Â  Â  Â  // Keep player position between 10% and 90%
Â  Â  Â  gameState.playerPosition = Math.max(10, Math.min(90, gameState.playerPosition + delta));
Â  Â  Â  const capybara = document.getElementById('capybara');
Â  Â  Â  // Capybara width is 80px (approx 8% of area). We use (position - 4) to center the element using the position %
Â  Â  Â  capybara.style.left = (gameState.playerPosition - 5) + '%'; 
Â  Â  }

Â  Â  function checkCollision(rect1, rect2) {
Â  Â  Â  return !(rect1.right < rect2.left ||Â 
Â  Â  Â  Â  Â  Â  Â  Â rect1.left > rect2.right ||Â 
Â  Â  Â  Â  Â  Â  Â  Â rect1.bottom < rect2.top ||Â 
Â  Â  Â  Â  Â  Â  Â  Â rect1.top > rect2.bottom);
Â  Â  }

Â  Â  function handleWordClick(wordData) {
Â  Â  Â  if (!gameState.isPlaying || !wordData.element.parentElement) return;

Â  Â  Â  // Determine if a word related to the current question was caught
Â  Â  Â  const isCorrect = wordData.isCorrect && wordData.text === gameState.currentQuestion.spanish;
Â  Â  Â  const isTargetWord = wordData.text === gameState.currentQuestion.spanish;

Â  Â  Â  if (isTargetWord) {
Â  Â  Â  Â  if (isCorrect) {
Â  Â  Â  Â  Â  gameState.score += 10 * gameState.level;
Â  Â  Â  Â  Â  gameState.wordsCompleted++;
Â  Â  Â  Â  Â  showFeedback('âœ“', '#4CAF50');
Â  Â  Â  Â  Â  if (gameState.wordsCompleted % 10 === 0) {
Â  Â  Â  Â  Â  Â  gameState.level++;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // This scenario should only happen if the user clicks a decoy card, not catches one by collision
Â  Â  Â  Â  Â  gameState.score = Math.max(0, gameState.score - 5);
Â  Â  Â  Â  Â  showFeedback('âœ—', '#F44336');
Â  Â  Â  Â  }

Â  Â  Â  Â  // Collision logic means a word was caught, so clear and start next question
Â  Â  Â  Â  gameState.activeWords.forEach(w => w.element.remove());
Â  Â  Â  Â  gameState.activeWords = [];
Â  Â  Â  Â  updateDisplay();
Â  Â  Â  Â  setTimeout(() => nextQuestion(), 1000); 
Â  Â  Â  Â  
Â  Â  Â  } else {
Â  Â  Â  Â  // If user clicks a wrong decoy word
Â  Â  Â  Â  gameState.score = Math.max(0, gameState.score - 5);
Â  Â  Â  Â  showFeedback('âœ—', '#F44336');
Â  Â  Â  Â  updateDisplay();

Â  Â  Â  Â  // Remove only the clicked word
Â  Â  Â  Â  wordData.element.remove();
Â  Â  Â  Â  gameState.activeWords = gameState.activeWords.filter(w => w !== wordData);
Â  Â  Â  }
Â  Â  }

Â  Â  function spawnWord(text, isCorrect) {
Â  Â  Â  if (!gameState.isPlaying) return;

Â  Â  Â  const config = window.elementSdk?.config || defaultConfig;
Â  Â  Â  const gameArea = document.getElementById('gameArea');
Â  Â  Â  
Â  Â  Â  if (!gameArea) return;

Â  Â  Â  const wordCard = document.createElement('div');
Â  Â  Â  wordCard.className = 'word-card';
Â  Â  Â  wordCard.textContent = text;
Â  Â  Â  wordCard.style.left = Math.random() * 80 + 10 + '%';
Â  Â  Â  wordCard.style.backgroundColor = isCorrectÂ 
Â  Â  Â  Â  ? (config.primary_action_color || defaultConfig.primary_action_color)
Â  Â  Â  Â  : (config.secondary_action_color || defaultConfig.secondary_action_color);
Â  Â  Â  
Â  Â  Â  // FIX: Set text color to the theme's text color for high contrast
Â  Â  Â  wordCard.style.color = config.text_color || defaultConfig.text_color; 

Â  Â  Â  const wordData = { element: wordCard, isCorrect, text: text, startTime: Date.now() };
Â  Â  Â  gameState.activeWords.push(wordData);

Â  Â  Â  // Append the new element to the DOM
Â  Â  Â  gameArea.appendChild(wordCard); 

Â  Â  Â  wordCard.addEventListener('click', () => {
Â  Â  Â  Â  if (gameState.isPlaying && gameState.currentQuestion) {
Â  Â  Â  Â  Â  handleWordClick(wordData);
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  function generateWordChoices() {
Â  Â  Â  // Ensure all previous cards are cleared before new ones spawn
Â  Â  Â  gameState.activeWords.forEach(w => w.element.remove());
Â  Â  Â  gameState.activeWords = [];

Â  Â  Â  const correctAnswer = gameState.currentQuestion.spanish;
Â  Â  Â  const wrongAnswers = vocabularyWords
Â  Â  Â  Â  .filter(w => w.spanish !== correctAnswer)
Â  Â  Â  Â  .sort(() => Math.random() - 0.5)
Â  Â  Â  Â  .slice(0, 2)
Â  Â  Â  Â  .map(w => w.spanish);

Â  Â  Â  const allChoices = [
Â  Â  Â  Â  { text: correctAnswer, isCorrect: true },
Â  Â  Â  Â  { text: wrongAnswers[0], isCorrect: false },
Â  Â  Â  Â  { text: wrongAnswers[1], isCorrect: false }
Â  Â  Â  ].sort(() => Math.random() - 0.5);

Â  Â  Â  // CRITICAL FIX: Calling spawnWord directly instead of using setTimeout
Â  Â  Â  allChoices.forEach((choice) => {
Â  Â  Â  Â  spawnWord(choice.text, choice.isCorrect); 
Â  Â  Â  });
Â  Â  }

Â  Â  function nextQuestion() {
Â  Â  Â  if (gameState.wordsCompleted >= 75) {
Â  Â  Â  Â  endGame();
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const randomWord = vocabularyWords[Math.floor(Math.random() * vocabularyWords.length)];
Â  Â  Â  gameState.currentQuestion = randomWord;

Â  Â  Â  const questionDisplay = document.getElementById('questionDisplay');
Â  Â  Â  questionDisplay.textContent = 'Catch the word for: "' + randomWord.english + '"';

Â  Â  Â  generateWordChoices();
Â  Â  }
Â  Â  
Â  Â  function gameLoop() {
Â  Â  Â  if (!gameState.isPlaying) {
Â  Â  Â  Â  if (animationFrameId) cancelAnimationFrame(animationFrameId);
Â  Â  Â  Â  animationFrameId = null;
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const capybara = document.getElementById('capybara');
Â  Â  Â  const capybaraRect = capybara.getBoundingClientRect();

Â  Â  Â  gameState.activeWords = gameState.activeWords.filter(wordData => {
Â  Â  Â  Â  const wordRect = wordData.element.getBoundingClientRect();

Â  Â  Â  Â  // 1. Check if word fell off screen (past the capybara's capture zone)
Â  Â  Â  Â  if (wordRect.top > capybaraRect.bottom) { 
Â  Â  Â  Â  Â  wordData.element.remove();
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  // If the missed word was the correct answer for the current question
Â  Â  Â  Â  Â  if (wordData.isCorrect && wordData.text === gameState.currentQuestion?.spanish) {
Â  Â  Â  Â  Â  Â  showFeedback('Missed Correct Word!', '#FF0000');
Â  Â  Â  Â  Â  Â  gameState.score = Math.max(0, gameState.score - 10);
Â  Â  Â  Â  Â  Â  updateDisplay();

Â  Â  Â  Â  Â  Â  // Clear all remaining words and move to next question
Â  Â  Â  Â  Â  Â  gameState.activeWords.forEach(w => w.element.remove());
Â  Â  Â  Â  Â  Â  gameState.activeWords = [];
Â  Â  Â  Â  Â  Â  setTimeout(() => nextQuestion(), 1000);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  return false; // Remove this word from active list
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. Check for collision with capybara
Â  Â  Â  Â  if (checkCollision(capybaraRect, wordRect)) {
            handleWordClick(wordData);
Â  Â  Â  Â  Â  return false; // Word is handled, filter it out
Â  Â  Â  Â  }

Â  Â  Â  Â  return true; // Keep word active
Â  Â  Â  });

Â  Â  Â  animationFrameId = requestAnimationFrame(gameLoop);
Â  Â  }

Â  Â  // --- Game Flow Functions ---

Â  Â  function startGame() {
Â  Â  Â  const nameInput = document.getElementById('playerName');
Â  Â  Â  if (!nameInput || !nameInput.value.trim()) {
Â  Â  Â  Â  showToast("Please enter your name!");
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  // Reset game state
Â  Â  Â  gameState.playerName = nameInput.value.trim();
Â  Â  Â  gameState.score = 0;
Â  Â  Â  gameState.level = 1;
Â  Â  Â  gameState.wordsCompleted = 0;
Â  Â  Â  gameState.playerPosition = 50;
Â  Â  Â  gameState.isPlaying = true;
Â  Â  Â  gameState.activeWords.forEach(w => w.element.remove());
Â  Â  Â  gameState.activeWords = [];


Â  Â  Â  document.getElementById('startScreen').classList.add('hidden');
Â  Â  Â  document.getElementById('gameScreen').classList.remove('hidden');

Â  Â  Â  updateDisplay();
Â  Â  Â  nextQuestion();

Â  Â  Â  if (!animationFrameId) {
Â  Â  Â  Â  animationFrameId = requestAnimationFrame(gameLoop);
Â  Â  Â  }
Â  Â  }

Â  Â  async function endGame() {
Â  Â  Â  gameState.isPlaying = false;
Â  Â  Â  if (animationFrameId) cancelAnimationFrame(animationFrameId);

Â  Â  Â  gameState.activeWords.forEach(w => w.element.remove());
Â  Â  Â  gameState.activeWords = [];

Â  Â  Â  document.getElementById('finalScore').textContent = `Final Score: ${gameState.score}`;
Â  Â  Â  document.getElementById('finalWords').textContent = `Words Completed: ${gameState.wordsCompleted}/75`;

Â  Â  Â  document.getElementById('gameScreen').classList.add('hidden');
Â  Â  Â  document.getElementById('gameOverScreen').classList.remove('hidden');

Â  Â  Â  if (leaderboardData.length >= 999) {
Â  Â  Â  Â  showToast("Leaderboard limit reached. Your score wasn't saved.");
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const createResult = await window.dataSdk.create({
Â  Â  Â  Â  player_name: gameState.playerName,
Â  Â  Â  Â  current_level: gameState.level,
Â  Â  Â  Â  score: gameState.score,
Â  Â  Â  Â  completed_words: gameState.wordsCompleted,
Â  Â  Â  Â  timestamp: new Date().toISOString()
Â  Â  Â  });

Â  Â  Â  if (!createResult.isOk) {
Â  Â  Â  Â  showToast("Failed to save score to leaderboard");
Â  Â  Â  }
Â  Â  }

Â  Â  function resetGame() {
Â  Â  Â  document.getElementById('gameOverScreen').classList.add('hidden');
Â  Â  Â  document.getElementById('startScreen').classList.remove('hidden');
Â  Â  Â  document.getElementById('playerName').value = gameState.playerName;
Â  Â  }


Â  Â  // --- Initialization and Event Listeners ---

Â  Â  function setupEventListeners() {
Â  Â  Â  // Ensure startBtn exists before attaching listener
Â  Â  Â  const startBtn = document.getElementById('startBtn');
Â  Â  Â  if (startBtn) {
Â  Â  Â  Â  startBtn.addEventListener('click', startGame);
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  // Ensure playAgainBtn exists before attaching listener
Â  Â  Â  const playAgainBtn = document.getElementById('playAgainBtn');
Â  Â  Â  if (playAgainBtn) {
Â  Â  Â  Â  playAgainBtn.addEventListener('click', resetGame);
Â  Â  Â  }

Â  Â  Â  document.addEventListener('keydown', (e) => {
Â  Â  Â  Â  if (!gameState.isPlaying) return;

Â  Â  Â  Â  if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
Â  Â  Â  Â  Â  moveCapybara(-5); 
Â  Â  Â  Â  } else if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
Â  Â  Â  Â  Â  moveCapybara(5);
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }


Â  Â async function initGame() {
    // SDK Initialization skipped due to persistent 404 errors.
    console.log("SDK Initialization skipped due to persistent 404 errors.");
}

Â  Â  Â  await window.elementSdk.init({
Â  Â  Â  Â  defaultConfig,
Â  Â  Â  Â  onConfigChange: async (config) => {
Â  Â  Â  Â  Â  // Apply theme configurations (omitted internal logic for brevity)
Â  Â  Â  Â  Â  const customFont = config.font_family || defaultConfig.font_family;
Â  Â  Â  Â  Â  const baseFontStack = 'cursive, sans-serif';
Â  Â  Â  Â  Â  const baseSize = config.font_size || defaultConfig.font_size;
Â  Â  Â  Â  Â  document.body.style.fontFamily = `${customFont}, ${baseFontStack}`;
Â  Â  Â  Â  Â  document.body.style.backgroundColor = config.background_color || defaultConfig.background_color;

Â  Â  Â  Â  Â  // Apply theme to all elements... (This block is kept as is from your original code)
Â  Â  Â  Â  Â  const gameContainer = document.querySelector('.game-container');
Â  Â  Â  Â  Â  gameContainer.style.backgroundColor = config.background_color || defaultConfig.background_color;
Â  Â  Â  Â  Â  const startScreen = document.getElementById('startScreen');
Â  Â  Â  Â  Â  startScreen.style.backgroundColor = config.background_color || defaultConfig.background_color;
Â  Â  Â  Â  Â  startScreen.style.color = config.text_color || defaultConfig.text_color;
Â  Â  Â  Â  Â  const gameOverScreen = document.getElementById('gameOverScreen');
Â  Â  Â  Â  Â  gameOverScreen.style.backgroundColor = config.background_color || defaultConfig.background_color;
Â  Â  Â  Â  Â  gameOverScreen.style.color = config.text_color || defaultConfig.text_color;
Â  Â  Â  Â  Â  const gameTitle = document.getElementById('gameTitle');
Â  Â  Â  Â  Â  gameTitle.textContent = config.game_title || defaultConfig.game_title;
Â  Â  Â  Â  Â  gameTitle.style.fontSize = `${baseSize * 1.875}px`;
Â  Â  Â  Â  Â  gameTitle.style.color = config.text_color || defaultConfig.text_color;
Â  Â  Â  Â  Â  const welcomeMessage = document.getElementById('welcomeMessage');
Â  Â  Â  Â  Â  welcomeMessage.textContent = config.welcome_message || defaultConfig.welcome_message;
Â  Â  Â  Â  Â  welcomeMessage.style.fontSize = `${baseSize * 0.8125}px`;
Â  Â  Â  Â  Â  const startBtn = document.getElementById('startBtn');
Â  Â  Â  Â  Â  startBtn.textContent = config.start_button_text || defaultConfig.start_button_text;
Â  Â  Â  Â  Â  startBtn.style.backgroundColor = config.primary_action_color || defaultConfig.primary_action_color;
Â  Â  Â  Â  Â  startBtn.style.color = config.background_color || defaultConfig.background_color;
Â  Â  Â  Â  Â  startBtn.style.fontSize = `${baseSize * 0.8125}px`;
Â  Â  Â  Â  Â  const playAgainBtn = document.getElementById('playAgainBtn');
Â  Â  Â  Â  Â  playAgainBtn.style.backgroundColor = config.primary_action_color || defaultConfig.primary_action_color;
Â  Â  Â  Â  Â  playAgainBtn.style.color = config.background_color || defaultConfig.background_color;
Â  Â  Â  Â  Â  playAgainBtn.style.fontSize = `${baseSize * 0.8125}px`;
Â  Â  Â  Â  Â  const nameInput = document.getElementById('playerName');
Â  Â  Â  Â  Â  nameInput.style.borderColor = config.secondary_action_color || defaultConfig.secondary_action_color;
Â  Â  Â  Â  Â  nameInput.style.fontSize = `${baseSize * 0.75}px`;
Â  Â  Â  Â  Â  nameInput.style.color = config.text_color || defaultConfig.text_color;
Â  Â  Â  Â  Â  const scoreDisplays = document.querySelectorAll('.score-display, .level-display');
Â  Â  Â  Â  Â  scoreDisplays.forEach(display => {
Â  Â  Â  Â  Â  Â  display.style.color = config.text_color || defaultConfig.text_color;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  const questionDisplay = document.getElementById('questionDisplay');
Â  Â  Â  Â  Â  questionDisplay.style.backgroundColor = config.surface_color || defaultConfig.surface_color;
Â  Â  Â  Â  Â  questionDisplay.style.color = config.text_color || defaultConfig.text_color;
Â  Â  Â  Â  Â  questionDisplay.style.fontSize = `${baseSize * 1.25}px`;
Â  Â  Â  Â  Â  const leaderboardEntries = document.querySelectorAll('.leaderboard-entry');
Â  Â  Â  Â  Â  leaderboardEntries.forEach(entry => {
Â  Â  Â  Â  Â  Â  entry.style.backgroundColor = config.surface_color || defaultConfig.surface_color;
Â  Â  Â  Â  Â  Â  entry.style.color = config.text_color || defaultConfig.text_color;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  const leaderboardTitles = document.querySelectorAll('.leaderboard h3');
Â  Â  Â  Â  Â  leaderboardTitles.forEach(title => {
Â  Â  Â  Â  Â  Â  title.style.color = config.text_color || defaultConfig.text_color;
Â  Â  Â  Â  Â  Â  title.style.fontSize = `${baseSize * 0.9375}px`;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  },
Â  Â  Â  Â  // mapToCapabilities is omitted for brevity, keeping your original logic intact.
Â  Â  Â  Â  mapToCapabilities: (config) => ({
Â  Â  Â  Â  Â  recolorables: [
Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  get: () => config.background_color || defaultConfig.background_color,
Â  Â  Â  Â  Â  Â  Â  set: (value) => {
Â  Â  Â  Â  Â  Â  Â  Â  window.elementSdk.config.background_color = value;
Â  Â  Â  Â  Â  Â  Â  Â  window.elementSdk.setConfig({ background_color: value });
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  get: () => config.surface_color || defaultConfig.surface_color,
Â  Â  Â  Â  Â  Â  Â  set: (value) => {
Â  Â  Â  Â  Â  Â  Â  Â  window.elementSdk.config.surface_color = value;
Â  Â  Â  Â  Â  Â  Â  Â  window.elementSdk.setConfig({ surface_color: value });
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  get: () => config.text_color || defaultConfig.text_color,
Â  Â  Â  Â  Â  Â  Â  set: (value) => {
Â  Â  Â  Â  Â  Â  Â  Â  window.elementSdk.config.text_color = value;
Â  Â  Â  Â  Â  Â  Â  Â  window.elementSdk.setConfig({ text_color: value });
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  get: () => config.primary_action_color || defaultConfig.primary_action_color,
Â  Â  Â  Â  Â  Â  Â  set: (value) => {
Â  Â  Â  Â  Â  Â  Â  Â  window.elementSdk.config.primary_action_color = value;
Â  Â  Â  Â  Â  Â  Â  Â  window.elementSdk.setConfig({ primary_action_color: value });
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
Â  Â  Â  Â  Â  Â  Â  set: (value) => {
Â  Â  Â  Â  Â  Â  Â  Â  window.elementSdk.config.secondary_action_color = value;
Â  Â  Â  Â  Â  Â  Â  Â  window.elementSdk.setConfig({ secondary_action_color: value });
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  ],
Â  Â  Â  Â  Â  borderables: [],
Â  Â  Â  Â  Â  fontEditable: {
Â  Â  Â  Â  Â  Â  get: () => config.font_family || defaultConfig.font_family,
Â  Â  Â  Â  Â  Â  set: (value) => {
Â  Â  Â  Â  Â  Â  Â  window.elementSdk.config.font_family = value;
Â  Â  Â  Â  Â  Â  Â  window.elementSdk.setConfig({ font_family: value });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  fontSizeable: {
Â  Â  Â  Â  Â  Â  get: () => config.font_size || defaultConfig.font_size,
Â  Â  Â  Â  Â  Â  set: (value) => {
Â  Â  Â  Â  Â  Â  Â  window.elementSdk.config.font_size = value;
Â  Â  Â  Â  Â  Â  Â  window.elementSdk.setConfig({ font_size: value });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }),
Â  Â  Â  Â  mapToEditPanelValues: (config) => new Map([
Â  Â  Â  Â  Â  ["game_title", config.game_title || defaultConfig.game_title],
Â  Â  Â  Â  Â  ["welcome_message", config.welcome_message || defaultConfig.welcome_message],
Â  Â  Â  Â  Â  ["start_button_text", config.start_button_text || defaultConfig.start_button_text]
Â  Â  Â  Â  ])
Â  Â  Â  });
Â  Â  }

    // Start initialization and set up listeners AFTER the entire HTML structure is loaded
    document.addEventListener('DOMContentLoaded', () => {
        setupEventListeners();
        initGame(); 
    });
Â  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calentamiento Diario</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
    .animate-pop { animation: popIn 0.4s ease-out forwards; }
    /* Added styles for the exercise cards */
    .exercise-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20">

  <header class="sticky top-0 z-50 bg-white border-b border-slate-200 shadow-sm">
    <div class="max-w-5xl mx-auto px-4 py-3">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div class="flex-grow">
          <div class="flex items-center gap-2 mb-1">
            <h1 class="text-xl font-black text-slate-800 tracking-tight">CALENTAMIENTO</h1>
            <span id="activity-date" class="px-2 py-0.5 rounded text-xs font-bold bg-indigo-100 text-indigo-700 uppercase tracking-wide">HOY</span>
          </div>
          <h2 id="current-topic" class="text-slate-500 text-sm font-medium">Cargando...</h2>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-8">
    <div id="module-container" class="space-y-4">
      <div class="flex flex-col items-center justify-center h-64 text-slate-400">
        <svg class="animate-spin h-8 w-8 text-indigo-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <p>Cargando ejercicio...</p>
      </div>
    </div>
  </main>

<script>

const BASE_URL = "https://raw.githubusercontent.com/scottscalici/imagenes/main/";

// Global State to manage the "Brain" and UI
const runtime = {
    course: new URLSearchParams(window.location.search).get('course') || 's2',
    verbs: [],
    vocab: [],
    title: ""
};

async function init() {
    try {
        // 1. Fetch Schedule from GitHub
        const scheduleRes = await fetch(`${BASE_URL}calentamiento/schedule_${runtime.course}.json`);
        const schedule = await scheduleRes.json();

        // 2. Logic: Find most recent past or present entry
        const todayStr = new Date().toISOString().split('T')[0];
        const available = schedule.filter(e => e.date <= todayStr)
                                  .sort((a, b) => b.date.localeCompare(a.date));
        const entry = available[0];

        if (!entry) {
            showTopStatus("No hay actividades programadas.", "err");
            return;
        }

        // 3. Fetch Identity "Brain" and Verb Bank
        const [manifest, bank] = await Promise.all([
            fetch(`${BASE_URL}calentamiento/verbs_identity.json`).then(r => r.json()),
            fetch(`${BASE_URL}calentamiento/${entry.bank}`).then(r => r.json())
        ]);

        // 4. Select Verbs based on Identity Groups
        let targetList = [];
        const groups = entry.identityGroups || [entry.identityGroup];
        groups.forEach(g => {
            if (manifest[entry.identityCategory][g]) {
                targetList = targetList.concat(manifest[entry.identityCategory][g]);
            }
        });

        // Filter and pick 20 random verbs
        runtime.verbs = bank.filter(q => targetList.includes(q.infinitivo))
                            .sort(() => 0.5 - Math.random())
                            .slice(0, 20);

        // 5. Fetch Vocab and fix "undefined" mapping
        const vocabRes = await fetch(`${BASE_URL}calentamiento/${entry.vocabFile}`);
        const vocabData = await vocabRes.json();
        const rawVocab = Array.isArray(vocabData) ? vocabData : (vocabData.items || vocabData.vocabulario || []);
        
        runtime.vocab = rawVocab.map(v => ({ 
            spanish: v.spanish || v.es || v.palabra || v.word || "", 
            english: v.english || v.en || v.traducción || v.translation || "" 
        })).filter(v => v.spanish && v.english).slice(0, 30);

        // Update Headers
        runtime.title = entry.topic;
        applyHeader(entry);

        // Populate Modules and stop spinning
        populateVerbModules();
        loadVocabSet(); // Connects to your existing Módulo 2 logic
        
        showModule(1);
        updateProgress();
        hideTopStatus(); 
    } catch (err) {
        showTopStatus("Error: " + err.message, "err");
    }
}

function populateVerbModules() {
    // Distribute 20 verbs into 4 modules (5 each)
    for (let m = 1; m <= 4; m++) {
        const slice = runtime.verbs.slice((m - 1) * 5, m * 5);
        const container = document.getElementById(`module-${m}-questions`);
        if (!container) continue;

        container.innerHTML = slice.map((v, i) => `
            <div class="space-y-1 quiz-item" data-answer="${v.forma}">
                <label class="text-sm font-medium text-slate-800">
                    ${i + 1}. ${v.sujeto} <span class="text-indigo-600">(${v.infinitivo} | ${v.tiempo || 'presente'})</span>
                </label>
                <input type="text" class="w-full border rounded-lg px-3 py-1.5 text-sm focus:ring-2 focus:ring-sky-400 outline-none" />
                <p class="text-xs feedback hidden"></p>
            </div>
        `).join('');
        attachQuizHandler(m); // Re-attach listeners to new inputs
    }
}

function applyHeader(entry) {
    document.getElementById("pageTitle").textContent = runtime.title;
    document.getElementById("pageSubtitle").textContent = entry.topic;
    document.getElementById("pageMeta").textContent = `ID: ${entry.date} · Curso: ${runtime.course.toUpperCase()}`;
}

// Start the engine
init();
  
</script>
</body>
</html>

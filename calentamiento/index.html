<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calentamiento Diario</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
    .animate-pop { animation: popIn 0.4s ease-out forwards; }
    /* Added styles for the exercise cards */
    .exercise-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20">

  <header class="sticky top-0 z-50 bg-white border-b border-slate-200 shadow-sm">
    <div class="max-w-5xl mx-auto px-4 py-3">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div class="flex-grow">
          <div class="flex items-center gap-2 mb-1">
            <h1 class="text-xl font-black text-slate-800 tracking-tight">CALENTAMIENTO</h1>
            <span id="activity-date" class="px-2 py-0.5 rounded text-xs font-bold bg-indigo-100 text-indigo-700 uppercase tracking-wide">HOY</span>
          </div>
          <h2 id="current-topic" class="text-slate-500 text-sm font-medium">Cargando...</h2>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-8">
    <div id="module-container" class="space-y-4">
      <div class="flex flex-col items-center justify-center h-64 text-slate-400">
        <svg class="animate-spin h-8 w-8 text-indigo-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <p>Cargando ejercicio...</p>
      </div>
    </div>
  </main>

<script>
/***********************
 * CONFIGURACIÓN Y ESTADO
 ***********************/
const BASE_URL = "https://raw.githubusercontent.com/scottscalici/imagenes/main/";
const TOTAL_MODULES = 6;
const PASS_THRESHOLD = 0.5;

const modulePassed = {};
let completedModules = 0;

// Objeto de ejecución que guardará los datos del horario
const runtime = {
  course: 's2',
  title: "Calentamiento",
  verbsUrl: "",
  vocabUrl: "",
  verbsLabel: "",
  vocabLabel: "Vocabulario",
  totalNeeded: 20
};

/***********************
 * INICIALIZACIÓN (LOGICA DE HORARIO)
 ***********************/
async function init() {
  const urlParams = new URLSearchParams(window.location.search);
  runtime.course = urlParams.get('course') || 's2';
  
  updateProgress();
  showModule(1);
  wireNavigation();

  try {
    // 1. Cargar el horario (S2 o S4)
    const res = await fetch(`${BASE_URL}calentamiento/schedule_${runtime.course}.json`);
    const schedule = await res.json();

    // 2. Lógica de "Fecha Pasada": Buscar hoy o el último día anterior
    const todayStr = new Date().toISOString().split('T')[0];
    const available = schedule.filter(entry => entry.date <= todayStr);
    available.sort((a, b) => b.date.localeCompare(a.date));
    
    const entry = available[0];

    if (!entry) {
      showTopStatus("No hay actividades programadas para hoy.", "err");
      return;
    }

    // Configurar runtime con los datos del horario
    runtime.title = entry.topic;
    runtime.verbsUrl = `${BASE_URL}calentamiento/${entry.bank}`;
    runtime.vocabUrl = `${BASE_URL}calentamiento/${entry.vocabFile}`;
    runtime.verbsLabel = entry.topic;
    runtime.totalNeeded = entry.totalNeeded || 20;

    applyHeaderFromRuntime();

    // 3. Cargar Verbos usando la identidad
    await loadPracticeSet(entry);
    
    // 4. Cargar Vocabulario
    await loadVocabSet();

  } catch (err) {
    showTopStatus(`Error al iniciar: ${err.message}`, "err");
  }
}

/***********************
 * CARGA DE VERBOS (Identidad + Banco)
 ***********************/
async function loadPracticeSet(entry) {
  try {
    // A. Obtener Manifiesto
    const manifest = await getJSON(`${BASE_URL}calentamiento/verbs_identity.json`);
    const groups = entry.identityGroups || [entry.identityGroup];
    const category = manifest[entry.identityCategory];
    
    let targetVerbs = [];
    groups.forEach(g => { if(category[g]) targetVerbs = targetVerbs.concat(category[g]); });

    // B. Obtener Banco y Filtrar
    const bank = await getJSON(runtime.verbsUrl);
    const filtered = bank.filter(q => targetVerbs.includes(q.infinitivo));
    
    // Mezclar y tomar los necesarios
    const finalVerbs = filtered.sort(() => 0.5 - Math.random()).slice(0, runtime.totalNeeded);

    if (!finalVerbs.length) throw new Error("No se encontraron verbos que coincidan con los grupos.");

    // C. Distribuir en módulos 1.1 a 1.4
    buildAllVerbModules(finalVerbs);
    [1, 2, 3, 4].forEach(attachQuizHandler);

  } catch (err) {
    showTopStatus(`Error Verbos: ${err.message}`, "err");
  }
}

function buildVerbModule(moduleNumber, items) {
  const container = document.getElementById(`module-${moduleNumber}-questions`);
  if (!container) return;
  container.innerHTML = "";

  items.forEach((item, index) => {
    const wrapper = document.createElement("div");
    wrapper.className = "space-y-1 quiz-item";
    wrapper.dataset.answer = item.forma;

    // Fix: Añadido item.tiempo para mostrar el tiempo verbal
    const etiquetaVerbal = `${item.infinitivo} | ${item.tiempo || 'presente'}`;
    const traduccion = item.traducción ? ` — ${item.traducción}` : "";

    wrapper.innerHTML = `
      <label class="text-sm font-medium text-slate-800">
        ${index + 1}. <span class="text-indigo-600 font-bold">${item.sujeto}</span> 
        <span class="text-slate-500 font-normal">(${etiquetaVerbal}${traduccion})</span>
      </label>
      <input type="text" class="w-full border rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400" />
      <p class="text-xs feedback hidden"></p>
    `;
    container.appendChild(wrapper);
  });
}

/***********************
 * CARGA DE VOCABULARIO
 ***********************/
function extractVocabPairs(data) {
  let raw = Array.isArray(data) ? data : (data.items || data.vocabulario || []);
  return raw.map(entry => ({
    // Fix: Se añadieron 'word' y 'translation' para evitar el error "undefined"
    spanish: entry.spanish || entry.es || entry.palabra || entry.word || "",
    english: entry.english || entry.en || entry.ingles || entry.traducción || entry.translation || ""
  })).filter(p => p.spanish && p.english);
}

// ... (Mantenemos las funciones buildAllVerbModules, attachQuizHandler, y el sistema de Vocab de tu plantilla) ...
// (Asegúrate de que buildAllVerbModules use items.slice para repartir los 20 verbos en grupos de 5)

function buildAllVerbModules(items) {
  const chunkSize = 5; 
  for (let moduleNum = 1; moduleNum <= 4; moduleNum++) {
    const start = (moduleNum - 1) * chunkSize;
    const slice = items.slice(start, start + chunkSize);
    if (slice.length > 0) buildVerbModule(moduleNum, slice);
  }
}

// ... (Resto de funciones de utilidad: showModule, updateProgress, getJSON, etc.) ...

function applyHeaderFromRuntime() {
  document.getElementById("pageTitle").textContent = runtime.title;
  document.getElementById("pageSubtitle").textContent = `Curso: ${runtime.course.toUpperCase()}`;
  document.getElementById("pageMeta").textContent = `Verbos: ${runtime.verbsLabel}`;
}

async function getJSON(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(`No se pudo cargar: ${url}`);
  return await res.json();
}

// Inicializar
init();
</script>
</body>
</html>

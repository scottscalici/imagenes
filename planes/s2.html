<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Espa√±ol 2 - Plan de Clase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Mountains+of+Christmas:wght@700&family=Berkshire+Swash&family=Creepster&display=swap" rel="stylesheet">
    <style>
        #headerDate {
    font-family: inherit; /* This makes it follow the heading font */
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-weight: 800;
}
        body { font-family: 'Inter', sans-serif; }
        
        
        /* NEW: Support for dynamic textures and fonts */
        .card-texture {
            background-repeat: no-repeat;
            background-position: bottom right 10px;
            background-size: 80px;
            /* Ensures text stays readable over the background image */
            background-blend-mode: multiply;
        }

        .font-activity {
            font-family: var(--activity-font, 'Inter', sans-serif) !important;
        }

        .card-shadow { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .animate-pronto { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .7; } }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen pb-20">
    <canvas id="snow-canvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50;"></canvas>
    
    <main class="max-w-6xl mx-auto px-4 py-8 space-y-6">
      <header class="bg-[#79c9f2] rounded-xl p-6 text-white flex justify-between items-center shadow-md">
    <div>
        <h1 id="dayTitle" class="text-4xl font-extrabold tracking-tight uppercase text-white">D√≠a ‚Äî</h1>
        <p id="headerDate" class="text-sm opacity-90 font-bold uppercase tracking-widest mt-1"></p>
    </div>

    <div class="text-right hidden sm:block">
        <span class="text-xs font-bold uppercase tracking-widest bg-white/20 px-4 py-2 rounded-full border border-white/10">
            Espa√±ol 2
        </span>
    </div>
</header>
        
        <div id="heroSlot" class="hidden mb-6">
            <div id="heroCard" class="bg-white rounded-xl overflow-hidden shadow-md flex flex-col md:flex-row border-t-8">
                <div class="md:w-1/3 h-48 bg-slate-100">
                    <img id="heroImg" src="" class="w-full h-full object-cover">
                </div>
                <div class="p-8 flex items-center justify-center flex-grow text-center">
                    <h2 id="heroMsg" class="text-3xl font-black italic text-slate-800"></h2>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
            <div class="lg:col-span-2 space-y-6">
                <section id="evalSection" class="bg-white rounded-xl border-l-[6px] border-emerald-500 p-6 card-shadow">
                    <h2 class="text-emerald-600 font-bold text-xl mb-3 flex items-center gap-2"><span>üìã</span> Evaluaci√≥n</h2>
                    <div id="currentEval" class="text-lg text-slate-800 font-medium italic mb-4"></div>
                    <div class="pt-4 border-t border-slate-100">
                        <h3 class="text-slate-900 font-bold text-sm mb-2 uppercase tracking-wide">Pr√≥ximas pruebas</h3>
                        <ul id="nextEvals" class="space-y-1 text-sm text-slate-600"></ul>
                    </div>
                </section>

                <section id="calentamientoSection" class="bg-white rounded-xl border-l-[6px] border-red-500 p-6 card-shadow">
                    <div class="flex justify-between items-start mb-3">
                        <h2 class="text-red-600 font-bold text-xl">üî• Calentamiento</h2>
                        <a id="calBtn" href="#" target="_blank" class="bg-red-50 text-red-600 text-[10px] font-bold px-3 py-1.5 rounded-lg border border-red-100 hover:bg-red-100 transition-colors uppercase">Pr√°ctica Interactiva ‚Üó</a>
                    </div>
                    <div id="calDetail" class="text-slate-700 text-md">Pr√°ctica interactiva para empezar la clase.</div>
                </section>

                <div id="curiosityBlock"></div>
                <div id="estructuraBlock"></div>
                <div id="extrasBlock"></div> 
            </div>

            <div id="tareasColumn" class="space-y-6">
                <div id="tareasBox" class="bg-blue-50 rounded-xl p-6 shadow-md border-8 border-black">
                    <h3 class="text-blue-700 font-bold text-lg mb-4 flex items-center gap-2">
                        <span>üìù</span> Tareas Pendientes
                    </h3>
                    <div id="tareasList" class="space-y-4"></div>
                </div>

                <div id="evalSidebarBlock" class="bg-emerald-50 rounded-xl p-6 shadow-md border-8 border-emerald-500">
                    <h3 class="text-emerald-700 font-bold text-lg mb-4 flex items-center gap-2">
                        <span>üìÖ</span> Pr√≥ximas Pruebas
                    </h3>
                    <div id="sidebarEvalList" class="space-y-3 mb-4"></div>
                    <a href="https://sites.google.com/view/srscalici/espa%C3%B1ol-2/evaluaciones" target="_blank" 
                       class="block text-center py-2 bg-emerald-600 text-white rounded-lg font-bold text-xs hover:bg-emerald-700 transition-colors">
                        Ver calendario completo
                    </a>
                </div>

                <div class="bg-slate-50 rounded-xl overflow-hidden shadow-md border-8 border-slate-300 flex flex-col group">
                    <div class="h-28 overflow-hidden p-2"> 
                        <img id="tutorMascot" src="https://raw.githubusercontent.com/scottscalici/imagenes/refs/heads/main/se%C3%B1or%2B.png" class="w-full h-full object-contain"> 
                    </div>
                    <div class="p-4 flex flex-col flex-grow bg-white">
                        <h3 class="text-slate-900 font-bold text-md mb-2 italic text-center">Se√±or+ AI Tutor</h3>
                        <a href="https://student.schoolai.com/dot/spaces/join?code=AWSM-S4EM" target="_blank" class="bg-slate-700 text-white text-center py-2 rounded-lg font-bold text-xs hover:bg-slate-800 transition-colors">Practicar ahora</a>
                    </div>
                </div>
            </div> 
        </div> 

        <div id="resourceDashboard" class="max-w-6xl mx-auto mt-12 pt-8 border-t-2 border-dashed border-slate-200">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 items-stretch">
                <div id="grammarPlacement" class="col-span-1 md:col-span-2 lg:col-span-3">
                    <h2 class="text-slate-400 font-black text-2xl uppercase tracking-widest mb-6 text-center lg:text-left">Gram√°tica</h2>
                    <div id="grammarResources" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>
                <div class="lg:col-span-3 mt-8">
                    <h2 class="text-slate-400 font-black text-2xl uppercase tracking-widest mb-6 text-center lg:text-left">Recursos y Enlaces</h2>
                </div>
                <div id="vocabPlacement"></div>
                <div class="bg-white rounded-xl overflow-hidden shadow-md border border-slate-100 flex flex-col h-full hover:shadow-lg transition-shadow">
                    <div class="h-32 p-4 bg-slate-50 flex items-center justify-center border-b border-slate-100">
                        <img src="https://raw.githubusercontent.com/scottscalici/imagenes/refs/heads/main/planes/images/MISD.png" class="max-w-[150px] object-contain">
                    </div>
                    <div class="p-5 flex flex-col flex-grow justify-between">
                        <h3 class="text-slate-900 font-bold text-lg mb-4">Ayuda con la vida (MISD)</h3>
                        <a href="https://connection.misd.net/index.html" target="_blank" class="w-full bg-slate-800 text-white text-center py-2.5 rounded-lg font-bold text-sm hover:bg-black transition-colors">Abrir Portal</a>
                    </div>
                </div>
                <div class="bg-emerald-50 rounded-xl overflow-hidden shadow-md border border-emerald-100 flex flex-col h-full hover:shadow-lg transition-shadow">
                    <div class="h-32 overflow-hidden border-b border-emerald-100">
                        <img id="slothMascot" src="https://raw.githubusercontent.com/scottscalici/imagenes/refs/heads/main/sloth_orig.jpg" class="w-full h-full object-cover">
                    </div>
                    <div class="p-5 flex flex-col flex-grow justify-between">
                        <h3 class="text-emerald-800 font-bold text-lg mb-4">Costa Rica 2027</h3>
                        <a href="https://senoraburak.weebly.com/costa-rica-2027.html" target="_blank" class="w-full bg-emerald-600 text-white text-center py-2.5 rounded-lg font-bold text-sm hover:bg-emerald-700 transition-colors">Ver Detalles</a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="max-w-4xl mx-auto mb-8">
    <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-4 shadow-sm border border-slate-200 flex flex-wrap items-center justify-center gap-6">
        
        <div class="flex items-center gap-3">
            <label class="text-[10px] font-black uppercase tracking-wider text-slate-400">D√≠a Plan</label>
            <div class="flex items-center">
                <input type="number" id="diaInput" 
                    class="w-16 bg-slate-100 border-none rounded-l-lg px-3 py-2 font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 text-center">
                <button onclick="renderManual()" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-r-lg font-bold text-sm transition-colors">
                    Cargar
                </button>
            </div>
        </div>

        <div class="hidden md:block w-px h-8 bg-slate-200"></div>

        <div class="flex items-center gap-3">
            <label class="text-[10px] font-black uppercase tracking-wider text-slate-400">Ir a Fecha</label>
            <input type="date" id="datePicker" 
                class="bg-slate-100 border-none rounded-lg px-3 py-2 font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 text-sm">
        </div>

    </div>
</div>
    </main>
<script>
const CONFIG = {
    COURSE: "s2",
    CICLO_FILTER: "B",
    PLAN: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/plan_s2.json",
    EVALS: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/evaluaciones.json",
    CALENDARIO: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/calendario.json",
    CURIOSIDADES: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/curiosidades.json",
    TAREAS: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/tareas.json",
    VOCAB_BANK: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/vocabulario.json",
    APUNTES_BANK: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/apuntes.json",
    EXTRAS: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/extras.json",
    CAL_BASE: "https://sites.google.com/view/srscalici/espa%C3%B1ol-2/calentamiento",
    MUSICA: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/musica.json",
    LECTURA: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/lectura.json",
    CULTURA: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/cultura.json",
    CONV: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/conversaciones.json",
    TEMAS: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/temas.json"
};
    
// --- THEME ENGINE ---
async function applyTheme(data, currentDia) {
    try {
        const themeRes = await fetch(CONFIG.TEMAS + "?t=" + Date.now());
        const themeData = await themeRes.json();
        
        // 1. Get the specific calendar entry for the DAY being viewed
        const dayEntry = data.cal?.map?.find(c => c.dia == currentDia && c.ciclo === CONFIG.CICLO_FILTER);
        if (!dayEntry) return;

        // 2. This is the date we care about (the date that 'D√≠a X' actually happened)
        const viewedDate = dayEntry.fecha; 
        const dateParts = viewedDate.split('-'); // [2026, 01, 15]
        const compareMD = `${dateParts[1]}-${dateParts[2]}`; // "01-15"

        let theme;

        // 3. Priority: Did THAT specific date have a "Snow day" note?
        // Note: This requires the Snow Day entry in calendario.json to have the same "dia" number 
        // OR we check the date directly.
        const specificDateEntry = data.cal?.map?.find(c => c.fecha === viewedDate);
        if (specificDateEntry && specificDateEntry.note === "Snow day") {
            theme = themeData.themes.find(t => t.id === 'snowday');
        }

        // 4. Fallback: Seasonal theme based on the viewed date
        if (!theme) {
            theme = themeData.themes.find(t => t.start && compareMD >= t.start && compareMD <= t.end) 
                    || themeData.themes.find(t => t.id === 'classic');
        }

        if (!theme) return;
        // ... rest of your font/style code ...
            
        if (theme.styles.fonts) {
            Object.values(theme.styles.fonts).forEach(font => {
                const fontId = 'font-' + font.replace(/\s+/g, '-').toLowerCase();
                if (!document.getElementById(fontId)) {
                    const link = document.createElement('link');
                    link.id = fontId;
                    link.rel = 'stylesheet';
                    link.href = `https://fonts.googleapis.com/css2?family=${font.replace(/'/g, '').replace(/\s+/g, '+')}&display=swap`;
                    document.head.appendChild(link);
                }
            });
        }

        const overrides = theme.styles.cardOverrides || {};
        const accent = theme.styles.accent || "#60a5fa";

        const header = document.querySelector('header');
        if (header) header.className = `rounded-xl p-6 text-white flex justify-between items-center shadow-md transition-all duration-700 ${theme.styles.header}`;
        
        const dayTitle = document.getElementById('dayTitle');
        const headerDate = document.getElementById('headerDate');
        if (dayTitle) dayTitle.style.fontFamily = theme.styles.fontHeading || 'inherit';
        if (headerDate) headerDate.style.fontFamily = theme.styles.fontHeading || 'inherit';

        const heroSlot = document.getElementById('heroSlot');
        if (theme.hero && theme.hero.active) {
            heroSlot.classList.remove('hidden');
            document.getElementById('heroImg').src = theme.hero.img;
            document.getElementById('heroMsg').textContent = theme.hero.msg;
            document.getElementById('heroCard').style.borderTopColor = accent;
        } else {
            heroSlot.classList.add('hidden');
        }

        document.querySelectorAll('section, article, .card-shadow').forEach(el => {
            const text = el.innerText || "";
            let targetColor = accent; 
            let type = "";

            if (text.includes("Evaluaci√≥n") || el.id === "evalSection") { targetColor = overrides.evaluacion || accent; type = "evaluacion"; }
            else if (text.includes("Calentamiento") || el.id === "calentamientoSection") { targetColor = overrides.calentamiento || accent; type = "calentamiento"; }
            else if (text.includes("Curiosidad")) { targetColor = overrides.curiosidad || accent; type = "curiosidad"; }
            else if (text.includes("M√∫sica")) { targetColor = overrides.musica || accent; type = "musica"; }
            else if (text.includes("Conversaci√≥n") || text.includes("Chat")) { targetColor = overrides.conversacion || accent; type = "conversacion"; }
            else if (text.includes("Cultura")) { targetColor = overrides.cultura || accent; type = "cultura"; }
            else if (text.includes("Lectura")) { targetColor = overrides.lectura || accent; type = "lectura"; }
            else if (text.includes("‚ú®") || text.includes("Extras")) { targetColor = overrides.extras || accent; type = "extras"; }
            else if (el.closest('#estructuraBlock') || text.includes("‚öôÔ∏è")) { targetColor = overrides.estructura || accent; type = "estructura"; }
            else if (el.id === "tareasBox") { targetColor = overrides.tareas || accent; type = "tareas"; }
            else if (el.id === "evalSidebarBlock") { targetColor = overrides.pruebas || accent; type = "pruebas"; }

            el.style.setProperty('border-left-color', targetColor, 'important');
            const heading = el.querySelector('h2, h3');
            if (heading) {
                heading.style.color = targetColor;
                heading.style.fontFamily = (type && theme.styles.fonts?.[type]) ? theme.styles.fonts[type] : (theme.styles.fontHeading || 'inherit');
            }
            if (type && theme.styles.textures?.[type]) {
                el.style.backgroundImage = `url('${theme.styles.textures[type]}')`;
                el.classList.add('card-texture');
            } else {
                el.style.backgroundImage = 'none';
            }
        });

        if (theme.effectConfig) startEffect(theme.effectConfig);
        else stopEffect();

    } catch (e) { console.error("Theme Engine Error:", e); }
}

// --- PARTICLE ENGINE ---
let effectInterval;
function startEffect(config) {
    const canvas = document.getElementById('snow-canvas');
    if (!canvas || !config || config.type === 'none') return stopEffect();
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const particles = Array.from({ length: config.count || 80 }, () => ({
        x: Math.random() * canvas.width, y: Math.random() * canvas.height,
        size: Math.random() * 15 + 10, drift: Math.random() * 2 - 1, opacity: Math.random() * 0.5 + 0.3
    }));
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = config.color || "white";
        particles.forEach(p => {
            ctx.font = `${p.size}px serif`; ctx.globalAlpha = p.opacity;
            ctx.fillText(config.char || "‚ùÑ", p.x, p.y);
        });
        particles.forEach(p => {
            p.y += (config.speed || 1) + (p.size / 10);
            if (p.y > canvas.height) p.y = -20;
            p.x += p.drift;
        });
    }
    if (effectInterval) clearInterval(effectInterval);
    effectInterval = setInterval(draw, 30);
}
function stopEffect() {
    const canvas = document.getElementById('snow-canvas');
    if (canvas) canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
    if (effectInterval) clearInterval(effectInterval);
}

// --- CORE RENDERING ENGINE ---
function formatSpanishDate(dateStr) {
    if (!dateStr) return "";
    const date = new Date(dateStr + "T00:00:00");
    return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
}

async function runRender(data, DIA) {
    const todayPlan = (data.plan.days || []).find(p => p.dia == DIA);
    const calendarEntry = data.cal?.map?.find(c => c.dia == DIA && c.ciclo === CONFIG.CICLO_FILTER);
    
    document.getElementById('dayTitle').textContent = `D√≠a ${DIA}`;
    document.getElementById('headerDate').textContent = calendarEntry ? formatSpanishDate(calendarEntry.fecha) : "Fecha TBD";

    // Evals
    // Inside runRender(data, DIA)

// 1. Get the list for the current course (s2)
const evalList = data.evals.courses[CONFIG.COURSE] || [];

// 2. Helper function to find the label for any given day
const findEval = (d) => {
    const match = evalList.find(e => e.dia == d);
    return match ? match.label : "Sin evaluaciones";
};

// 3. Update the UI elements
const currentEvalEl = document.getElementById('currentEval');
const nextEvalsEl = document.getElementById('nextEvals');

if (currentEvalEl) {
    currentEvalEl.textContent = findEval(DIA);
}

if (nextEvalsEl) {
    // This ensures that when you are on Day 15, it looks for 16 and 17
    nextEvalsEl.innerHTML = `
        <li><b>D√≠a ${parseInt(DIA) + 1}:</b> ${findEval(parseInt(DIA) + 1)}</li>
        <li><b>D√≠a ${parseInt(DIA) + 2}:</b> ${findEval(parseInt(DIA) + 2)}</li>
    `;
}
    // Curiosidad
    const curBlock = document.getElementById('curiosityBlock');
    const cur = data.curios.find(c => c.id === `cur-${DIA}`);
    curBlock.innerHTML = cur ? `<article class="bg-white rounded-xl border-l-[6px] border-indigo-400 p-6 card-shadow space-y-4"><h3 class="text-indigo-600 font-bold text-xs uppercase tracking-widest">Curiosidad ${DIA}</h3><h2 class="text-2xl font-extrabold text-slate-900 leading-tight">${cur.title}</h2>${cur.img ? `<div class="w-full aspect-video bg-slate-100 rounded-lg border border-slate-100 flex items-center justify-center overflow-hidden"><img src="${cur.img}" class="max-w-full max-h-full object-contain block"></div>` : ''}<p class="text-slate-700 italic text-sm">${cur.student_note || ""}</p></article>` : "";

    // Estructura
    const estBlock = document.getElementById('estructuraBlock');
    estBlock.innerHTML = ""; 
    (todayPlan?.blocks || []).filter(b => b.kind === "estructura").forEach(blockRef => {
      const topic = data.apuntes?.[blockRef.ref];
      if (!topic) return;
      let cardLinksHtml = "";
      const buildBigButton = (id, label) => {
        const link = topic.links?.[id];
        if (!link) return "";
        const color = label === "Introducir" ? "bg-emerald-100 text-emerald-700" : "bg-blue-100 text-blue-700";
        return `<a href="${link.url}" target="_blank" class="flex items-center justify-between p-4 bg-white rounded-xl border border-slate-200 hover:border-blue-400 hover:shadow-md transition-all mb-2 group"><div class="flex flex-col"><span class="text-[10px] font-black px-2 py-0.5 rounded-full w-fit uppercase ${color} mb-1">${label}</span><span class="text-slate-800 font-bold text-sm md:text-base">${link.title}</span></div><span class="text-blue-500 group-hover:translate-x-1 transition-transform">‚Üó</span></a>`;
      };
      if (blockRef.introducir) blockRef.introducir.forEach(id => cardLinksHtml += buildBigButton(id, "Introducir"));
      if (blockRef.repasar) blockRef.repasar.forEach(id => cardLinksHtml += buildBigButton(id, "Repasar"));
      if (cardLinksHtml) estBlock.innerHTML += `<section class="bg-white rounded-2xl border border-slate-200 border-l-[6px] border-blue-600 p-6 card-shadow mb-6"><div class="flex items-center gap-3 mb-4"><div class="bg-blue-600 text-white p-2 rounded-lg text-xl shadow-sm">‚öôÔ∏è</div><h2 class="text-2xl font-black text-slate-900 tracking-tight">${blockRef.title || topic.title}</h2></div><div class="space-y-1">${cardLinksHtml}</div></section>`;
    });

    // Content Loop (Special Types)
    const contentBlock = document.getElementById('extrasBlock');
    contentBlock.innerHTML = "";
    (todayPlan?.blocks || []).forEach(blockRef => {
        if (blockRef.kind === "extras") {
            const exItem = data.extras.items.find(i => i.id === blockRef.ref);
            if (exItem) {
                let content = exItem.kind === "sentences" 
                    ? `<ul class="space-y-2">${exItem.sentences.map(s => `<li class="text-lg text-slate-700 border-l-4 border-indigo-200 pl-4 italic">"${s}"</li>`).join('')}</ul>` 
                    : `<div class="flex flex-wrap gap-3">${exItem.links.map(l => `<a href="${l.url}" target="_blank" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold text-sm hover:bg-indigo-700 transition-colors">${l.label} ‚Üó</a>`).join('')}</div>`;
                contentBlock.innerHTML += `<section class="bg-indigo-50/50 rounded-xl border-l-[6px] border-indigo-500 p-6 card-shadow mb-6"><h2 class="text-indigo-700 font-bold text-xl mb-4 flex items-center gap-2"><span>‚ú®</span> ${exItem.title}</h2><div class="bg-white rounded-xl p-6 border border-indigo-100 shadow-sm">${content}</div></section>`;
            }
        }
        const specialTypes = ["musica", "cultura", "lectura", "conv"];
        if (specialTypes.includes(blockRef.kind)) {
            const item = data[blockRef.kind]?.items?.[blockRef.ref];
            if (item) {
                contentBlock.innerHTML += `<section class="bg-white rounded-xl border-l-[6px] border-slate-300 overflow-hidden card-shadow mb-6 hover:shadow-lg transition-all group"><div class="flex flex-col md:flex-row"><div class="md:w-40 h-32 overflow-hidden bg-slate-100 flex-shrink-0"><img src="${item.imagen}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"></div><div class="p-4 flex flex-col justify-between flex-grow"><div><span class="text-[9px] font-black uppercase tracking-widest px-2 py-0.5 rounded-full bg-slate-100 text-slate-600">${item.tag}</span><h3 class="text-xl font-black text-slate-900 leading-tight mt-1">${item.titulo}</h3><p class="text-slate-500 font-medium italic text-xs">${item.subtitulo}</p></div><a href="${item.url}" target="_blank" class="mt-2 inline-flex items-center gap-1 text-xs font-bold text-blue-600 hover:text-blue-800 transition-colors">Abrir actividad <span>‚Üí</span></a></div></div></section>`;
            }
        }
    });

    // Dashboard
    const grammarGrid = document.getElementById('grammarResources');
    const vocabContainer = document.getElementById('vocabPlacement');
    grammarGrid.innerHTML = ""; vocabContainer.innerHTML = "";
    const gBlock = todayPlan?.blocks?.find(b => b.kind === "estructura");
    (gBlock?.recursos_gramatica || []).forEach(key => {
        const parentSet = data.apuntes[key]; if (!parentSet || !parentSet.links) return;
        const linksHtml = Object.values(parentSet.links).map(link => `<a href="${link.url}" target="_blank" class="block text-[#4771fa] hover:underline text-[13px] font-bold uppercase tracking-tight py-1 transition-all">${link.title} ‚Üó</a>`).join('');
        grammarGrid.innerHTML += `<div class="bg-white rounded-xl border border-blue-100 border-l-[6px] border-[#4771fa] p-6 shadow-sm flex flex-col h-full"><h3 class="text-[#4771fa] font-black text-lg mb-4 flex items-center gap-2">‚öôÔ∏è ${parentSet.title}</h3><div class="flex flex-col gap-1">${linksHtml}</div></div>`;
    });
    const vBlock = todayPlan?.blocks?.find(b => b.kind === "vocabulario");
    const ch = vBlock ? data.vocab.descubre2.chapters[vBlock.ref] : null;
    if (ch) vocabContainer.innerHTML = `<div class="bg-white rounded-xl border-l-[6px] border-amber-500 shadow-md border border-slate-100 flex flex-col h-full hover:shadow-lg transition-shadow"><div class="h-32 p-4 bg-amber-50/50 flex items-center justify-center border-b border-amber-100 text-4xl">Vocabulario üìö</div><div class="p-5 flex flex-col flex-grow justify-between"><h3 class="text-amber-600 font-bold text-lg mb-4">${ch.label}</h3><div class="flex gap-2"><a href="${ch.listas}" target="_blank" class="flex-1 text-center py-2.5 bg-amber-50 text-amber-700 rounded-lg text-xs font-bold border border-amber-100 uppercase hover:bg-amber-100">Lista</a><a href="${ch.flashcards}" target="_blank" class="flex-1 text-center py-2.5 bg-amber-50 text-amber-700 rounded-lg text-xs font-bold border border-amber-100 uppercase hover:bg-amber-100">Cards</a></div></div></div>`;

    // Tareas
    const tList = document.getElementById('tareasList');
    tList.innerHTML = "";
    const activeTareas = (data.tareas.tareas || []).filter(t => t.day_assigned <= DIA && t.day_due >= DIA);
    activeTareas.forEach(t => {
      let statusPill = (t.day_due == DIA) ? '<span class="text-red-600 font-black animate-pulse text-[10px]">¬°PARA HOY!</span>' : (t.day_assigned == DIA) ? '<span class="bg-emerald-100 text-emerald-700 font-extrabold text-[10px] px-2 py-1 rounded-md border border-emerald-200 uppercase">Nuevo</span>' : (t.day_due == DIA + 1) ? '<span class="bg-amber-100 text-amber-700 font-extrabold text-[10px] px-2 py-1 rounded-md border border-amber-200 uppercase">Pronto</span>' : "";
      tList.innerHTML += `<div class="bg-white rounded-lg p-4 border border-blue-100 shadow-sm transition-all hover:shadow-md mb-3"><div class="flex justify-between items-center mb-2"><span class="text-[9px] font-bold px-2 py-0.5 rounded uppercase bg-blue-50 text-blue-500 tracking-wider">${t.tipo}</span>${statusPill}</div><h4 class="font-bold text-slate-800 text-sm leading-tight mb-2">${t.titulo}</h4><div class="pt-2 border-t border-slate-50 flex justify-between items-center"><span class="text-[10px] text-slate-400 font-bold uppercase italic">Vence: D√≠a ${t.day_due}</span></div></div>`;
    });
    if (activeTareas.length === 0) tList.innerHTML = '<p class="text-slate-400 italic text-center text-sm py-4">No hay tareas pendientes.</p>';

    await applyTheme(data, DIA);
}

// --- DATA LOADING & INIT ---
async function loadData() {
    const urls = [CONFIG.PLAN, CONFIG.EVALS, CONFIG.CALENDARIO, CONFIG.CURIOSIDADES, CONFIG.TAREAS, CONFIG.VOCAB_BANK, CONFIG.APUNTES_BANK, CONFIG.EXTRAS, CONFIG.MUSICA, CONFIG.LECTURA, CONFIG.CULTURA, CONFIG.CONV];
    try {
      const r = await Promise.all(urls.map(url => fetch(url + "?t=" + Date.now()).then(res => res.json())));
      return { plan: r[0], evals: r[1], cal: r[2], curios: r[3], tareas: r[4], vocab: r[5], apuntes: r[6], extras: r[7], musica: r[8], lectura: r[9], cultura: r[10], conv: r[11] };
    } catch (e) { console.error("Error loading data", e); }
}

async function init() {
    const data = await loadData();
    if (!data) return;

    // Date Picker Setup
    const datePicker = document.getElementById('datePicker');
    if (datePicker) {
        datePicker.addEventListener('change', async (e) => {
            const selectedDate = e.target.value;
            if (!selectedDate) return;
            const match = data.cal.map.find(c => c.fecha === selectedDate && c.ciclo === CONFIG.CICLO_FILTER);
            let targetDia;
            if (match && match.dia) targetDia = match.dia;
            else {
                const validDays = data.cal.map.filter(c => c.ciclo === CONFIG.CICLO_FILTER && c.dia != null && c.fecha <= selectedDate).sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                if (validDays.length > 0) targetDia = validDays[0].dia;
            }
            if (targetDia) {
                document.getElementById('diaInput').value = targetDia;
                await runRender(data, targetDia);
            }
        });
    }

    // Day Input Setup
    const diaInput = document.getElementById('diaInput');
    if (diaInput) {
        diaInput.addEventListener('change', async (e) => {
            await runRender(data, e.target.value);
        });
    }

    const now = new Date();
    const allowedEntries = (data.cal.map || []).filter(entry => entry.ciclo === CONFIG.CICLO_FILTER && entry.dia != null && new Date(entry.fecha + "T00:00:00") <= now);
    allowedEntries.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
    const maxAllowedDia = allowedEntries.length ? allowedEntries[allowedEntries.length - 1].dia : 1;
    if (diaInput) { diaInput.max = maxAllowedDia; }

    const params = new URLSearchParams(window.location.search);
    let DIA = parseInt(params.get('dia'), 10) || maxAllowedDia;
    if (DIA > maxAllowedDia) DIA = maxAllowedDia;
    if (diaInput) diaInput.value = DIA;

    await runRender(data, DIA);
}

init();
</script>
    </body>
</html>

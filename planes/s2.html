<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plan â€“ EspaÃ±ol 2</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-100 text-slate-900 min-h-screen">
  <main class="max-w-4xl mx-auto px-4 py-10 space-y-6">

    <!-- Day Header -->
    <section class="bg-white rounded-2xl shadow border border-slate-200 p-6">
      <h1 id="dayTitle" class="text-2xl font-extrabold text-slate-900">DÃ­a â€”</h1>
      <p id="daySubtitle" class="text-sm text-slate-600 mt-1"></p>
      <p id="dayMeta" class="text-xs text-slate-500 mt-2"></p>
    </section>

    <!-- Controls -->
    <section class="bg-white rounded-2xl shadow border border-slate-200 p-6 space-y-3">
      <div class="flex flex-wrap items-end gap-3">
        <div>
          <label class="block text-sm font-semibold text-slate-700">DÃ­a</label>
          <input id="diaInput" type="number" value="35"
                 class="w-28 border rounded-lg px-3 py-2 text-sm" />
        </div>

        <button id="loadBtn"
                class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700">
          Cargar
        </button>

        <label class="ml-auto inline-flex items-center gap-2 text-sm text-slate-700">
          <input id="debugToggle" type="checkbox" class="rounded" />
          Debug JSON
        </label>
      </div>

      <div id="status" class="text-sm text-slate-600"></div>
    </section>

    <!-- Evaluaciones (Today + Next 2) -->
    <section id="evalStrip" class="space-y-4"></section>

    <!-- Day Blocks -->
    <section id="output" class="space-y-4"></section>

    <!-- Debug -->
    <section id="debug" class="space-y-3"></section>

  </main>

  <script>
    /***********************
     * CONFIG (URLs)
     ***********************/
    const COURSE = "s2";

    const PLAN_URL = "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/plan_s2.json";
    const EXTRAS_URL = "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/extras.json";

    // âœ… evaluaciones as SCHEDULE (dÃ­a -> label)
    // (Your file can be either an array OR { courses: { s2: [...] } })
    const EVALUACIONES_URL = "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/evaluaciones.json";

    // Calendar map for "today / previous class" DIA resolution
    const CALENDAR_URL = "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/calendario.json";

    // âœ… pure static calentamiento (base + "/" + DIA)
    const CALENTAMIENTO_STATIC_BASE =
      "https://sites.google.com/view/srscalici/espa%C3%B1ol-2/planes/calentamiento";

    /***********************
     * DOM
     ***********************/
    const dayTitleEl = document.getElementById("dayTitle");
    const daySubtitleEl = document.getElementById("daySubtitle");
    const dayMetaEl = document.getElementById("dayMeta");

    const statusEl = document.getElementById("status");
    const outputEl = document.getElementById("output");
    const evalStripEl = document.getElementById("evalStrip");
    const debugEl = document.getElementById("debug");

    const diaInput = document.getElementById("diaInput");
    const loadBtn = document.getElementById("loadBtn");
    const debugToggle = document.getElementById("debugToggle");

    /***********************
     * UTILS
     ***********************/
    function setStatus(msg, kind = "info") {
      const classes = {
        info: "text-slate-600",
        ok: "text-emerald-700",
        err: "text-red-700",
      };
      statusEl.className = `text-sm ${classes[kind] || classes.info}`;
      statusEl.textContent = msg;
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function getJSON(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`Fetch failed (${res.status}) for ${url}`);
      return await res.json();
    }

    function ymdLocal(d = new Date()) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function parseYMD(ymd) {
      const [y, m, d] = String(ymd).split("-").map(Number);
      return new Date(y, m - 1, d, 0, 0, 0, 0);
    }

    function formatFechaES(ymd) {
      if (!ymd) return "";
      const [y, m, d] = String(ymd).split("-").map(Number);
      const dt = new Date(y, m - 1, d);
      return dt.toLocaleDateString("es-US", {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric",
      });
    }

    function getDiaFromURL() {
      const params = new URLSearchParams(location.search);
      const v = Number(params.get("dia"));
      return Number.isFinite(v) && v > 0 ? v : null;
    }

    function buildCalendarIndex(cal) {
      const mapArr = Array.isArray(cal?.map) ? cal.map : [];
      const byDate = new Map();
      for (const row of mapArr) {
        if (row && typeof row.fecha === "string") byDate.set(row.fecha, row);
      }
      return { mapArr, byDate };
    }

    function resolveDiaForDate(cal, targetYMD) {
      const { mapArr, byDate } = buildCalendarIndex(cal);

      const direct = byDate.get(targetYMD);
      const directDia = direct ? Number(direct.dia) : NaN;
      if (Number.isFinite(directDia) && directDia > 0) {
        return { dia: directDia, source: "today" };
      }

      const targetDate = parseYMD(targetYMD);
      let bestDia = null;
      let bestDate = null;

      for (const row of mapArr) {
        if (!row || typeof row.fecha !== "string") continue;
        const rowDia = Number(row.dia);
        if (!(Number.isFinite(rowDia) && rowDia > 0)) continue;

        const rowDate = parseYMD(row.fecha);
        if (rowDate <= targetDate) {
          if (!bestDate || rowDate > bestDate) {
            bestDate = rowDate;
            bestDia = rowDia;
          }
        }
      }

      if (bestDia !== null) return { dia: bestDia, source: "previous" };
      return { dia: null, source: "none" };
    }

    function renderDebugBox(title, obj) {
      return `
        <details class="bg-white rounded-2xl shadow border border-slate-200 p-4">
          <summary class="cursor-pointer font-semibold">${escapeHtml(title)}</summary>
          <pre class="mt-3 text-xs overflow-auto bg-slate-50 border border-slate-200 rounded-xl p-3">${escapeHtml(JSON.stringify(obj, null, 2))}</pre>
        </details>
      `;
    }

    function normalizeKind(raw) {
      const t = String(raw || "").toLowerCase().trim();
      // accept both "extras" and "extra"
      if (t === "extras" || t === "extra") return "extra";
      if (t === "evaluacion" || t === "evaluaciÃ³n" || t === "eval") return "evaluacion";
      if (t === "calentamiento" || t === "cal") return "calentamiento";
      return t;
    }

    /***********************
     * EVALUACIONES (SCHEDULE)
     ***********************/
    function extractEvaluacionesArray(evalsJson, course) {
      // supports:
      // 1) [ {dia,label}, ... ]
      // 2) { courses: { s2: [ {dia,label} ] } }
      if (Array.isArray(evalsJson)) return evalsJson;
      if (evalsJson?.courses && Array.isArray(evalsJson.courses?.[course])) return evalsJson.courses[course];
      if (evalsJson?.items && Array.isArray(evalsJson.items)) return evalsJson.items; // fallback if you ever rename
      return [];
    }

    function buildEvalIndex(evalsArr) {
      const map = new Map();
      for (const row of evalsArr) {
        const dia = Number(row?.dia);
        const label = String(row?.label ?? "").trim();
        if (Number.isFinite(dia) && dia > 0) map.set(dia, label || "Nada");
      }
      return map;
    }

    function evalLabelForDia(evalMap, dia) {
      // Your rule: always show something; if missing -> "Nada"
      const label = evalMap.get(Number(dia));
      return (label && label.trim()) ? label : "Nada";
    }

    function renderEvalCard({ title, dia, label }) {
      return `
        <article class="bg-white rounded-2xl shadow border border-slate-200 overflow-hidden">
          <div class="px-6 py-4 bg-emerald-600 text-white">
            <div class="flex items-baseline justify-between gap-4">
              <div>
                <h3 class="text-lg font-extrabold">âœ… EvaluaciÃ³n</h3>
                <p class="text-sm opacity-95">${escapeHtml(title)} Â· DÃ­a ${escapeHtml(dia)}</p>
              </div>
              <span class="text-sm font-bold opacity-95">${escapeHtml(label || "Nada")}</span>
            </div>
          </div>
          <div class="p-6">
            <p class="text-sm text-slate-700">
              ${escapeHtml(label || "Nada")}
            </p>
          </div>
        </article>
      `;
    }

    function renderEvalStrip(evalMap, DIA) {
      const d0 = Number(DIA);
      const d1 = d0 + 1;
      const d2 = d0 + 2;

      const html = [
        renderEvalCard({ title: "Hoy", dia: d0, label: evalLabelForDia(evalMap, d0) }),
        renderEvalCard({ title: "PrÃ³xima clase", dia: d1, label: evalLabelForDia(evalMap, d1) }),
        renderEvalCard({ title: "En 2 clases", dia: d2, label: evalLabelForDia(evalMap, d2) }),
      ].join("");

      evalStripEl.innerHTML = html;
    }

    /***********************
     * RENDERERS
     ***********************/
    function renderCalentamientoStaticCard(DIA) {
      const href = `${CALENTAMIENTO_STATIC_BASE}/${encodeURIComponent(String(DIA))}`;
      return `
        <article class="bg-white rounded-2xl shadow border border-slate-200 overflow-hidden">
          <div class="px-6 py-4 bg-amber-500 text-white">
            <div class="flex items-baseline justify-between gap-4">
              <div>
                <h3 class="text-lg font-extrabold">ðŸ”¥ Calentamiento</h3>
                <p class="text-sm opacity-95">DÃ­a ${escapeHtml(DIA)}</p>
              </div>
              <span class="text-sm font-bold opacity-95">8 min</span>
            </div>
          </div>

          <div class="p-6 space-y-3">
            <p class="text-sm text-slate-700">Abre el calentamiento del dÃ­a (ruta fija).</p>

            <div class="pt-2">
              <a href="${escapeHtml(href)}"
                 target="_blank" rel="noopener"
                 class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-amber-600 text-white font-semibold hover:bg-amber-700">
                Abrir calentamiento â†—
              </a>
            </div>

            <p class="text-xs text-slate-500">url: ${escapeHtml(href)}</p>
          </div>
        </article>
      `;
    }

    function renderExtra(item) {
      const title = escapeHtml(item.title || "Extra");

      if (item.kind === "links") {
        const links = Array.isArray(item.links) ? item.links : [];
        return `
          <article class="bg-white rounded-2xl shadow border border-slate-200 overflow-hidden">
            <div class="px-6 py-4 bg-indigo-600 text-white">
              <h3 class="text-lg font-extrabold">âž• Extra</h3>
              <p class="text-sm opacity-90">${title}</p>
            </div>
            <div class="p-6">
              ${links.length ? `
                <ul class="list-disc pl-5 space-y-2">
                  ${links.map(l => `
                    <li>
                      <a class="text-indigo-700 underline"
                        href="${escapeHtml(l.url)}"
                        target="_blank" rel="noopener">
                        ${escapeHtml(l.label)}
                      </a>
                    </li>
                  `).join("")}
                </ul>
              ` : `<p class="text-sm text-slate-600">No hay enlaces en este extra.</p>`}
              <p class="text-xs text-slate-500 mt-4">id: ${escapeHtml(item.id)}</p>
            </div>
          </article>
        `;
      }

      if (item.kind === "sentences") {
        const sentences = Array.isArray(item.sentences) ? item.sentences : [];
        const instructions = item.instructions
          ? `<p class="text-sm text-slate-700">${escapeHtml(item.instructions)}</p>`
          : "";

        return `
          <article class="bg-white rounded-2xl shadow border border-slate-200 overflow-hidden">
            <div class="px-6 py-4 bg-indigo-600 text-white">
              <h3 class="text-lg font-extrabold">âž• Extra</h3>
              <p class="text-sm opacity-90">${title}</p>
            </div>
            <div class="p-6 space-y-3">
              ${instructions}
              ${sentences.length ? `
                <ol class="list-decimal pl-5 space-y-2 text-slate-800">
                  ${sentences.map(s => `<li>${escapeHtml(s)}</li>`).join("")}
                </ol>
              ` : `<p class="text-sm text-slate-600">No hay oraciones en este extra.</p>`}
              <p class="text-xs text-slate-500">id: ${escapeHtml(item.id)}</p>
            </div>
          </article>
        `;
      }

      return `
        <div class="bg-white rounded-2xl shadow border border-red-200 p-6">
          <p class="text-red-700 font-semibold">Extra no soportado: ${escapeHtml(item.kind || "sin kind")}</p>
          <p class="text-xs text-slate-500">id: ${escapeHtml(item.id)}</p>
        </div>
      `;
    }

    /***********************
     * LOAD + RENDER DAY
     ***********************/
  async function determineDia() {
  // 1) URL override (optional)
  const diaFromUrl = getDiaFromURL();
  if (diaFromUrl) return { DIA: diaFromUrl, source: "link" };

  // 2) INPUT wins (what you typed)
  const diaFromInput = Number(diaInput.value);
  if (Number.isFinite(diaFromInput) && diaFromInput > 0) {
    return { DIA: diaFromInput, source: "input" };
  }

  // 3) Calendar fallback (only if no input)
  try {
    const cal = await getJSON(CALENDAR_URL);
    const today = ymdLocal();
    const resolved = resolveDiaForDate(cal, today);
    if (resolved.dia) return { DIA: resolved.dia, source: resolved.source };
  } catch (_) {}

  return { DIA: null, source: "none" };
}

    function updateHeader({ DIA, day, calSource }) {
      const fechaPlan = day?.fecha ? String(day.fecha) : null;
      dayTitleEl.textContent = `DÃ­a ${DIA}${fechaPlan ? ` Â· ${fechaPlan}` : ""}`;

      if (!fechaPlan) {
        daySubtitleEl.textContent = "Fecha no definida en el plan.";
      } else {
        const fechaBonita = formatFechaES(fechaPlan);
        daySubtitleEl.textContent = (calSource === "previous")
          ? `No hay clase hoy â€” mostrando la clase mÃ¡s reciente. ${fechaBonita}`.trim()
          : fechaBonita;
      }

      dayMetaEl.textContent = `course: ${COURSE} Â· source: ${calSource || "?"}`;
    }

    async function loadDay() {
      outputEl.innerHTML = "";
      evalStripEl.innerHTML = "";
      debugEl.innerHTML = "";

      const { DIA, source } = await determineDia();
      if (!DIA) {
        setStatus("Pon un nÃºmero de dÃ­a vÃ¡lido.", "err");
        return;
      }

      setStatus(
        source === "previous"
          ? `No hay clase hoy â€” mostrando la clase mÃ¡s reciente (DÃ­a ${DIA}).`
          : `Cargando DÃ­a ${DIA}â€¦`,
        "info"
      );

      try {
        const [plan, extrasJson, evalsJson] = await Promise.all([
          getJSON(PLAN_URL),
          getJSON(EXTRAS_URL),
          getJSON(EVALUACIONES_URL),
        ]);

        if (debugToggle.checked) {
          debugEl.insertAdjacentHTML("beforeend", renderDebugBox("Debug: plan_s2.json", plan));
          debugEl.insertAdjacentHTML("beforeend", renderDebugBox("Debug: extras.json", extrasJson));
          debugEl.insertAdjacentHTML("beforeend", renderDebugBox("Debug: evaluaciones.json", evalsJson));
        }

        const days = Array.isArray(plan?.days) ? plan.days : [];
        const day = days.find(d => Number(d.dia) === Number(DIA));

        if (!day) {
          updateHeader({ DIA, day: null, calSource: source });
          setStatus(`No encontrÃ© DÃ­a ${DIA} dentro de plan.days.`, "err");
          outputEl.insertAdjacentHTML("beforeend", `
            <div class="bg-white rounded-2xl shadow border border-slate-200 p-6">
              <p class="text-slate-700">
                Revisa que <code class="bg-slate-100 px-1 rounded">plan.days</code> tenga un objeto con <strong>"dia": ${escapeHtml(DIA)}</strong>.
              </p>
            </div>
          `);
          return;
        }

        updateHeader({ DIA, day, calSource: source });

        // âœ… Evaluaciones strip (Hoy + next 2), ALWAYS includes "Nada"
        const evalArr = extractEvaluacionesArray(evalsJson, COURSE);
        const evalMap = buildEvalIndex(evalArr);
        renderEvalStrip(evalMap, DIA);

        // Day blocks
        const blocks = Array.isArray(day?.blocks) ? day.blocks : [];
        if (!blocks.length) {
          setStatus(`DÃ­a ${DIA} existe, pero day.blocks estÃ¡ vacÃ­o.`, "err");
          return;
        }

        const extraItems = Array.isArray(extrasJson?.items) ? extrasJson.items : [];
        let renderedAny = false;

        for (const block of blocks) {
          if (!block) continue;

          const kind = normalizeKind(block.kind);
          const ref = String(block.ref || "").trim();

          if (!kind) continue;

          if (kind === "calentamiento") {
            outputEl.insertAdjacentHTML("beforeend", renderCalentamientoStaticCard(DIA));
            renderedAny = true;
            continue;
          }

          if (kind === "extra") {
            if (!ref) {
              // allow extras without ref, but show a helpful warning
              outputEl.insertAdjacentHTML("beforeend", `
                <div class="bg-white rounded-2xl shadow border border-red-200 p-6">
                  <p class="text-red-700 font-semibold">Extra sin "ref".</p>
                  <p class="text-sm text-slate-700">Este bloque necesita <code class="bg-slate-100 px-1 rounded">"ref"</code> para buscarlo en extras.json.</p>
                </div>
              `);
              continue;
            }

            const item = extraItems.find(x => x?.id === ref);
            if (!item) {
              outputEl.insertAdjacentHTML("beforeend", `
                <div class="bg-white rounded-2xl shadow border border-red-200 p-6">
                  <p class="text-red-700 font-semibold">No encontrÃ© el extra con id = "${escapeHtml(ref)}".</p>
                  <p class="text-sm text-slate-700">Revisa <code class="bg-slate-100 px-1 rounded">extras.items</code>.</p>
                </div>
              `);
            } else {
              outputEl.insertAdjacentHTML("beforeend", renderExtra(item));
              renderedAny = true;
            }
            continue;
          }

          if (kind === "evaluacion") {
            // âœ… we do NOT look up eval by id anymore; schedule handles it.
            // If you still put evaluacion blocks in day.blocks, weâ€™ll show the same label for the day.
            const label = evalLabelForDia(evalMap, DIA);
            outputEl.insertAdjacentHTML("beforeend", renderEvalCard({ title: "EvaluaciÃ³n del dÃ­a", dia: DIA, label }));
            renderedAny = true;
            continue;
          }

          // fallback
          outputEl.insertAdjacentHTML("beforeend", `
            <div class="bg-white rounded-2xl shadow border border-red-200 p-6">
              <p class="text-red-700 font-semibold">Tipo de bloque no soportado: "${escapeHtml(block.kind)}"</p>
              ${ref ? `<p class="text-sm text-slate-700">Ref: <code class="bg-slate-100 px-1 rounded">${escapeHtml(ref)}</code></p>` : ""}
            </div>
          `);
        }

        setStatus(
          renderedAny ? `Listo. RendericÃ© DÃ­a ${DIA}.` : `Render parcial: DÃ­a ${DIA}, pero algunos bloques no tenÃ­an refs / tipos vÃ¡lidos.`,
          renderedAny ? "ok" : "err"
        );

      } catch (err) {
        console.error(err);
        setStatus(`Error: ${err.message}`, "err");
        outputEl.insertAdjacentHTML("beforeend", `
          <div class="bg-white rounded-2xl shadow border border-red-200 p-6">
            <p class="text-red-700 font-semibold">Hubo un error cargando los JSON.</p>
            <p class="text-sm text-slate-700">Abre la consola (DevTools) para ver detalles.</p>
            <p class="text-xs text-slate-500 mt-2">${escapeHtml(String(err))}</p>
          </div>
        `);
      }
    }

    loadBtn.addEventListener("click", loadDay);
    loadDay();
  </script>
</body>
</html>

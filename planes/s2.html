<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plan Test – Spanish 2</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-100 text-slate-900 min-h-screen">
  <main class="max-w-3xl mx-auto px-4 py-10 space-y-6">
    <header class="bg-white rounded-2xl shadow border border-slate-200 p-6">
      <h1 class="text-2xl font-bold">Plan References – Test</h1>
      <p class="text-sm text-slate-600">
        Esto debe mostrar la evaluación referenciada para un día específico.
      </p>
    </header>

    <section class="bg-white rounded-2xl shadow border border-slate-200 p-6 space-y-3">
      <div class="flex flex-wrap items-end gap-3">
        <div>
          <label class="block text-sm font-semibold text-slate-700">Día</label>
          <input id="diaInput" type="number" value="23"
                 class="w-28 border rounded-lg px-3 py-2 text-sm" />
        </div>
        <button id="loadBtn"
                class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700">
          Cargar
        </button>
      </div>

      <div id="status" class="text-sm text-slate-600"></div>
    </section>

    <section id="output" class="space-y-4"></section>
  </main>

  <script>
    const PLAN_URL = "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/plan_s2.json";
    const EVAL_URL = "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/evaluaciones.json";
    const EXTRAS_URL = "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/extras.json";
    const CAL_URL = "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/calendario.json";



    const statusEl = document.getElementById("status");
    const outputEl = document.getElementById("output");
    const diaInput = document.getElementById("diaInput");
    const loadBtn = document.getElementById("loadBtn");
function ymdLocal() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

function getDiaFromURL() {
  const params = new URLSearchParams(location.search);
  const v = Number(params.get("dia"));
  return Number.isFinite(v) && v > 0 ? v : null;
}

    function setStatus(msg, kind="info") {
      const classes = {
        info: "text-slate-600",
        ok: "text-emerald-700",
        err: "text-red-700"
      };
      statusEl.className = `text-sm ${classes[kind] || classes.info}`;
      statusEl.textContent = msg;
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function getJSON(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`Fetch failed (${res.status}) for ${url}`);
      return await res.json();
    }

    function renderEvaluacion(item) {
      const prompts = Array.isArray(item.prompts) ? item.prompts : [];
      const instructions = item.instructions ? `<p class="text-sm text-slate-700">${escapeHtml(item.instructions)}</p>` : "";

      return `
        <article class="bg-white rounded-2xl shadow border border-slate-200 overflow-hidden">
          <div class="px-6 py-4 bg-emerald-600 text-white">
            <h2 class="text-lg font-extrabold">✅ Evaluación</h2>
            <p class="text-sm opacity-90">${escapeHtml(item.title || item.kind || item.id)}</p>
          </div>
          <div class="p-6 space-y-3">
            ${instructions}
            ${prompts.length ? `
              <ol class="list-decimal pl-5 space-y-2 text-slate-800">
                ${prompts.map(p => `<li>${escapeHtml(p)}</li>`).join("")}
              </ol>
            ` : `<p class="text-sm text-slate-600">No hay prompts en este item.</p>`}
            <p class="text-xs text-slate-500">id: ${escapeHtml(item.id)}</p>
          </div>
        </article>
      `;
    }
function renderExtra(item) {
  const title = escapeHtml(item.title || "Extra");

  // LINKS
  if (item.kind === "links") {
    const links = Array.isArray(item.links) ? item.links : [];
    return `
      <article class="bg-white rounded-2xl shadow border border-slate-200 overflow-hidden">
        <div class="px-6 py-4 bg-indigo-600 text-white">
          <h2 class="text-lg font-extrabold">➕ Extra</h2>
          <p class="text-sm opacity-90">${title}</p>
        </div>
        <div class="p-6">
          ${links.length ? `
            <ul class="list-disc pl-5 space-y-2">
              ${links.map(l => `
                <li>
                  <a class="text-indigo-700 underline"
                     href="${escapeHtml(l.url)}"
                     target="_blank" rel="noopener">
                    ${escapeHtml(l.label)}
                  </a>
                </li>
              `).join("")}
            </ul>
          ` : `<p class="text-sm text-slate-600">No hay enlaces en este extra.</p>`}
          <p class="text-xs text-slate-500 mt-4">id: ${escapeHtml(item.id)}</p>
        </div>
      </article>
    `;
  }

  // SENTENCES
  if (item.kind === "sentences") {
    const sentences = Array.isArray(item.sentences) ? item.sentences : [];
    const instructions = item.instructions
      ? `<p class="text-sm text-slate-700">${escapeHtml(item.instructions)}</p>`
      : "";

    return `
      <article class="bg-white rounded-2xl shadow border border-slate-200 overflow-hidden">
        <div class="px-6 py-4 bg-indigo-600 text-white">
          <h2 class="text-lg font-extrabold">➕ Extra</h2>
          <p class="text-sm opacity-90">${title}</p>
        </div>
        <div class="p-6 space-y-3">
          ${instructions}
          ${sentences.length ? `
            <ol class="list-decimal pl-5 space-y-2 text-slate-800">
              ${sentences.map(s => `<li>${escapeHtml(s)}</li>`).join("")}
            </ol>
          ` : `<p class="text-sm text-slate-600">No hay oraciones en este extra.</p>`}
          <p class="text-xs text-slate-500">id: ${escapeHtml(item.id)}</p>
        </div>
      </article>
    `;
  }

  // FALLBACK
  return `
    <div class="bg-white rounded-2xl shadow border border-red-200 p-6">
      <p class="text-red-700 font-semibold">Extra no soportado: ${escapeHtml(item.kind || "sin kind")}</p>
      <p class="text-xs text-slate-500">id: ${escapeHtml(item.id)}</p>
    </div>
  `;
}

    function renderDebugBox(title, obj) {
      return `
        <details class="bg-white rounded-2xl shadow border border-slate-200 p-4">
          <summary class="cursor-pointer font-semibold">${escapeHtml(title)}</summary>
          <pre class="mt-3 text-xs overflow-auto bg-slate-50 border border-slate-200 rounded-xl p-3">${escapeHtml(JSON.stringify(obj, null, 2))}</pre>
        </details>
      `;
    }
function ymdLocal(d = new Date()) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

function parseYMD(ymd) {
  // Local time midnight
  const [y, m, d] = ymd.split("-").map(Number);
  return new Date(y, m - 1, d, 0, 0, 0, 0);
}

function getDiaFromURL() {
  const params = new URLSearchParams(location.search);
  const v = Number(params.get("dia"));
  return Number.isFinite(v) && v > 0 ? v : null;
}

function buildCalendarIndex(cal) {
  const mapArr = Array.isArray(cal.map) ? cal.map : [];
  const byDate = new Map();
  for (const row of mapArr) {
    if (row && typeof row.fecha === "string") {
      byDate.set(row.fecha, row); // last one wins if duplicates (shouldn't happen)
    }
  }
  return { mapArr, byDate };
}

function resolveDiaForDate(cal, targetYMD) {
  const { mapArr, byDate } = buildCalendarIndex(cal);

  // 1) Direct match exists AND dia is a number
  const direct = byDate.get(targetYMD);
  const directDia = direct ? Number(direct.dia) : NaN;
  if (Number.isFinite(directDia) && directDia > 0) {
    return { dia: directDia, source: "today" };
  }

  // 2) Otherwise: find most recent previous row with a real dia
  const targetDate = parseYMD(targetYMD);

  let best = null;
  let bestDate = null;

  for (const row of mapArr) {
    if (!row || typeof row.fecha !== "string") continue;

    const rowDia = Number(row.dia);
    if (!(Number.isFinite(rowDia) && rowDia > 0)) continue; // skip null / invalid

    const rowDate = parseYMD(row.fecha);
    if (rowDate <= targetDate) {
      if (!bestDate || rowDate > bestDate) {
        bestDate = rowDate;
        best = rowDia;
      }
    }
  }

  if (best !== null) {
    return { dia: best, source: "previous" };
  }

  // 3) If calendar starts after today (rare), return null and let caller fall back.
  return { dia: null, source: "none" };
}

    async function loadDay() {
      outputEl.innerHTML = "";
  const diaFromUrl = getDiaFromURL();
let diaFromCalendar = null;
let calSource = null;

try {
  const cal = await getJSON(CAL_URL);
  const today = ymdLocal();
  const resolved = resolveDiaForDate(cal, today);
  diaFromCalendar = resolved.dia;
  calSource = resolved.source; // "today" | "previous" | "none"
} catch (e) {
  // calendar not ready; ignore
}

const diaFromInput = Number(diaInput.value);
const DIA = diaFromUrl ?? diaFromCalendar ?? diaFromInput;

if (!Number.isFinite(DIA) || DIA <= 0) {
  setStatus("Pon un número de día válido.", "err");
  return;
}

if (diaFromUrl) {
  setStatus(`Cargando Día ${DIA} (link)…`, "info");
} else if (calSource === "today") {
  setStatus(`Cargando Día ${DIA} (hoy)…`, "info");
} else if (calSource === "previous") {
  setStatus(`No hay clase hoy — mostrando la clase más reciente (Día ${DIA}).`, "info");
} else {
  setStatus(`Cargando Día ${DIA}…`, "info");
}

      try {
        setStatus(`Cargando Día ${DIA}…`, "info");

        const [plan, evals, extras] = await Promise.all([
  getJSON(PLAN_URL),
  getJSON(EVAL_URL),
  getJSON(EXTRAS_URL)
]);

        // Useful debug (you can remove later)
       outputEl.insertAdjacentHTML("beforeend", renderDebugBox("Debug: plan_s2.json", plan));
outputEl.insertAdjacentHTML("beforeend", renderDebugBox("Debug: evaluaciones.json", evals));
outputEl.insertAdjacentHTML("beforeend", renderDebugBox("Debug: extras.json", extras));

        const days = Array.isArray(plan.days) ? plan.days : [];
        const day = days.find(d => Number(d.dia) === DIA);

        if (!day) {
          setStatus(`No encontré Día ${DIA} dentro de plan.days.`, "err");
          outputEl.insertAdjacentHTML("beforeend", `
            <div class="bg-white rounded-2xl shadow border border-slate-200 p-6">
              <p class="text-slate-700">Revisa que <code class="bg-slate-100 px-1 rounded">plan.days</code> tenga un objeto con <strong>"dia": ${DIA}</strong>.</p>
            </div>
          `);
          return;
        }

        const blocks = Array.isArray(day.blocks) ? day.blocks : [];
        if (!blocks.length) {
          setStatus(`Día ${DIA} existe, pero day.blocks está vacío.`, "err");
          return;
        }

        const evalItems = Array.isArray(evals.items) ? evals.items : [];
const extraItems = Array.isArray(extras.items) ? extras.items : [];
let renderedAny = false;

        for (const block of blocks) {
  if (block.type === "evaluacion") {
    const item = evalItems.find(x => x.id === block.ref);
    if (!item) {
      outputEl.insertAdjacentHTML("beforeend", `
        <div class="bg-white rounded-2xl shadow border border-red-200 p-6">
          <p class="text-red-700 font-semibold">No encontré la evaluación con id = "${escapeHtml(block.ref)}".</p>
          <p class="text-sm text-slate-700">Revisa que exista en <code class="bg-slate-100 px-1 rounded">evaluaciones.items</code>.</p>
        </div>
      `);
    } else {
      outputEl.insertAdjacentHTML("beforeend", renderEvaluacion(item));
      renderedAny = true;
    }

  } else if (block.type === "extras") {
    const item = extraItems.find(x => x.id === block.ref);
    if (!item) {
      outputEl.insertAdjacentHTML("beforeend", `
        <div class="bg-white rounded-2xl shadow border border-red-200 p-6">
          <p class="text-red-700 font-semibold">No encontré el extra con id = "${escapeHtml(block.ref)}".</p>
          <p class="text-sm text-slate-700">Revisa que exista en <code class="bg-slate-100 px-1 rounded">extras.items</code>.</p>
        </div>
      `);
    } else {
      outputEl.insertAdjacentHTML("beforeend", renderExtra(item));
      renderedAny = true;
    }
  }
}

        sets(
          renderedAny
            ? `Listo. Rendericé Día ${DIA}.`
            : `Encontré Día ${DIA}, pero no rendericé nada (refs faltantes o tipos no soportados).`,
          renderedAny ? "ok" : "err"
        );

      } catch (err) {
        console.error(err);
        setStatus(`Error: ${err.message}`, "err");
        outputEl.insertAdjacentHTML("beforeend", `
          <div class="bg-white rounded-2xl shadow border border-red-200 p-6">
            <p class="text-red-700 font-semibold">Hubo un error cargando los JSON.</p>
            <p class="text-sm text-slate-700">Abre la consola (DevTools) para ver detalles.</p>
            <p class="text-xs text-slate-500 mt-2">${escapeHtml(String(err))}</p>
          </div>
        `);
      }
    }

    loadBtn.addEventListener("click", loadDay);
    loadDay(); // auto-load on page open
  </script>
</body>
</html>

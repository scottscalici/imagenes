<script>
    const CONFIG = {
      COURSE: "s2",
      CICLO_FILTER: "B", // Meets only on B Days
      PLAN: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/plan_s2.json",
      EVALS: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/evaluaciones.json",
      EXTRAS: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/extras.json",
      CALENDARIO: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/calendario.json",
      CURIOSIDADES: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/curiosidades.json",
      TAREAS: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/tareas.json",
      VOCAB_BANK: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/vocabulario.json",
      APUNTES_BANK: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/apuntes.json",
      CAL_BASE: "https://sites.google.com/view/srscalici/espa%C3%B1ol-2/planes/calentamiento"
    };

    function formatSpanishDate(dateStr) {
      if (!dateStr) return "";
      const date = new Date(dateStr + "T00:00:00");
      return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
    }

    async function loadData() {
      // Added Vocab and Apuntes to your fetch list
      const urls = [CONFIG.PLAN, CONFIG.EVALS, CONFIG.CALENDARIO, CONFIG.CURIOSIDADES, CONFIG.TAREAS, CONFIG.VOCAB_BANK, CONFIG.APUNTES_BANK];
      try {
        const responses = await Promise.all(urls.map(url => fetch(url + "?t=" + Date.now()).then(r => r.json())));
        return { plan: responses[0], evals: responses[1], cal: responses[2], curios: responses[3], tareas: responses[4], vocab: responses[5], apuntes: responses[6] };
      } catch (e) { console.error("Error loading JSON:", e); }
    }

    function renderManual() {
      const d = document.getElementById('diaInput').value;
      window.history.pushState({}, '', `?dia=${d}`);
      init();
    }

    async function init() {
      const data = await loadData();
      if (!data) return;

      const params = new URLSearchParams(window.location.search);
      let DIA = parseInt(params.get('dia')) || 35; // Defaulted to 35 for your test day

      // 1. DATE LOGIC (Your original B-Day filter)
      const calendarEntry = data.cal?.map?.find(c => c.dia == DIA && c.ciclo === CONFIG.CICLO_FILTER);
      document.getElementById('dayTitle').textContent = `D√≠a ${DIA}`;
      document.getElementById('headerDate').textContent = calendarEntry ? formatSpanishDate(calendarEntry.fecha) : "Fecha TBD (A-Day)";

      // 2. EVALUATIONS (Your original logic)
      const evalList = data.evals.courses[CONFIG.COURSE];
      const findEval = (d) => (evalList.find(e => e.dia == d)?.label || "No hay evaluaciones");
      document.getElementById('currentEval').textContent = findEval(DIA);
      document.getElementById('nextEvals').innerHTML = `
        <li><span class="font-bold">D√≠a ${DIA+1}:</span> ${findEval(DIA+1)}</li>
        <li><span class="font-bold">D√≠a ${DIA+2}:</span> ${findEval(DIA+2)}</li>
      `;

      document.getElementById('calBtn').href = `${CONFIG.CAL_BASE}/${DIA}`;

      // 3. DYNAMIC CONTENT (Processing your new "blocks" array)
      const container = document.getElementById('dynamicBlocks');
      container.innerHTML = "";

      const todayPlan = (data.plan.days || []).find(p => p.dia == DIA);

      if (todayPlan && todayPlan.blocks) {
        todayPlan.blocks.forEach(block => {
          if (block.kind === "vocabulario") {
            const ch = data.vocab.descubre2.chapters[block.ref];
            if (ch) {
              container.innerHTML += `
                <section class="bg-white rounded-xl border-l-[6px] border-amber-500 p-6 card-shadow">
                  <h2 class="text-amber-600 font-bold text-xl mb-3 flex items-center gap-2"><span>üìö</span> Vocabulario: ${ch.label}</h2>
                  <div class="grid grid-cols-2 gap-4">
                    <a href="${ch.listas}" target="_blank" class="text-center p-3 bg-amber-50 text-amber-700 rounded-lg font-bold border border-amber-100 hover:bg-amber-100 transition-colors uppercase">Lista</a>
                    <a href="${ch.flashcards}" target="_blank" class="text-center p-3 bg-amber-50 text-amber-700 rounded-lg font-bold border border-amber-100 hover:bg-amber-100 transition-colors uppercase">Flashcards</a>
                  </div>
                </section>`;
            }
          } 
          else if (block.kind === "estructura") {
            const topic = data.apuntes[block.ref];
            if (topic) {
              container.innerHTML += `
                <section class="bg-white rounded-xl border-l-[6px] border-blue-600 p-6 card-shadow">
                  <h2 class="text-blue-600 font-bold text-xl mb-3 flex items-center gap-2"><span>‚öôÔ∏è</span> Gram√°tica: ${topic.title}</h2>
                  <div class="flex flex-wrap gap-2">
                    ${topic.introducir.map(id => `<a href="${topic.children[id].url}" target="_blank" class="px-3 py-1 bg-blue-50 text-blue-700 rounded-lg border border-blue-100 text-sm font-bold hover:bg-blue-100 transition-colors uppercase">${topic.children[id].title} ‚Üó</a>`).join('')}
                  </div>
                </section>`;
            }
          }
        });
      }

      // 4. CURIOSIDAD (Your original logic)
      const curiosity = data.curios.find(c => c.id === `cur-${DIA}`);
      if (curiosity) {
        container.innerHTML += `
          <article class="bg-white rounded-xl border-l-[6px] border-indigo-400 p-6 card-shadow space-y-4">
            <h3 class="text-indigo-600 font-bold text-xs uppercase tracking-widest">Sab√≠as que...</h3>
            <h2 class="text-2xl font-extrabold text-slate-900">${curiosity.title}</h2>
            ${curiosity.img ? `<div class="rounded-xl overflow-hidden border border-slate-100 shadow-sm"><img src="${curiosity.img}" class="w-full h-auto"></div>` : ''}
            ${curiosity.student_note ? `<p class="text-slate-700 italic text-sm">${curiosity.student_note}</p>` : ''}
          </article>`;
      }

      // 5. TAREAS LOGIC (Your original logic)
      const tareasList = document.getElementById('tareasList');
      tareasList.innerHTML = "";
      const activeTareas = data.tareas.tareas.filter(t => t.day_assigned <= DIA && t.day_due >= DIA);
      activeTareas.forEach(t => {
          const isNuevo = (t.day_assigned == DIA);
          const isPronto = (t.day_due == DIA || t.day_due == DIA + 1);
          tareasList.innerHTML += `
            <div class="bg-white rounded-lg p-3 shadow-sm border border-blue-200">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-[10px] font-bold px-2 py-0.5 rounded uppercase bg-blue-100 text-blue-600">${t.tipo}</span>
                ${isNuevo ? '<span class="bg-emerald-500 text-white text-[10px] font-black px-2 py-0.5 rounded-full uppercase">Nuevo</span>' : ''}
                ${isPronto ? '<span class="bg-red-500 text-white text-[10px] font-black px-2 py-0.5 rounded-full uppercase animate-pronto">¬°Pronto!</span>' : ''}
              </div>
              <h4 class="font-bold text-slate-900 leading-tight">${t.titulo}</h4>
            </div>`;
      });
    }
    init();
</script>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Espa√±ol 2 - Plan de Clase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .card-shadow { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
    .animate-pronto { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .7; } }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen pb-20">
<main class="max-w-6xl mx-auto px-4 py-8 space-y-6">

  <header class="bg-[#79c9f2] rounded-xl p-6 text-white flex justify-between items-center shadow-md">
    <div>
      <h1 id="dayTitle" class="text-4xl font-extrabold tracking-tight uppercase text-white">D√≠a ‚Äî</h1>
      <p id="headerDate" class="text-lg italic opacity-90 font-medium"></p>
    </div>
    <div class="text-right hidden sm:block">
      <span class="text-xs font-bold uppercase tracking-widest bg-white/20 px-3 py-1 rounded-full">Espa√±ol 2</span>
    </div>
  </header>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
    <div class="lg:col-span-2 space-y-6">
      <section class="bg-white rounded-xl border-l-[6px] border-emerald-500 p-6 card-shadow">
        <h2 class="text-emerald-600 font-bold text-xl mb-3 flex items-center gap-2"><span>üèÜ</span> Evaluaci√≥n</h2>
        <div id="currentEval" class="text-lg text-slate-800 font-medium italic mb-4"></div>
        <div class="pt-4 border-t border-slate-100">
          <h3 class="text-slate-900 font-bold text-sm mb-2 uppercase tracking-wide">Pr√≥ximas pruebas</h3>
          <ul id="nextEvals" class="space-y-1 text-sm text-slate-600"></ul>
        </div>
      </section>

      <section class="bg-white rounded-xl border-l-[6px] border-red-500 p-6 card-shadow">
        <div class="flex justify-between items-start mb-3">
          <h2 class="text-red-600 font-bold text-xl">Calentamiento</h2>
          <a id="calBtn" href="#" target="_blank" class="bg-red-50 text-red-600 text-[10px] font-bold px-3 py-1.5 rounded-lg border border-red-100 hover:bg-red-100 transition-colors uppercase">Pantalla Completa ‚Üó</a>
        </div>
        <div id="calDetail" class="text-slate-700 text-md">Pr√°ctica interactiva para empezar la clase.</div>
      </section>

      <div id="curiosityBlock"></div>
      <div id="estructuraBlock"></div>
      <div id="extrasBlock"></div> 
    </div>

    <div id="tareasColumn" class="space-y-6">
      <div class="bg-blue-50 rounded-xl p-6 shadow-sm border border-blue-100">
        <h3 class="text-blue-700 font-bold text-lg mb-4 flex items-center gap-2">
          <span>üìù</span> Tareas Pendientes
        </h3>
        <div id="tareasList" class="space-y-4"></div>
      </div>
    </div>
  </div>

  <div id="resourceDashboard" class="mt-12 pt-8 border-t-2 border-dashed border-slate-200">
    <h2 class="text-slate-400 font-black text-2xl uppercase tracking-widest mb-6 text-center lg:text-left">Recursos del D√≠a</h2>
    <div id="dynamicResources" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </div>

  <div class="mt-20 pt-8 border-t border-slate-200 opacity-20 hover:opacity-100 transition-opacity flex justify-center">
    <div class="flex items-center gap-4 text-xs">
      <input id="diaInput" type="number" class="w-16 border rounded px-2 py-1" value="35">
      <button onclick="renderManual()" class="bg-slate-800 text-white px-3 py-1 rounded hover:bg-black">Cargar</button>
    </div>
  </div>
</main>

<script>
    const CONFIG = {
      COURSE: "s2",
      CICLO_FILTER: "B",
      PLAN: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/plan_s2.json",
      EVALS: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/evaluaciones.json",
      CALENDARIO: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/calendario.json",
      CURIOSIDADES: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/curiosidades.json",
      TAREAS: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/tareas.json",
      VOCAB_BANK: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/vocabulario.json",
      APUNTES_BANK: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/apuntes.json",
      EXTRAS: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/extras.json",
      CAL_BASE: "https://sites.google.com/view/srscalici/espa%C3%B1ol-2/planes/calentamiento"
    };

    function formatSpanishDate(dateStr) {
      if (!dateStr) return "";
      const date = new Date(dateStr + "T00:00:00");
      return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
    }

    async function loadData() {
      const urls = [
        CONFIG.PLAN, CONFIG.EVALS, CONFIG.CALENDARIO, 
        CONFIG.CURIOSIDADES, CONFIG.TAREAS, CONFIG.VOCAB_BANK, 
        CONFIG.APUNTES_BANK, CONFIG.EXTRAS
      ];
      try {
        const responses = await Promise.all(urls.map(url => fetch(url + "?t=" + Date.now()).then(r => r.json())));
        return { 
          plan: responses[0], evals: responses[1], cal: responses[2], curios: responses[3], 
          tareas: responses[4], vocab: responses[5], apuntes: responses[6], extras: responses[7] 
        };
      } catch (e) { console.error("Error loading JSON data:", e); }
    }

    function renderManual() {
      const d = document.getElementById('diaInput').value;
      window.history.pushState({}, '', `?dia=${d}`);
      init();
    }

    async function init() {
      const data = await loadData();
      if (!data) return;

      const params = new URLSearchParams(window.location.search);
      let DIA = parseInt(params.get('dia')) || 35; 
      const todayPlan = (data.plan.days || []).find(p => p.dia == DIA);

      // 1. HEADER & CALENDAR
      const calendarEntry = data.cal?.map?.find(c => c.dia == DIA && c.ciclo === CONFIG.CICLO_FILTER);
      document.getElementById('dayTitle').textContent = `D√≠a ${DIA}`;
      document.getElementById('headerDate').textContent = calendarEntry ? formatSpanishDate(calendarEntry.fecha) : "Fecha TBD";

      // 2. EVALS
      const evalList = data.evals.courses[CONFIG.COURSE] || [];
      const findEval = (d) => (evalList.find(e => e.dia == d)?.label || "Sin evaluaciones");
      document.getElementById('currentEval').textContent = findEval(DIA);
      document.getElementById('nextEvals').innerHTML = `<li><b>D√≠a ${DIA+1}:</b> ${findEval(DIA+1)}</li><li><b>D√≠a ${DIA+2}:</b> ${findEval(DIA+2)}</li>`;
      document.getElementById('calBtn').href = `${CONFIG.CAL_BASE}/${DIA}`;

      // 3. CURIOSIDAD
      const curBlock = document.getElementById('curiosityBlock');
      const cur = data.curios.find(c => c.id === `cur-${DIA}`);
      curBlock.innerHTML = cur ? `<article class="bg-white rounded-xl border-l-[6px] border-indigo-400 p-6 card-shadow space-y-4"><h3 class="text-indigo-600 font-bold text-xs uppercase tracking-widest">Curiosidad ${DIA}</h3><h2 class="text-2xl font-extrabold text-slate-900 leading-tight">${cur.title}</h2>${cur.img ? `<div class="w-full aspect-video bg-slate-100 rounded-lg border border-slate-100 flex items-center justify-center overflow-hidden"><img src="${cur.img}" class="max-w-full max-h-full object-contain block"></div>` : ''}<p class="text-slate-700 italic text-sm">${cur.student_note || ""}</p></article>` : "";

      // 4. ESTRUCTURA (Handles multiple blocks)
      const estContainer = document.getElementById('estructuraBlock');
      estContainer.innerHTML = "";
      const grammarBlocks = todayPlan?.blocks?.filter(b => b.kind === "estructura") || [];

      grammarBlocks.forEach(blockRef => {
        const topic = data.apuntes[blockRef.ref];
        if (!topic) return;
        let linksHtml = "";
        
        const processLinks = (ids, label) => {
          ids?.forEach(id => {
            const link = topic.links[id];
            if (!link || (link.courses && !link.courses.includes(CONFIG.COURSE))) return;
            const isIntro = label === "Introducir";
            linksHtml += `<a href="${link.url}" target="_blank" class="group flex items-center justify-between p-4 bg-slate-50 border border-slate-200 rounded-xl hover:bg-white hover:border-blue-400 hover:shadow-md transition-all mb-2"><div class="flex flex-col"><span class="text-[9px] font-black px-2 py-0.5 rounded uppercase tracking-wider w-fit mb-1 ${isIntro ? 'bg-emerald-100 text-emerald-700' : 'bg-blue-100 text-blue-700'}">${label}</span><h3 class="text-slate-800 font-bold text-md">${link.title}</h3></div><div class="text-slate-300 group-hover:text-blue-500 group-hover:translate-x-1 transition-all">‚Üó</div></a>`;
          });
        };

        processLinks(blockRef.introducir, "Introducir");
        processLinks(blockRef.repasar, "Repasar");

        estContainer.innerHTML += `<section class="bg-white rounded-2xl border-l-[6px] border-blue-600 card-shadow p-6 mb-6"><div class="flex items-center gap-3 mb-4"><div class="bg-blue-600 text-white p-1.5 rounded-lg text-lg">‚öôÔ∏è</div><h2 class="text-xl font-black text-slate-900">${blockRef.title || topic.title}</h2></div><div>${linksHtml}</div></section>`;
      });

      // 5. EXTRAS
      const extrasBlock = document.getElementById('extrasBlock');
      extrasBlock.innerHTML = "";
      const extraRef = todayPlan?.blocks?.find(b => b.kind === "extras")?.ref;
      const extraItem = data.extras.items.find(i => i.id === extraRef);
      if (extraItem) {
        let content = extraItem.kind === "sentences" ? `<ul class="space-y-2">${extraItem.sentences.map(s => `<li class="text-lg text-slate-700 border-l-4 border-indigo-200 pl-4 italic">"${s}"</li>`).join('')}</ul>` : `<div class="flex flex-wrap gap-3">${extraItem.links.map(l => `<a href="${l.url}" target="_blank" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold text-sm hover:bg-indigo-700">${l.label} ‚Üó</a>`).join('')}</div>`;
        extrasBlock.innerHTML = `<section class="bg-indigo-50/50 rounded-xl border-l-[6px] border-indigo-500 p-6 card-shadow"><h2 class="text-indigo-700 font-bold text-xl mb-4 flex items-center gap-2"><span>‚ú®</span> ${extraItem.title}</h2><div class="bg-white rounded-xl p-6 border border-indigo-100 shadow-sm">${extraItem.instructions ? `<p class="text-xs font-black text-indigo-400 uppercase tracking-widest mb-4">${extraItem.instructions}</p>` : ''}${content}</div></section>`;
      }

      // 6. TAREAS (The section that was missing)
      const tareasList = document.getElementById('tareasList');
      tareasList.innerHTML = "";
      const taskRefs = todayPlan?.blocks?.filter(b => b.kind === "tarea").map(b => b.ref) || [];

      if (taskRefs.length > 0) {
        taskRefs.forEach(ref => {
          const t = data.tareas[ref];
          if (!t) return;
          const isUrgent = t.status === "para hoy";
          tareasList.innerHTML += `<div class="bg-white border border-blue-100 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow group"><div class="flex justify-between items-start mb-2"><span class="text-[9px] font-black px-2 py-0.5 rounded-full uppercase tracking-widest text-white ${isUrgent ? 'bg-red-500' : 'bg-blue-600'}">${t.type || "Tarea"}</span>${isUrgent ? '<span class="text-[9px] font-bold text-red-500 animate-pronto uppercase">¬°Para Hoy!</span>' : ''}</div><h4 class="text-slate-900 font-bold text-sm mb-3 group-hover:text-blue-700">${t.title}</h4><a href="${t.url}" target="_blank" class="block w-full text-center py-2 bg-slate-800 text-white rounded-lg text-xs font-bold hover:bg-black">Abrir Tarea</a></div>`;
        });
      } else {
        tareasList.innerHTML = "<p class='text-blue-400 italic text-sm text-center py-4'>No hay tareas pendientes.</p>";
      }

      // 7. RESOURCE DASHBOARD (Bottom)
      const resourceGrid = document.getElementById('dynamicResources');
      resourceGrid.innerHTML = "";
      todayPlan?.blocks?.forEach(block => {
        if (block.kind === "vocabulario") {
          const ch = data.vocab.descubre2.chapters[block.ref];
          if (ch) resourceGrid.innerHTML += `<div class="bg-white rounded-xl border-l-[6px] border-amber-500 p-5 shadow-sm border border-slate-100"><h3 class="text-amber-600 font-bold mb-3 flex items-center gap-2"><span>üìö</span> Vocabulario: ${ch.label}</h3><div class="flex gap-2"><a href="${ch.listas}" target="_blank" class="flex-1 text-center py-2 bg-amber-50 text-amber-700 rounded-lg text-xs font-bold border border-amber-100">Lista</a><a href="${ch.flashcards}" target="_blank" class="flex-1 text-center py-2 bg-amber-50 text-amber-700 rounded-lg text-xs font-bold border border-amber-100">Cards</a></div></div>`;
        }
      });
    } // END of init()

    // Kick off the script
    init();
</script>
</body>
</html>

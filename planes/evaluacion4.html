<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calendario de Evaluaciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen pb-20">
<main class="max-w-3xl mx-auto px-4 py-12 space-y-6">

    <header class="bg-emerald-600 rounded-2xl p-8 text-white shadow-lg border-b-8 border-emerald-700">
        <h1 class="text-4xl font-black tracking-tight uppercase">Evaluaciones</h1>
        <p id="courseTitle" class="text-lg italic opacity-90 font-medium uppercase tracking-wide">IB Español B II</p>
    </header>

    <div class="flex gap-4 px-2">
        <span class="text-[10px] font-black uppercase text-slate-400 tracking-widest flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-emerald-500"></span> Actuales
        </span>
        <span class="text-[10px] font-black uppercase text-slate-400 tracking-widest flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-slate-300"></span> Archivo
        </span>
    </div>

    <div id="evalContainer" class="space-y-4"></div>

</main>

<script>
  const CONFIG = {
    COURSE: "s4",
    EVALS_URL: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/evaluaciones.json",
    CAL_URL: "https://raw.githubusercontent.com/scottscalici/imagenes/main/planes/calendario.json"
  };

  function getTodayStr() {
    const d = new Date();
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
  }

  function formatDate(dateStr) {
    if (!dateStr) return "";
    const date = new Date(dateStr + "T00:00:00");
    return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
  }

  async function init() {
    try {
      const [evalRes, calRes] = await Promise.all([
        fetch(CONFIG.EVALS_URL + "?t=" + Date.now()),
        fetch(CONFIG.CAL_URL + "?t=" + Date.now())
      ]);
      
      const evalData = await evalRes.json();
      const calData = await calRes.json();
      
      const rawEvals = evalData.courses[CONFIG.COURSE] || [];
      const calendarMap = calData.map || [];
      const todayStr = getTodayStr();

      const pastOrTodayEntries = calendarMap.filter(c => c.fecha <= todayStr);
      const MASTER_DAY = pastOrTodayEntries.length > 0 
        ? Math.max(...pastOrTodayEntries.map(e => e.dia)) 
        : 0;

      const container = document.getElementById('evalContainer');
      container.innerHTML = "";

      let futurePillCount = 0;

      // 1. Assign Priority Scores
      const processedEvals = rawEvals.map(ev => {
        const matchingDays = calendarMap.filter(c => c.dia == ev.dia);
        const dates = matchingDays.map(m => m.fecha).sort();
        const minDate = dates[0];
        const maxDate = dates[dates.length - 1];
        const isTodayWindow = (todayStr >= minDate && todayStr <= maxDate);
        
        let priority = 0;
        
        if (ev.dia === MASTER_DAY && !isTodayWindow) {
          priority = 115; // Highest: Recién (last class)
        } else if (ev.dia >= MASTER_DAY - 2 && ev.dia < MASTER_DAY) {
          priority = 110; // High: 2nd last class
        } else if (isTodayWindow) {
          priority = 100; // Middle: Today
        } else if (ev.dia > MASTER_DAY) {
          priority = 90;  // Lower: Future
        } else {
          priority = 10;  // Bottom: Old Archive
        }

        return { ...ev, priority, matchingDays, isTodayWindow };
      });

      // 2. Sort by Priority (Desc), then by Day (Asc)
      processedEvals.sort((a, b) => {
        if (b.priority !== a.priority) return b.priority - a.priority;
        return a.dia - b.dia;
      });

      // 3. Render
      processedEvals.forEach(ev => {
        const formattedDates = [...new Set(ev.matchingDays.map(d => formatDate(d.fecha)))];
        const fechaDisplay = formattedDates.length > 1 
          ? formattedDates.slice(0, -1).join(', ') + ' y ' + formattedDates.slice(-1) 
          : (formattedDates[0] || "Fecha TBD");

        let cardStyle = "bg-white border-slate-200 opacity-100";
        let dateColor = "text-emerald-600";
        let pill = "";

        if (ev.priority >= 110) {
          // RECIÉN / PASADA (Now at the top)
          cardStyle = "bg-white border-slate-400 border-l-[8px]";
          pill = `<span class="bg-slate-100 text-slate-600 text-[10px] font-black px-2 py-1 rounded uppercase">${ev.priority === 115 ? 'Reciente' : 'Pasada'}</span>`;
        } 
        else if (ev.priority === 100) {
          // HOY
          cardStyle = "bg-white border-emerald-500 border-l-[8px] shadow-md ring-2 ring-emerald-50";
          pill = '<span class="bg-red-600 text-white text-[10px] font-black px-2 py-1 rounded animate-pulse uppercase">¡Hoy!</span>';
        } 
        else if (ev.priority === 90) {
          // FUTURE
          futurePillCount++;
          if (futurePillCount === 1) {
            cardStyle = "bg-white border-emerald-600 border-l-[8px] shadow-sm";
            pill = '<span class="bg-emerald-600 text-white text-[10px] font-black px-2 py-1 rounded uppercase">Próximo</span>';
          } else if (futurePillCount === 2) {
            cardStyle = "bg-white border-emerald-300 border-l-[8px]";
            pill = '<span class="bg-emerald-50 text-emerald-700 text-[10px] font-bold px-2 py-1 rounded uppercase border border-emerald-100">Pronto</span>';
          }
        } 
        else {
          // OLD ARCHIVE
          cardStyle = "bg-slate-50 border-slate-200 opacity-60 scale-[0.98]";
          dateColor = "text-slate-400";
        }

        container.innerHTML += `
          <div class="rounded-xl border p-6 flex flex-col justify-between transition-all ${cardStyle}">
            <div class="flex items-center gap-3 mb-2">
                <span class="text-[10px] font-black uppercase tracking-tighter bg-slate-100 text-slate-500 px-2 py-0.5 rounded">Día ${ev.dia}</span>
                ${pill}
            </div>
            <h3 class="text-2xl font-extrabold text-slate-900 leading-tight mb-1">${ev.label}</h3>
            <p class="${dateColor} text-sm font-bold uppercase tracking-tight italic">
              ${fechaDisplay}
            </p>
          </div>
        `;
      });
    } catch (e) {
      console.error("Error", e);
    }
  }

  init();
</script>
</body>
</html>

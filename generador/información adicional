<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generador: Información adicional</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .info-section h4 { margin-top: .25rem; margin-bottom: .25rem; }
    .info-section ul { margin-top: .1rem; margin-bottom: .5rem; }
.icon-cal { width: 1em; height: 1em; vertical-align: -0.15em; display: inline-block; }

</style>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto space-y-6">

    <!-- Generator Form -->
    <section class="bg-white shadow rounded-xl p-6 space-y-4">
      <h1 class="text-2xl font-bold text-gray-800">Generador: Información adicional</h1>

      <!-- Course Selector -->
      <div>
        <label class="block font-semibold mb-1">Selecciona el curso:</label>
        <select id="courseSelect" class="w-full border rounded-xl p-2 shadow-sm focus:ring-2 focus:ring-purple-400">
          <option value="II">Español II (sophomores)</option>
          <option value="IV" selected>Español IV (seniors)</option>
        </select>
      </div>

      <div>
        <label class="block font-semibold mb-1">Blurb del día:</label>
        <textarea id="blurbInput" class="w-full h-40 p-2 border rounded-xl shadow-sm focus:ring-2 focus:ring-purple-400"></textarea>
      </div>

      <div>
        <label class="block font-semibold mb-1">Selecciona gramática:</label>
        <div id="grammarOptions" class="grid grid-cols-2 gap-2 text-sm"></div>
      </div>

      <div>
        <label class="block font-semibold mb-1">Selecciona vocabulario:</label>
        <div id="vocabOptions" class="grid grid-cols-2 gap-2 text-sm"></div>
      </div>

      <div>
        <label class="block font-semibold mb-1">Opciones adicionales:</label>
        <label class="flex items-center space-x-2">
          <input type="checkbox" id="tripOption" checked>
          <span>Incluir viaje a Costa Rica</span>
        </label>
      </div>

      <button onclick="generateInfo()" class="mt-4 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-6 rounded-xl shadow-md">
        Generar sección
      </button>
    </section>

    <!-- Preview -->
    <section id="infoSection" class="hidden">
      <h2 class="text-xl font-semibold mb-2">Vista previa</h2>
      <div id="infoPreview"></div>
    </section>

    <!-- Code Output -->
    <section id="codeOutput" class="hidden">
      <h2 class="text-xl font-semibold mb-2">Código HTML:</h2>
      <textarea id="htmlCode" class="w-full h-64 p-4 border rounded-xl font-mono text-sm bg-gray-50"></textarea>
    </section>

  </div>

  <script>
    let jsonData = {};

    // --- Detect and gather vocab sets (vocabulario2, vocabulario3, etc.) ---
    function getVocabSets(data){
      const out = [];
      for (const k of Object.keys(data)) {
        const v = data[k];
        if (v && typeof v === 'object' && v.chapters && typeof v.chapters === 'object') {
          // treat as vocab set if key starts with "vocab" OR title mentions "Vocabulario"
          const looksLikeVocab =
            k.toLowerCase().startsWith('vocab') ||
            (typeof v.title === 'string' && /vocabulario/i.test(v.title));
          if (looksLikeVocab) {
            out.push({ key: k, title: v.title || k, chapters: v.chapters });
          }
        }
      }
      return out;
    }

    async function loadJSON() {
      const base = "https://raw.githubusercontent.com/scottscalici/imagenes/refs/heads/main/planes/apuntes.json";
      // cache-buster for testing
      const url = `${base}?v=${Date.now()}`;
      const res = await fetch(url);
      jsonData = await res.json();
      renderOptions();
    }

    function renderOptions() {
      // Build a set of keys that are vocab sets so we can exclude them from grammar
      const vocabSets = getVocabSets(jsonData);
      const vocabKeys = new Set(vocabSets.map(s => s.key));

      // --- Grammar options (exclude vocab sets) ---
      const grammarDiv = document.getElementById("grammarOptions");
      grammarDiv.innerHTML = "";
      Object.keys(jsonData).forEach(key => {
        if (!vocabKeys.has(key)) {
          const group = jsonData[key];
          if (!group || !group.title || !group.links) return;
          const label = document.createElement("label");
          label.className = "flex items-center space-x-2";
          label.innerHTML = `<input type="checkbox" value="${key}" class="grammar-check"> <span>${group.title}</span>`;
          grammarDiv.appendChild(label);
        }
      });

      // --- Vocab options (support multiple sets) ---
      const vocabDiv = document.getElementById("vocabOptions");
      vocabDiv.innerHTML = "";

      if (!vocabSets.length) {
        vocabDiv.innerHTML = `<p class="text-sm text-gray-600 col-span-2">No se encontraron conjuntos de vocabulario.</p>`;
      } else {
        vocabSets.forEach(set => {
          // Subheading per set
          const head = document.createElement("div");
          head.className = "col-span-2 mt-2 font-semibold text-gray-800";
          head.textContent = set.title;
          vocabDiv.appendChild(head);

          // Chapters
          Object.keys(set.chapters).forEach(ch => {
            const label = document.createElement("label");
            label.className = "flex items-center space-x-2";
            // value encodes setKey and chapter
            label.innerHTML = `<input type="checkbox" value="${set.key}||${ch}" class="vocab-check">
                               <span>${ch}</span>`;
            vocabDiv.appendChild(label);
          });
        });
      }
    }

    /* ---------------------------
       Parsing helpers (your originals with upgrades)
    --------------------------- */
    function normLines(blurb) {
      return blurb
        .replace(/<br\s*\/?>/gi, "\n")
        .replace(/\r/g, "\n")
        // normalize unicode spaces & punctuation
        .replace(/\u00A0/g, " ")        // NBSP -> space
        .replace(/\u2007|\u202F/g, " ") // figure space, narrow NBSP
        .replace(/\uFF1A/g, ":")        // full-width colon -> :
        .replace(/[–—]/g, "-")          // en/em dashes -> hyphen
        // collapse any run of whitespace to a single space/newline friendly
        .split("\n")
        .map(s => s.replace(/\s+/g, " ").trim());
    }

    function sliceBetween(lines, startPat, stopPats = []) {
      const startIdx = lines.findIndex(l => startPat.test(l));
      if (startIdx === -1) return [];
      let endIdx = lines.length;
      for (const pat of stopPats) {
        const i = lines.findIndex((l, idx) => idx > startIdx && pat.test(l));
        if (i !== -1) endIdx = Math.min(endIdx, i);
      }
      return lines.slice(startIdx + 1, endIdx);
    }

    // Evaluaciones (up to 2 upcoming, skip today's first item)
    function extractQuizzes(blurb) {
      const lines = normLines(blurb);

      const infoStart = lines.findIndex(l => /información adicional\b/i.test(l));
      if (infoStart === -1) return [];

      let infoEnd = lines.length;
      for (let i = infoStart + 1; i < lines.length; i++) {
        if (/^(ayuda con la vida|viaje)\b/i.test(lines[i])) { infoEnd = i; break; }
      }
      const infoBlock = lines.slice(infoStart + 1, infoEnd);

      const evalIdx = infoBlock.findIndex(l => /^evaluaciones\b/i.test(l));
      if (evalIdx === -1) return [];

      const list = [];
      for (let i = evalIdx + 1; i < infoBlock.length; i++) {
        const line = infoBlock[i];
        if (!line) break; // stop at blank
        if (/^tareas?\b/i.test(line)) break;
        if (/^(ayuda con la vida|viaje)\b/i.test(line)) break;
        list.push(line);
      }
      if (!list.length) return [];

      // Skip ONLY first item, then take next two valid
      const upcoming = list.slice(1);
      const valid = upcoming.filter(l =>
        /[:\-]/.test(l) || /^nada(?:\b|[\s:-])/i.test(l)
      );
      return valid.slice(0, 2);
    }

    // Tareas (up to 5)
function extractTareas(blurb) {
  const lines = normLines(blurb);

  const tareaStartIdx = lines.findIndex(l => /^tareas?\s*:/i.test(l));
  if (tareaStartIdx === -1) return [];

  const collected = [];
  const first = lines[tareaStartIdx].replace(/^tareas?\s*:/i, "").trim();
  if (first) collected.push(first);

  for (let i = tareaStartIdx + 1; i < lines.length; i++) {
    const line = lines[i];
    if (!line) continue;
    if (/^(conversación|información adicional|práctica|cultura|estructura)\b/i.test(line)) break;
    collected.push(line);
  }

  const blob = collected.join(" ").replace(/\s+/g, " ").trim();
  if (!blob) return [];

  const dateSlash = String.raw`\d{1,2}[\/.-]\d{1,2}(?:[\/.-]\d{2,4})?`;
  const dateDeMes = String.raw`\d{1,2}\s+de\s+[a-záéíóúñü]+`;
  const dateWords = String.raw`hoy|mañana|próxima clase|la próxima clase`;
  const DATE = `${dateSlash}|${dateDeMes}|${dateWords}`;

  const pairRe = new RegExp(
    String.raw`([^:]+?)\s*(?::\s*(${DATE})|-\s*(${DATE}))`,
    "gi"
  );

  const tareas = [];
  let m;
  while ((m = pairRe.exec(blob)) !== null) {
    const tema = m[1]
      .replace(/[-:]\s*$/,"")
      .replace(/^[\s.\-–—•·]+/, "")
      .replace(/\s+/g, " ")
      .trim();

    const fecha = (m[2] || m[3] || "").trim(); // <-- RESTORED

    if (tema) tareas.push({ tema, fecha });
    if (tareas.length >= 5) break;
  }

  if (!tareas.length) {
    const mini = new RegExp(`([^:]+?)\\s*:\\s*(${DATE})`, "gi");
    let mm;
    while ((mm = mini.exec(blob)) !== null) {
      const tema = mm[1].trim();
      const fecha = mm[2].trim();
      if (tema) tareas.push({ tema, fecha });
      if (tareas.length >= 5) break;
    }
  }

  return tareas.slice(0, 5);
}
const calSVG = `
<svg xmlns="http://www.w3.org/2000/svg"
     width="14" height="14"
     viewBox="0 0 24 24"
     style="vertical-align:-0.2em;display:inline-block"
     fill="currentColor" aria-hidden="true" role="img">
  <path d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1a2 2 0 0 1 2 2v3H2V6a2 2 0 0 1 2-2h1V3a1 1 0 1 1 2 0v1z"></path>
  <path d="M2 10h20v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8zm5 3h3v3H7v-3z"></path>
</svg>`.trim();


    function generateInfo() {
      const blurb = document.getElementById("blurbInput").value.trim();
      const course = document.getElementById("courseSelect").value;

      const quizzes = extractQuizzes(blurb);
      const tareas  = extractTareas(blurb);

      const evalLink = course === "IV"
        ? "https://sites.google.com/view/srscalici/ib-espa%C3%B1ol-ii/evaluaciones"
        : "https://sites.google.com/view/srscalici/espa%C3%B1ol-2/evaluaciones";

      const quizzesHtml = `
        <h4 class="font-semibold">
          <a href="${evalLink}" target="_blank" class="text-purple-700 hover:underline">Evaluaciones</a>
        </h4>
        <ul class="list-disc list-inside">
          ${ (quizzes.length ? quizzes : ["—"]).map(q => `<li>${q}</li>`).join("") }
        </ul>
      `;

    let tareasHtml = "";
if (tareas.length) {
  tareasHtml = `
    <h4 class="font-semibold">Tareas (Dominio)</h4>
    <ul class="list-disc list-inside text-red-700">
      ${tareas.map(t => {
        const fecha = t.fecha
          ? ` <span class="ml-1 text-red-800">${calSVG} ${t.fecha}</span>`
          : "";
        return `<li><span class="font-semibold">${t.tema}</span>${fecha}</li>`;
      }).join("")}
    </ul>
  `;
}


      // Grammar links
      const selectedGrammar = Array.from(document.querySelectorAll(".grammar-check:checked")).map(cb => cb.value);
      let grammarHtml = "";
      selectedGrammar.forEach(key => {
        const group = jsonData[key];
        if (!group || !group.links) return;
        grammarHtml += `<h4 class="font-semibold">${group.title}</h4><ul class="list-disc list-inside text-purple-700">`;
        group.links.forEach(link => {
          grammarHtml += `<li><a href="${link.url}" target="_blank" class="hover:underline">${link.title}</a></li>`;
        });
        grammarHtml += `</ul>`;
      });

      // Vocab links (supports multiple sets like vocabulario2, vocabulario3)
      const selectedVocab = Array.from(document.querySelectorAll(".vocab-check:checked"))
  .map(cb => cb.value); // e.g., "vocabulario2||Lección 3"

let vocabHtml = "";
if (selectedVocab.length) {
  const items = [];
  const seen = new Set(); // avoid accidental duplicates

  selectedVocab.forEach(val => {
    const [setKey, chapter] = val.split("||");
    const set = jsonData[setKey];
    const data = set?.chapters?.[chapter];
    if (!data) return;

    const links = [];
    if (data.listas)     links.push(`<a href="${data.listas}" target="_blank" class="hover:underline">Listas</a>`);
    if (data.flashcards) links.push(`<a href="${data.flashcards}" target="_blank" class="hover:underline">Flashcards</a>`);

    const linkText = links.length ? links.join(", ") : `<span class="text-gray-500">Sin enlaces</span>`;
    const li = `<li>${chapter}: ${linkText}</li>`;
    if (!seen.has(li)) { seen.add(li); items.push(li); }
  });

  if (items.length) {
    vocabHtml = `
      <h4 class="font-semibold">Vocabulario</h4>
      <ul class="list-disc list-inside text-purple-700">
        ${items.join("")}
      </ul>
    `;
  }
}
      // Trip (optional)
      let tripHtml = "";
      if (document.getElementById("tripOption").checked) {
        tripHtml = `
          <p>Viaje a <a href="https://senoraburak.weebly.com/costa-rica-2027.html" target="_blank" class="font-semibold text-purple-700 hover:underline">Costa Rica</a></p>
          <img src="https://raw.githubusercontent.com/scottscalici/imagenes/refs/heads/main/sloth_orig.jpg" alt="Costa Rica" class="mt-2 rounded-lg shadow-md w-64">
        `;
      }

      const htmlSnippet = `
<section class="bg-white shadow rounded-xl border-l-4 border-purple-500 p-4 space-y-1 info-section">
  <h2 class="text-purple-600 font-semibold text-lg">Información adicional</h2>
  ${quizzesHtml}
  ${tareasHtml}
  ${grammarHtml}
  ${vocabHtml}
  <p><span class="font-semibold">Ayuda con la vida</span> –
    <a href="https://connection.misd.net/index.html" target="_blank" class="text-purple-700 hover:underline">recursos de MISD</a>
  </p>
  ${tripHtml}
</section>
      `.trim();

      document.getElementById("infoPreview").innerHTML = htmlSnippet;
      document.getElementById("infoSection").classList.remove("hidden");
      document.getElementById("htmlCode").value = htmlSnippet;
      document.getElementById("codeOutput").classList.remove("hidden");
    }

    loadJSON();
  </script>
</body>
</html>

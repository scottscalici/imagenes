<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generador: Informaci√≥n adicional</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .info-section h4 { margin-top: .25rem; margin-bottom: .25rem; }
    .info-section ul { margin-top: .1rem; margin-bottom: .5rem; }
  </style>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto space-y-6">

    <!-- Generator Form -->
    <section class="bg-white shadow rounded-xl p-6 space-y-4">
      <h1 class="text-2xl font-bold text-gray-800">Generador: Informaci√≥n adicional</h1>

      <!-- Course Selector -->
      <div>
        <label class="block font-semibold mb-1">Selecciona el curso:</label>
        <select id="courseSelect" class="w-full border rounded-xl p-2 shadow-sm focus:ring-2 focus:ring-purple-400">
          <option value="II">Espa√±ol II (sophomores)</option>
          <option value="IV" selected>Espa√±ol IV (seniors)</option>
        </select>
      </div>

      <div>
        <label class="block font-semibold mb-1">Blurb del d√≠a:</label>
        <textarea id="blurbInput" class="w-full h-40 p-2 border rounded-xl shadow-sm focus:ring-2 focus:ring-purple-400"></textarea>
      </div>

      <div>
        <label class="block font-semibold mb-1">Selecciona gram√°tica:</label>
        <div id="grammarOptions" class="grid grid-cols-2 gap-2 text-sm"></div>
      </div>

      <div>
        <label class="block font-semibold mb-1">Selecciona vocabulario:</label>
        <div id="vocabOptions" class="grid grid-cols-2 gap-2 text-sm"></div>
      </div>

      <div>
        <label class="block font-semibold mb-1">Opciones adicionales:</label>
        <label class="flex items-center space-x-2">
          <input type="checkbox" id="tripOption" checked>
          <span>Incluir viaje a Costa Rica</span>
        </label>
      </div>

      <button onclick="generateInfo()" class="mt-4 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-6 rounded-xl shadow-md">
        Generar secci√≥n
      </button>
    </section>

    <!-- Preview -->
    <section id="infoSection" class="hidden">
      <h2 class="text-xl font-semibold mb-2">Vista previa</h2>
      <div id="infoPreview"></div>
    </section>

    <!-- Code Output -->
    <section id="codeOutput" class="hidden">
      <h2 class="text-xl font-semibold mb-2">C√≥digo HTML:</h2>
      <textarea id="htmlCode" class="w-full h-64 p-4 border rounded-xl font-mono text-sm bg-gray-50"></textarea>
    </section>

  </div>

  <script>
    let jsonData = {};

    async function loadJSON() {
      const url = "https://raw.githubusercontent.com/scottscalici/imagenes/refs/heads/main/planes/apuntes.json";
      const res = await fetch(url);
      jsonData = await res.json();
      renderOptions();
    }

    function renderOptions() {
      const grammarDiv = document.getElementById("grammarOptions");
      grammarDiv.innerHTML = "";
      Object.keys(jsonData).forEach(key => {
        if (key !== "vocabulario") {
          const label = document.createElement("label");
          label.className = "flex items-center space-x-2";
          label.innerHTML = `<input type="checkbox" value="${key}" class="grammar-check"> <span>${jsonData[key].title}</span>`;
          grammarDiv.appendChild(label);
        }
      });

      const vocabDiv = document.getElementById("vocabOptions");
      vocabDiv.innerHTML = "";
      Object.keys(jsonData.vocabulario.chapters).forEach(ch => {
        const label = document.createElement("label");
          label.className = "flex items-center space-x-2";
          label.innerHTML = `<input type="checkbox" value="${ch}" class="vocab-check"> <span>${ch}</span>`;
          vocabDiv.appendChild(label);
      });
    }

    /* ---------------------------
       Parsing helpers
    --------------------------- */
    function normLines(blurb) {
      return blurb
        .replace(/<br\s*\/?>/gi, "\n")
        .replace(/\r/g, "")
        .replace(/[‚Äì‚Äî]/g, "-")
        .split("\n")
        .map(s => s.trim());
    }

    function sliceBetween(lines, startPat, stopPats = []) {
      const startIdx = lines.findIndex(l => startPat.test(l));
      if (startIdx === -1) return [];
      let endIdx = lines.length;
      for (const pat of stopPats) {
        const i = lines.findIndex((l, idx) => idx > startIdx && pat.test(l));
        if (i !== -1) endIdx = Math.min(endIdx, i);
      }
      return lines.slice(startIdx + 1, endIdx);
    }

    /* ---------------------------
       Evaluaciones (next two)
       - skip ONLY the first item (today's quiz)
       - keep upcoming "Nada ..." if it appears
    --------------------------- */
    function extractQuizzes(blurb) {
      const lines = normLines(blurb);

      const infoStart = lines.findIndex(l => /informaci√≥n adicional\b/i.test(l));
      if (infoStart === -1) return [];

      let infoEnd = lines.length;
      for (let i = infoStart + 1; i < lines.length; i++) {
        if (/^(ayuda con la vida|viaje)\b/i.test(lines[i])) { infoEnd = i; break; }
      }
      const infoBlock = lines.slice(infoStart + 1, infoEnd);

      const evalIdx = infoBlock.findIndex(l => /^evaluaciones\b/i.test(l));
      if (evalIdx === -1) return [];

      const list = [];
      for (let i = evalIdx + 1; i < infoBlock.length; i++) {
        const line = infoBlock[i];
        if (!line) break; // stop at blank
        if (/^tareas?\b/i.test(line)) break;
        if (/^(ayuda con la vida|viaje)\b/i.test(line)) break;
        list.push(line);
      }
      if (!list.length) return [];

      // Skip ONLY first item, then take next two valid
      const upcoming = list.slice(1);
      const valid = upcoming.filter(l =>
        /[:\-]/.test(l) || /^nada(?:\b|[\s:-])/i.test(l)
      );
      return valid.slice(0, 2);
    }

    /* ---------------------------
       Tareas (up to 5)
       - Handles "Tema: fecha Tema: fecha ..." on one line
       - Accepts ":" or "-" separators
       - Dates: 11/30, 30-11-2025, 30 de noviembre, hoy/ma√±ana/pr√≥xima clase
    --------------------------- */
    function extractTareas(blurb) {
      const lines = normLines(blurb);

      // Find "Tarea:" (or "Tareas:")
      const tareaStartIdx = lines.findIndex(l => /^tareas?\s*:/i.test(l));
      if (tareaStartIdx === -1) return [];

      // Collect text from "Tarea:" until next major header
      const collected = [];
      const firstLineAfterColon = lines[tareaStartIdx].replace(/^tareas?\s*:/i, "").trim();
      if (firstLineAfterColon) collected.push(firstLineAfterColon);

      for (let i = tareaStartIdx + 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line) continue;
        if (/^(conversaci√≥n|informaci√≥n adicional|pr√°ctica|cultura|estructura)\b/i.test(line)) break;
        collected.push(line);
      }

      // Join into one blob to extract many pairs even if all on one line
      const blob = collected.join(" ").replace(/\s+/g, " ").trim();
      if (!blob) return [];

      const dateSlash  = String.raw`\d{1,2}[\/.-]\d{1,2}(?:[\/.-]\d{2,4})?`;
      const dateDeMes  = String.raw`\d{1,2}\s+de\s+[a-z√°√©√≠√≥√∫√±√º]+`;
      const dateWords  = String.raw`hoy|ma√±ana|pr√≥xima clase|la pr√≥xima clase`;

      // Global pair matcher: (Tema) :|‚Äì (Fecha)
      const pairRe = new RegExp(
        String.raw`([^:]+?)\s*[:\-]\s*(${dateSlash}|${dateDeMes}|${dateWords})`,
        "gi"
      );

      const tareas = [];
      let m;
      while ((m = pairRe.exec(blob)) !== null) {
        let tema  = m[1].trim().replace(/[-:]\s*$/,"").trim();
        let fecha = m[2].trim();
        if (tema) tareas.push({ tema, fecha });
        if (tareas.length >= 5) break;
      }

      // Fallback: if nothing matched, try line-by-line
      if (!tareas.length) {
        const dateAny = new RegExp(`(?:${dateSlash}|${dateDeMes}|${dateWords})`, "i");
        for (const raw of collected) {
          let tema = raw, fecha = "";
          const sepIdx = raw.search(/[:\-]/);
          if (sepIdx !== -1) {
            tema = raw.slice(0, sepIdx).trim();
            const rhs = raw.slice(sepIdx + 1).trim();
            const dm = rhs.match(dateAny);
            if (dm) fecha = dm[0].trim(); else if (rhs) fecha = rhs;
          } else {
            const dm = raw.match(dateAny);
            if (dm) { fecha = dm[0].trim(); tema = raw.replace(dm[0], "").trim().replace(/[:\-]$/, "").trim(); }
          }
          if (tema) tareas.push({ tema, fecha });
          if (tareas.length >= 5) break;
        }
      }

      return tareas.slice(0, 5);
    }

    function generateInfo() {
      const blurb = document.getElementById("blurbInput").value.trim();
      const course = document.getElementById("courseSelect").value;

      const quizzes = extractQuizzes(blurb);
      const tareas  = extractTareas(blurb);

      const evalLink = course === "IV"
        ? "https://sites.google.com/view/srscalici/ib-espa%C3%B1ol-ii/evaluaciones"
        : "https://sites.google.com/view/srscalici/espa%C3%B1ol-2/evaluaciones";

      const quizzesHtml = `
        <h4 class="font-semibold">
          <a href="${evalLink}" target="_blank" class="text-purple-700 hover:underline">Evaluaciones</a>
        </h4>
        <ul class="list-disc list-inside">
          ${ (quizzes.length ? quizzes : ["‚Äî"]).map(q => `<li>${q}</li>`).join("") }
        </ul>
      `;

      let tareasHtml = "";
      if (tareas.length) {
        tareasHtml = `
          <h4 class="font-semibold">Tareas (Dominio)</h4>
          <ul class="list-disc list-inside text-red-700">
            ${tareas.map(t => {
              const fecha = t.fecha ? ` üìÖ ${t.fecha}` : "";
              return `<li><span class="font-semibold">${t.tema}</span>${fecha}</li>`;
            }).join("")}
          </ul>
        `;
      }

      // Grammar links
      const selectedGrammar = Array.from(document.querySelectorAll(".grammar-check:checked")).map(cb => cb.value);
      let grammarHtml = "";
      selectedGrammar.forEach(key => {
        const group = jsonData[key];
        grammarHtml += `<h4 class="font-semibold">${group.title}</h4><ul class="list-disc list-inside text-purple-700">`;
        group.links.forEach(link => {
          grammarHtml += `<li><a href="${link.url}" target="_blank" class="hover:underline">${link.title}</a></li>`;
        });
        grammarHtml += `</ul>`;
      });

      // Vocab links
      const selectedVocab = Array.from(document.querySelectorAll(".vocab-check:checked")).map(cb => cb.value);
      let vocabHtml = "";
      if (selectedVocab.length) {
        vocabHtml += `<h4 class="font-semibold">Vocabulario</h4><ul class="list-disc list-inside text-purple-700">`;
        selectedVocab.forEach(ch => {
          const data = jsonData.vocabulario.chapters[ch];
          vocabHtml += `<li>${ch}: <a href="${data.listas}" target="_blank" class="hover:underline">Listas</a>, <a href="${data.flashcards}" target="_blank" class="hover:underline">Flashcards</a></li>`;
        });
        vocabHtml += `</ul>`;
      }

      // Trip (optional)
      let tripHtml = "";
      if (document.getElementById("tripOption").checked) {
        tripHtml = `
          <p>Viaje a <a href="https://senoraburak.weebly.com/costa-rica-2027.html" target="_blank" class="font-semibold text-purple-700 hover:underline">Costa Rica</a></p>
          <img src="https://raw.githubusercontent.com/scottscalici/imagenes/refs/heads/main/sloth_orig.jpg" alt="Costa Rica" class="mt-2 rounded-lg shadow-md w-64">
        `;
      }

      const htmlSnippet = `
<section class="bg-white shadow rounded-xl border-l-4 border-purple-500 p-4 space-y-1 info-section">
  <h2 class="text-purple-600 font-semibold text-lg">Informaci√≥n adicional</h2>
  ${quizzesHtml}
  ${tareasHtml}
  ${grammarHtml}
  ${vocabHtml}
  <p><span class="font-semibold">Ayuda con la vida</span> ‚Äì
    <a href="https://connection.misd.net/index.html" target="_blank" class="text-purple-700 hover:underline">recursos de MISD</a>
  </p>
  ${tripHtml}
</section>
      `.trim();

      document.getElementById("infoPreview").innerHTML = htmlSnippet;
      document.getElementById("infoSection").classList.remove("hidden");
      document.getElementById("htmlCode").value = htmlSnippet;
      document.getElementById("codeOutput").classList.remove("hidden");
    }

    loadJSON();
  </script>
</body>
</html>
